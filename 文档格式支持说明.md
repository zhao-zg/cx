# 文档格式支持说明

## 功能概述

系统现在支持 **`.doc`** 和 **`.docx`** 两种 Word 文档格式,并能自动检测和加载正确的文件。

## 支持的文档类型

以下三种文档都支持 `.doc` 和 `.docx` 格式:

1. **经文文档** (`scripture_doc`)
2. **听抄文档** (`listen_doc`)
3. **晨兴文档** (`morning_revival_doc`)

## 自动检测机制

### 工作原理

程序会按以下顺序查找文档:

1. **直接匹配**: 如果配置文件中指定的完整路径存在,直接使用
2. **扩展名检测**: 如果文件不存在,移除扩展名后依次尝试:
   - 首先尝试 `.docx` 格式
   - 如果不存在,尝试 `.doc` 格式
3. **返回结果**: 返回第一个找到的文件,如果都不存在则返回 `None`

### 示例场景

#### 场景 1: 配置中指定完整扩展名

```yaml
listen_doc: "resource/听抄.docx"
```

- 如果 `resource/听抄.docx` 存在 → 使用该文件 ✓
- 如果不存在 → 尝试 `resource/听抄.doc` ✓
- 如果都不存在 → 报错 ✗

#### 场景 2: 配置中不指定扩展名

```yaml
listen_doc: "resource/听抄"
```

- 自动尝试 `resource/听抄.docx` ✓
- 如果不存在,尝试 `resource/听抄.doc` ✓
- 如果都不存在 → 报错 ✗

#### 场景 3: 混合格式

```yaml
listen_doc: "resource/听抄.docx"      # 使用 .docx
scripture_doc: "resource/经文.doc"    # 使用 .doc
morning_revival_doc: "resource/晨兴"  # 自动检测
```

完全支持!系统会为每个文档独立检测格式。

## 配置文件示例

### config.yaml

```yaml
# 训练配置
title: "二〇二五年秋季国际长老及负责弟兄训练"
subtitle: "马太福音五至七章极重要的方面"
year: 2025
season: "秋季"

# 文档路径 (支持 .doc 和 .docx 两种格式,会自动检测)
listen_doc: "resource/听抄.docx"
scripture_doc: "resource/经文.docx"
morning_revival_doc: "resource/晨兴.doc"

# 输出目录
output_dir: "output"

# 模板目录
template_dir: "src/templates"
```

## 错误处理

### 文档不存在

如果某个必需的文档(.doc 和 .docx 都)不存在,程序会:

```
✗ 听抄文档不存在: resource/听抄.docx (.doc 或 .docx)
```

### 晨兴文档可选

晨兴文档是可选的,如果不存在会显示警告但不会中断:

```
⚠ 晨兴文档不存在，将跳过晨兴内容: resource/晨兴.doc
```

## 程序输出示例

### 成功加载混合格式

```
============================================================
 Word文档静态网站生成器
============================================================

✓ 配置文件加载成功
✓ 找到听抄文档: resource/听抄.docx
✓ 找到经文文档: resource/经文.docx
✓ 找到晨兴文档: resource/晨兴.doc

开始解析Word文档...
```

### 自动切换格式

如果你将 `resource/听抄.docx` 改为 `resource/听抄.doc`,程序会自动检测:

```
✓ 找到听抄文档: resource/听抄.doc
```

## 技术实现

### find_document() 函数

```python
def find_document(base_path):
    """
    查找文档文件,支持 .doc 和 .docx 两种格式
    
    Args:
        base_path: 配置文件中指定的路径(可能带或不带扩展名)
    
    Returns:
        实际存在的文件路径,如果都不存在则返回 None
    """
    # 如果指定的文件存在,直接返回
    if os.path.exists(base_path):
        return base_path
    
    # 移除可能的扩展名
    base_without_ext = os.path.splitext(base_path)[0]
    
    # 尝试 .docx 和 .doc
    for ext in ['.docx', '.doc']:
        full_path = base_without_ext + ext
        if os.path.exists(full_path):
            return full_path
    
    return None
```

### 使用方式

```python
# 在 main() 函数中
listen_doc = find_document(config['listen_doc'])
scripture_doc = find_document(config['scripture_doc'])
morning_revival_doc = find_document(config.get('morning_revival_doc', ''))
```

## 解析器兼容性

### parser_improved.py

解析器已支持两种格式:

- **`.docx`**: 使用 `python-docx` 库解析
- **`.doc`**: 使用 `win32com.client` (COM) 解析

### 格式检测

解析器会根据文件扩展名自动选择正确的解析方法:

```python
if doc_path.endswith('.docx'):
    # 使用 python-docx
    doc = Document(doc_path)
else:
    # 使用 win32com
    word = win32.gencache.EnsureDispatch('Word.Application')
    doc = word.Documents.Open(abs_path)
```

## 使用建议

### 1. 推荐使用 .docx 格式

- 解析速度更快
- 不需要安装 Microsoft Word
- 跨平台兼容性更好

### 2. 保留 .doc 支持

- 兼容老旧文档
- 某些文档可能只有 .doc 格式

### 3. 配置灵活性

可以混合使用两种格式:

```yaml
listen_doc: "resource/听抄.docx"      # 新文档用 docx
scripture_doc: "resource/经文.docx"    # 新文档用 docx
morning_revival_doc: "resource/晨兴.doc"  # 老文档保持 doc
```

### 4. 简化配置

也可以省略扩展名,让程序自动检测:

```yaml
listen_doc: "resource/听抄"
scripture_doc: "resource/经文"
morning_revival_doc: "resource/晨兴"
```

## 依赖包

确保安装了必要的 Python 包:

```bash
pip install python-docx  # 用于 .docx 解析
pip install pywin32      # 用于 .doc 解析 (仅 Windows)
```

## 测试检查清单

- [ ] `.docx` 格式的听抄文档能正常解析
- [ ] `.doc` 格式的听抄文档能正常解析
- [ ] `.docx` 格式的经文文档能正常解析
- [ ] `.doc` 格式的经文文档能正常解析
- [ ] `.docx` 格式的晨兴文档能正常解析
- [ ] `.doc` 格式的晨兴文档能正常解析
- [ ] 混合格式能正常工作
- [ ] 文档不存在时错误提示正确
- [ ] 省略扩展名时自动检测工作正常

---

**更新日期**: 2025年12月12日
**版本**: 1.1
**兼容性**: 向后兼容,无需修改现有配置
