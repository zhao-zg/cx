!function(){"use strict";function t(t){return document.getElementById(t)}function e(t){return(t||"").replace(/\s+/g," ").trim()}function n(t){var e=Math.max(0,Math.floor(t||0)),n=Math.floor(e/60);return String(n).padStart(2,"0")+":"+String(e%60).padStart(2,"0")}function o(t,e){var n=Math.max(.1,Number(e)||1);return Math.max(1,Math.ceil((t||"").length/(250*n)*60))}function i(t,e,n){return Math.max(e,Math.min(n,t))}function r(r){if("speechSynthesis"in window&&"SpeechSynthesisUtterance"in window){var a=r&&"function"==typeof r.getText?r.getText:null;if(a){var s=r&&r.lang||"zh-CN",c=t("bottomControlBar")||t("speechControls"),u=t("playPauseBtn"),l=t("rateSelect"),d=t("speechTime"),f=t("progressBar");if(u&&l&&d&&f&&c){var p=u.querySelector(".play-icon"),m=u.querySelector(".pause-icon"),g=localStorage.getItem("speechRate");g&&(l.value=g);var v,h,y="",S=null,b=!1,w=0,E=0,C=0,T=0,I=null,x=!1;function L(t){p&&m&&(p.style.display=t?"none":"inline",m.style.display=t?"inline":"none"),u.setAttribute("aria-label",t?"暂停":"播放")}function M(){I&&(clearInterval(I),I=null)}function k(){return w?C?i(E+(Date.now()-C)/1e3,0,w):i(E,0,w):0}function A(){if(w){var t=k(),e=i(t/w*100,0,100);f.value=String(e),d.textContent=n(t)+" / "+n(w)}else f.value=0,d.textContent="00:00 / 00:00"}function D(){M(),I=setInterval((function(){x||A()}),120)}function N(t){M(),S=null,b=!1,C=0,T=0,E=0,w=0,t||(y=""),L(!1),f.value="0",d.textContent="00:00 / 00:00"}function P(){try{window.speechSynthesis.cancel()}catch(t){}}function U(t){if(y){var r=i(Number(t)||0,0,100),a=Number(l.value)||.5,c=w?(r/100)*w:0,u=Math.floor(y.length*(r/100));u=i(u,0,Math.max(0,y.length-1));var p=e(y.slice(u));if(p){v=!0,P(),M(),(S=new SpeechSynthesisUtterance(p)).lang=s,S.rate=a,S.onstart=function(){v=!1,E=c,C=Date.now(),T=0,b=!1,L(!0),D()},S.onend=function(){v=!1,N(!1)},S.onerror=function(t){var e=t&&t.error;if("interrupted"===e||"cancelled"===e){if(v)return;return void N(!0)}v=!1,console.error("朗读错误:",t),N(!1),d.textContent="错误"},f.value=String(r),d.textContent=n(c)+" / "+n(w),window.speechSynthesis.speak(S)}}}window.CXSpeech=window.CXSpeech||{},window.CXSpeech.cancel=function(){P(),N(!1)},c.style.display="flex",f.addEventListener("mousedown",(function(){x=!0,M()})),f.addEventListener("touchstart",(function(){x=!0,M()})),f.addEventListener("input",(function(){if(w){var t=i(Number(f.value)||0,0,100),e=(t/100)*w;d.textContent=n(e)+" / "+n(w)}else f.value="0",d.textContent="00:00 / 00:00"})),f.addEventListener("change",(function(){var t=i(Number(f.value)||0,0,100);x=!1,y&&U(t)})),document.addEventListener("mouseup",(function(){x&&(x=!1)})),document.addEventListener("touchend",(function(){x&&(x=!1)})),u.addEventListener("click",(function(){if(!S||!y)return y=e(a()),y?(w=o(y,Number(l.value)||.5),E=0,f.value="0",d.textContent="00:00 / "+n(w),void U(0)):void 0;if(b){try{window.speechSynthesis.resume()}catch(t){}b=!1,L(!0),T&&(C+=Date.now()-T,T=0),D()}else{try{window.speechSynthesis.pause()}catch(t){}b=!0,L(!1),T=Date.now(),M()}})),l.addEventListener("change",(function(){if(localStorage.setItem("speechRate",l.value),y){var t=k(),e=w;w=o(y,Number(l.value)||.5);var n=0;e>0&&(n=i(t/e*100,0,100)),f.value=String(n),U(n)}})),N(!0),window.addEventListener("beforeunload",(function(){P(),N(!1)})),document.addEventListener("visibilitychange",(function(){if(document.hidden&&S&&!b)try{window.speechSynthesis.pause(),b=!0,L(!1),T=Date.now(),M()}catch(t){}}))}}}}window.CXSpeech=window.CXSpeech||{},window.CXSpeech.init=r}();
