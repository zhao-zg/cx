{% extends "base.html" %}

{% block title %}{{ training.title }}{% endblock %}

{% block content %}
<div class="index-page">
    <div class="toc-list">
        {% for chapter in training.chapters %}
        <a href="{{ chapter.number }}_cx.htm" class="toc-item" data-chapter="{{ chapter.number }}">
            <span class="toc-num">ç¬¬{{ chapter.number }}ç¯‡</span>
            <span class="toc-title">{{ chapter.title }}</span>
        </a>
        {% endfor %}
    </div>
    
    <!-- å®‰è£…å’Œç¼“å­˜æŒ‰é’® -->
    <div class="cache-section" id="cacheSection">
        <button class="cache-btn install-btn" id="installBtn" style="display:none;">
            <span class="cache-icon">ğŸ“²</span>
            <span class="cache-text">å®‰è£…åˆ°æ¡Œé¢</span>
        </button>
        <button class="cache-btn" id="cacheBtn">
            <span class="cache-icon">ğŸ“¥</span>
            <span class="cache-text">ç¼“å­˜ç¦»çº¿ä½¿ç”¨</span>
        </button>
        <button class="cache-btn clear-btn" id="clearCacheBtn" style="display:none;">
            <span class="cache-icon">ğŸ—‘</span>
            <span class="cache-text">æ¸…ç©ºç¼“å­˜</span>
        </button>
        <div class="cache-status" id="cacheStatus"></div>
    </div>
</div>

<style>
.index-page {
    padding: 0;
}

.toc-list {
    display: flex;
    flex-direction: column;
    gap: 1px;
    background: #e8ecf0;
    border-radius: 10px;
    overflow: hidden;
}

.toc-item {
    display: flex;
    align-items: baseline;
    gap: 12px;
    padding: 14px 16px;
    background: #fff;
    text-decoration: none;
    color: inherit;
    transition: background 0.15s;
}

.toc-item:active {
    background: #f0f4ff;
}

.toc-num {
    flex-shrink: 0;
    font-size: 15px;
    font-weight: 600;
    color: #667eea;
    white-space: nowrap;
}

.toc-title {
    flex: 1;
    font-size: 16px;
    line-height: 1.6;
    color: #2d3748;
    font-weight: 500;
}

/* æ¡Œé¢ç«¯ä¼˜åŒ– */
@media (min-width: 768px) {
    .toc-list {
        gap: 0;
        border-radius: 12px;
    }
    
    .toc-item {
        padding: 16px 20px;
        gap: 14px;
    }
    
    .toc-item:hover {
        background: #f0f4ff;
    }
    
    .toc-num {
        font-size: 16px;
    }
    
    .toc-title {
        font-size: 17px;
    }
}

/* ç¼“å­˜æŒ‰é’® */
.cache-section {
    margin-top: 20px;
    text-align: center;
}

.cache-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    min-height: 44px;
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
}

.cache-btn:active {
    transform: scale(0.97);
}

.cache-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.cache-btn.cached {
    background: #48bb78;
}

.clear-btn {
    background: #e53e3e;
    margin-left: 10px;
}

.install-btn {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    margin-right: 10px;
}

.cache-icon {
    font-size: 18px;
}

.cache-status {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
}

.cache-status.success {
    color: #48bb78;
}

.cache-status.error {
    color: #e53e3e;
}
</style>

<script>
// PWA å®‰è£…åŠŸèƒ½
var deferredPrompt = null;
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    var installBtn = document.getElementById('installBtn');
    if (installBtn) {
        installBtn.style.display = 'inline-flex';
    }
});

// æ ¹æ®æ˜ŸæœŸå‡ å†³å®šè·³è½¬ç›®æ ‡
document.addEventListener('DOMContentLoaded', function() {
    var dayOfWeek = new Date().getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
    var dayAnchors = ['', 'day1', 'day2', 'day3', 'day4', 'day5', 'day6']; // å‘¨ä¸€åˆ°å‘¨å…­
    
    var tocItems = document.querySelectorAll('.toc-item');
    tocItems.forEach(function(item) {
        var chapterNum = item.getAttribute('data-chapter');
        
        if (dayOfWeek === 0) {
            // å‘¨æ—¥ï¼šè·³è½¬åˆ°çº²ç›®é¡µ
            item.href = chapterNum + '_cv.htm';
        } else {
            // å‘¨ä¸€åˆ°å‘¨å…­ï¼šè·³è½¬åˆ°æ™¨å…´é¡µå¯¹åº”çš„å¤©
            item.href = chapterNum + '_cx.htm#' + dayAnchors[dayOfWeek];
        }
    });
    
    // ç¼“å­˜åŠŸèƒ½
    var cacheBtn = document.getElementById('cacheBtn');
    var cacheStatus = document.getElementById('cacheStatus');
    var cacheSection = document.getElementById('cacheSection');
    
    if (!('serviceWorker' in navigator)) {
        cacheSection.style.display = 'none';
        return;
    }
    
    var clearCacheBtn = document.getElementById('clearCacheBtn');
    
    function showCachedState() {
        cacheBtn.innerHTML = '<span class="cache-icon">ğŸ”„</span><span class="cache-text">é‡æ–°ç¼“å­˜</span>';
        cacheBtn.classList.add('cached');
        clearCacheBtn.style.display = 'inline-flex';
    }
    
    function showUncachedState() {
        cacheBtn.innerHTML = '<span class="cache-icon">ğŸ“¥</span><span class="cache-text">ç¼“å­˜ç¦»çº¿ä½¿ç”¨</span>';
        cacheBtn.classList.remove('cached');
        clearCacheBtn.style.display = 'none';
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜
    caches.keys().then(function(keys) {
        if (keys.length > 0) {
            showCachedState();
        }
    });
    
    // ç›‘å¬ SW æ¶ˆæ¯
    navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data.type === 'cached') {
            cacheBtn.disabled = false;
            if (event.data.success) {
                showCachedState();
                cacheStatus.textContent = 'ç¼“å­˜å®Œæˆï¼Œå¯ç¦»çº¿ä½¿ç”¨';
                cacheStatus.className = 'cache-status success';
            } else {
                cacheStatus.textContent = 'ç¼“å­˜å¤±è´¥: ' + (event.data.error || 'æœªçŸ¥é”™è¯¯');
                cacheStatus.className = 'cache-status error';
            }
        }
    });
    
    // ç‚¹å‡»ç¼“å­˜æŒ‰é’®
    cacheBtn.addEventListener('click', function() {
        cacheBtn.disabled = true;
        cacheBtn.innerHTML = '<span class="cache-icon">â³</span><span class="cache-text">ç¼“å­˜ä¸­...</span>';
        cacheStatus.textContent = '';
        
        navigator.serviceWorker.ready.then(function(reg) {
            reg.active.postMessage('cache-all');
        }).catch(function(err) {
            cacheBtn.disabled = false;
            showUncachedState();
            cacheStatus.textContent = 'ç¼“å­˜å¤±è´¥: ' + err.message;
            cacheStatus.className = 'cache-status error';
        });
    });
    
    // ç‚¹å‡»æ¸…ç©ºç¼“å­˜æŒ‰é’®
    clearCacheBtn.addEventListener('click', function() {
        clearCacheBtn.disabled = true;
        cacheStatus.textContent = 'æ¸…ç©ºä¸­...';
        
        caches.keys().then(function(keys) {
            return Promise.all(keys.map(function(key) {
                return caches.delete(key);
            }));
        }).then(function() {
            showUncachedState();
            clearCacheBtn.disabled = false;
            cacheStatus.textContent = 'ç¼“å­˜å·²æ¸…ç©º';
            cacheStatus.className = 'cache-status success';
        }).catch(function(err) {
            clearCacheBtn.disabled = false;
            cacheStatus.textContent = 'æ¸…ç©ºå¤±è´¥: ' + err.message;
            cacheStatus.className = 'cache-status error';
        });
    });
    
    // å®‰è£…æŒ‰é’®ç‚¹å‡»
    var installBtn = document.getElementById('installBtn');
    
    // æ£€æµ‹ iOS
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
    
    // iOS ä¸”æœªå®‰è£…æ—¶æ˜¾ç¤ºæç¤º
    if (isIOS && !isStandalone) {
        installBtn.style.display = 'inline-flex';
        installBtn.innerHTML = '<span class="cache-icon">ğŸ“²</span><span class="cache-text">æ·»åŠ åˆ°ä¸»å±å¹•</span>';
        installBtn.addEventListener('click', function() {
            cacheStatus.innerHTML = 'è¯·ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨ <strong>åˆ†äº«æŒ‰é’® â†‘</strong>ï¼Œç„¶åé€‰æ‹© <strong>"æ·»åŠ åˆ°ä¸»å±å¹•"</strong>';
            cacheStatus.className = 'cache-status';
        });
    } else if (installBtn) {
        // Android/æ¡Œé¢æµè§ˆå™¨
        installBtn.addEventListener('click', function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(result) {
                    if (result.outcome === 'accepted') {
                        installBtn.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        });
    }
});
</script>
{% endblock %}
