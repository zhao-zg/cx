{% extends "base.html" %}

{% block title %}{{ training.title }}{% endblock %}

{% block content %}
<div class="index-page">
    <div class="back-home-wrapper">
        <a href="../index.html" class="back-home">
            <svg class="back-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span class="back-text">返回主页</span>
        </a>
    </div>
    
    <div class="toc-list">
        {% for chapter in training.chapters %}
        <a href="{{ chapter.number }}_cx.htm" class="toc-item" data-chapter="{{ chapter.number }}">
            <span class="toc-num">第{{ chapter.number }}篇</span>
            <span class="toc-title">{{ chapter.title }}</span>
        </a>
        {% endfor %}
    </div>
</div>

<style>
.index-page {
    padding: 0;
}

.back-home-wrapper {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e8ecf0;
}

.back-home {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px 8px 10px;
    color: #4a8fd9;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    border-radius: 8px;
    background: #f8f9ff;
    border: 1px solid #e0e4ff;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(102, 126, 234, 0.08);
}

.back-home:active {
    background: #eef1ff;
    border-color: #4a8fd9;
    transform: translateX(-2px);
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
}

.back-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    transition: transform 0.2s ease;
}

.back-home:active .back-icon {
    transform: translateX(-2px);
}

.back-text {
    line-height: 1;
    letter-spacing: 0.3px;
}

.toc-list {
    display: flex;
    flex-direction: column;
    gap: 1px;
    background: #e8ecf0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
}

.toc-item {
    display: flex;
    align-items: baseline;
    gap: 12px;
    padding: 14px 16px;
    background: #fff;
    text-decoration: none;
    color: inherit;
    transition: background 0.15s;
}

.toc-item:active {
    background: #f0f4ff;
}

.toc-num {
    flex-shrink: 0;
    font-size: 1em;
    font-weight: 600;
    color: #4a8fd9;
    white-space: nowrap;
}

.toc-title {
    flex: 1;
    font-size: 1.05em;
    line-height: 1.6;
    color: #2d3748;
    font-weight: 500;
}

/* 桌面端优化 */
@media (min-width: 768px) {
    .back-home-wrapper {
        margin-bottom: 24px;
        padding-bottom: 18px;
    }
    
    .back-home {
        font-size: 15px;
        padding: 10px 16px 10px 12px;
    }
    
    .back-home:hover {
        background: #eef1ff;
        border-color: #4a8fd9;
        transform: translateX(-2px);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
    }
    
    .back-home:hover .back-icon {
        transform: translateX(-2px);
    }
    
    .back-icon {
        width: 20px;
        height: 20px;
    }
    
    .toc-list {
        gap: 0;
        border-radius: 12px;
    }
    
    .toc-item {
        padding: 16px 20px;
        gap: 14px;
    }
    
    .toc-item:hover {
        background: #f0f4ff;
    }
    
    .toc-num {
        font-size: 1em;
    }
    
    .toc-title {
        font-size: 1.0625em;
    }
}


</style>

<script>
// Android 返回键处理 - 目录页返回主页
(function() {
    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.App) {
        var initialHistoryLength = window.history.length;
        var backPressCount = 0;
        
        window.Capacitor.Plugins.App.addListener('backButton', function(data) {
            backPressCount++;
            
            if (backPressCount < initialHistoryLength && data.canGoBack) {
                window.history.back();
            } else {
                // 没有历史记录了，跳转到主页
                window.location.href = '../index.html';
            }
        });
    }
})();

// 页面记忆功能 - 恢复上次访问的页面（仅在 PWA/APP 模式下）
(function() {
    try {
        // 检查是否在 PWA 或 Capacitor APP 中运行
        var isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true;
        var isCapacitor = window.Capacitor !== undefined;
        var isApp = isPWA || isCapacitor;
        
        console.log('[训练目录] 环境检测:', {
            isPWA: isPWA,
            isCapacitor: isCapacitor,
            isApp: isApp,
            pathname: window.location.pathname,
            referrer: document.referrer
        });
        
        if (!isApp) {
            console.log('[训练目录] 非 APP 环境，不启用记忆功能');
            return; // 非 APP 模式不启用记忆功能
        }
        
        // 检查是否是从外部进入（没有 referrer 或 referrer 不是本站）
        var isExternalEntry = !document.referrer || !document.referrer.startsWith(window.location.origin);
        
        // 如果不是外部进入（即用户主动点击进入训练目录），不恢复
        if (!isExternalEntry) {
            console.log('[训练目录] 用户主动访问目录（有 referrer），不启用恢复功能');
            return;
        }
        
        var lastPage = localStorage.getItem('cx_last_page');
        var lastPageTime = localStorage.getItem('cx_last_page_time');
        
        console.log('[训练目录] 上次访问:', lastPage, '时间:', lastPageTime);
        
        // 如果有保存的页面，且在7天内访问过，则恢复
        if (lastPage && lastPageTime) {
            var timeDiff = Date.now() - parseInt(lastPageTime);
            var days7 = 7 * 24 * 60 * 60 * 1000;
            
            if (timeDiff < days7) {
                // 检查上次访问的页面是否属于当前训练（且不是训练目录本身）
                var currentPath = window.location.pathname.replace(/\/[^\/]*$/, '/');
                var isInCurrentTraining = lastPage.indexOf(currentPath) !== -1;
                
                // 更严格的检查：确保不是 index.html 结尾
                var isNotIndexPage = !lastPage.match(/\/index\.html($|#|\?)/);
                
                // 额外检查：确保是具体的内容页（包含 _cx.htm, _cv.htm 等）
                var isContentPage = lastPage.match(/\/\d+_[a-z]+\.htm/);
                
                console.log('[训练目录] 检查条件:', {
                    isInCurrentTraining: isInCurrentTraining,
                    isNotIndexPage: isNotIndexPage,
                    isContentPage: isContentPage,
                    currentPath: currentPath,
                    lastPage: lastPage
                });
                
                if (isInCurrentTraining && isNotIndexPage && isContentPage) {
                    console.log('[训练目录] ✓ 恢复上次访问的页面:', lastPage);
                    window.location.replace(lastPage);
                    return;
                } else {
                    console.log('[训练目录] ✗ 不满足恢复条件，停留在目录');
                }
            } else {
                console.log('[训练目录] 上次访问时间过久，不恢复');
            }
        } else {
            console.log('[训练目录] 没有保存的页面记录');
        }
    } catch (e) {
        console.error('[训练目录] 页面记忆错误:', e);
    }
})();

// 根据星期几决定跳转目标
document.addEventListener('DOMContentLoaded', function() {
    var dayOfWeek = new Date().getDay(); // 0=周日, 1=周一, ..., 6=周六
    var dayAnchors = ['', 'day1', 'day2', 'day3', 'day4', 'day5', 'day6']; // 周一到周六
    
    var tocItems = document.querySelectorAll('.toc-item');
    tocItems.forEach(function(item) {
        var chapterNum = item.getAttribute('data-chapter');
        
        if (dayOfWeek === 0) {
            // 周日：跳转到纲目页
            item.href = chapterNum + '_cv.htm';
        } else {
            // 周一到周六：跳转到晨兴页对应的天
            item.href = chapterNum + '_cx.htm#' + dayAnchors[dayOfWeek];
        }
    });
});
</script>
{% endblock %}
