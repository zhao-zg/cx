<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç‰¹ä¼šä¿¡æ¯ - åŠ è½½ä¸­">
    <meta name="theme-color" content="#667eea">
    <title>ç‰¹ä¼šä¿¡æ¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            padding: 20px;
        }
        
        .logo {
            font-size: 64px;
            margin-bottom: 20px;
            cursor: pointer;
            user-select: none;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .loading {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .update-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
        }
        
        .update-info.show {
            display: block;
        }
        
        .progress {
            background: rgba(255, 255, 255, 0.2);
            height: 4px;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: white;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo" id="logo">ğŸ“–</div>
        <h1>ç‰¹ä¼šä¿¡æ¯</h1>
        <div class="loading" id="status">æ­£åœ¨åŠ è½½...</div>
        <div class="spinner" id="spinner"></div>
        
        <div class="error" id="error">
            <p id="errorMsg">åŠ è½½å¤±è´¥</p>
            <button class="btn" onclick="location.reload()">é‡è¯•</button>
        </div>
        
        <div class="update-info" id="updateInfo">
            <p id="updateMsg">æ£€æŸ¥æ›´æ–°ä¸­...</p>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>
    
    <script>
        // é…ç½®
        const CONFIG = {
            // å¤šä¸ªè¿œç¨‹å†…å®¹åœ°å€ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
            REMOTE_URLS: [
                'https://cx.zhaozg.dpdns.org/',
                'https://cx.zhaozg.cloudns.org/',
                'https://cx.xzdjx.dynv6.net/',
                'https://zhao-zg.github.io/cx/'
            ],
            // APK æ›´æ–°æ£€æŸ¥åœ°å€ï¼ˆGitHub APIï¼‰
            APK_UPDATE_URL: 'https://api.github.com/repos/zhao-zg/cx/releases/latest',
            // å½“å‰ APK ç‰ˆæœ¬
            CURRENT_APK_VERSION: '0.1.0',
            // æœ¬åœ°å­˜å‚¨é”®
            STORAGE_KEY: 'cx_content_version',
            STORAGE_URL_KEY: 'cx_selected_url',
            STORAGE_APK_CHECK_KEY: 'cx_last_apk_check',
            // ç‚¹å‡»æ¬¡æ•°è§¦å‘æ›´æ–°æ£€æŸ¥
            CLICK_COUNT_TRIGGER: 10,
            // è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            TIMEOUT: 5000,
            // APK æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼Œ24å°æ—¶ï¼‰
            APK_CHECK_INTERVAL: 24 * 60 * 60 * 1000
        };
        
        // è·å–å½“å‰ä½¿ç”¨çš„ URL
        function getCurrentUrl() {
            const saved = localStorage.getItem(CONFIG.STORAGE_URL_KEY);
            if (saved && CONFIG.REMOTE_URLS.includes(saved)) {
                return saved;
            }
            return CONFIG.REMOTE_URLS[0];
        }
        
        // è®¾ç½®å½“å‰ URL
        function setCurrentUrl(url) {
            localStorage.setItem(CONFIG.STORAGE_URL_KEY, url);
        }
        
        // æµ‹è¯• URL æ˜¯å¦å¯ç”¨
        async function testUrl(url, timeout = CONFIG.TIMEOUT) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url + 'version.json?t=' + Date.now(), {
                    signal: controller.signal,
                    method: 'HEAD'
                });
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                clearTimeout(timeoutId);
                return false;
            }
        }
        
        // æŸ¥æ‰¾å¯ç”¨çš„ URL
        async function findAvailableUrl() {
            const currentUrl = getCurrentUrl();
            
            // å…ˆæµ‹è¯•å½“å‰ URL
            if (await testUrl(currentUrl)) {
                return currentUrl;
            }
            
            // æµ‹è¯•å…¶ä»– URL
            for (const url of CONFIG.REMOTE_URLS) {
                if (url === currentUrl) continue;
                
                if (await testUrl(url)) {
                    setCurrentUrl(url);
                    return url;
                }
            }
            
            // éƒ½ä¸å¯ç”¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
            return CONFIG.REMOTE_URLS[0];
        }
        
        let clickCount = 0;
        let isUpdating = false;
        let longPressTimer = null;
        
        // Logo ç‚¹å‡»è®¡æ•°
        document.getElementById('logo').addEventListener('click', function() {
            if (isUpdating) return;
            
            clickCount++;
            console.log('ç‚¹å‡»æ¬¡æ•°:', clickCount);
            
            if (clickCount >= CONFIG.CLICK_COUNT_TRIGGER) {
                clickCount = 0;
                // åŒæ—¶æ£€æŸ¥ APK å’Œå†…å®¹æ›´æ–°
                checkApkUpdate(true);
                checkForUpdates(true);
            }
        });
        
        // Logo é•¿æŒ‰æ˜¾ç¤ºæœåŠ¡å™¨é€‰æ‹©
        document.getElementById('logo').addEventListener('touchstart', function(e) {
            longPressTimer = setTimeout(() => {
                showServerSelector();
            }, 1000);
        });
        
        document.getElementById('logo').addEventListener('touchend', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        document.getElementById('logo').addEventListener('mousedown', function(e) {
            longPressTimer = setTimeout(() => {
                showServerSelector();
            }, 1000);
        });
        
        document.getElementById('logo').addEventListener('mouseup', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        // æ£€æŸ¥ APK æ›´æ–°
        async function checkApkUpdate(force = false) {
            try {
                // æ£€æŸ¥ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´
                const lastCheck = localStorage.getItem(CONFIG.STORAGE_APK_CHECK_KEY);
                const now = Date.now();
                
                if (!force && lastCheck && (now - parseInt(lastCheck)) < CONFIG.APK_CHECK_INTERVAL) {
                    return; // 24å°æ—¶å†…å·²æ£€æŸ¥è¿‡
                }
                
                // è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
                const response = await fetch(CONFIG.APK_UPDATE_URL);
                if (!response.ok) return;
                
                const release = await response.json();
                const latestVersion = release.tag_name.replace('v', '');
                
                // ä¿å­˜æ£€æŸ¥æ—¶é—´
                localStorage.setItem(CONFIG.STORAGE_APK_CHECK_KEY, now.toString());
                
                // æ¯”è¾ƒç‰ˆæœ¬
                if (compareVersion(latestVersion, CONFIG.CURRENT_APK_VERSION) > 0) {
                    showApkUpdateDialog(release);
                }
            } catch (error) {
                console.error('APK æ›´æ–°æ£€æŸ¥å¤±è´¥:', error);
            }
        }
        
        // ç‰ˆæœ¬æ¯”è¾ƒ
        function compareVersion(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            
            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const p1 = parts1[i] || 0;
                const p2 = parts2[i] || 0;
                if (p1 > p2) return 1;
                if (p1 < p2) return -1;
            }
            return 0;
        }
        
        // æ˜¾ç¤º APK æ›´æ–°å¯¹è¯æ¡†
        function showApkUpdateDialog(release) {
            const apkAsset = release.assets.find(a => a.name.endsWith('.apk'));
            if (!apkAsset) return;
            
            const html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="apkUpdateDialog">
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬</h3>
                        <div style="color: #333; margin-bottom: 20px;">
                            <p style="margin-bottom: 10px;">
                                <strong>å½“å‰ç‰ˆæœ¬ï¼š</strong>v${CONFIG.CURRENT_APK_VERSION}<br>
                                <strong>æœ€æ–°ç‰ˆæœ¬ï¼š</strong>${release.tag_name}
                            </p>
                            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; font-size: 14px; max-height: 200px; overflow-y: auto;">
                                ${release.body ? release.body.replace(/\n/g, '<br>') : 'æŸ¥çœ‹æ›´æ–°æ—¥å¿—'}
                            </div>
                        </div>
                        <button style="width: 100%; padding: 12px; margin-bottom: 10px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;" onclick="downloadApk('${apkAsset.browser_download_url}')">
                            ç«‹å³ä¸‹è½½æ›´æ–°
                        </button>
                        <button style="width: 100%; padding: 12px; background: #f0f0f0; color: #666; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;" onclick="closeApkUpdateDialog()">
                            ç¨åæé†’
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // ä¸‹è½½ APK
        window.downloadApk = function(url) {
            window.open(url, '_blank');
            closeApkUpdateDialog();
        };
        
        // å…³é—­ APK æ›´æ–°å¯¹è¯æ¡†
        window.closeApkUpdateDialog = function() {
            const dialog = document.getElementById('apkUpdateDialog');
            if (dialog) {
                dialog.remove();
            }
        };
        
        // æ˜¾ç¤ºæœåŠ¡å™¨é€‰æ‹©å™¨
        function showServerSelector() {
            const currentUrl = getCurrentUrl();
            const urls = CONFIG.REMOTE_URLS;
            
            const html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;" id="serverSelector">
                    <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">é€‰æ‹©å†…å®¹æœåŠ¡å™¨</h3>
                        ${urls.map((url, index) => `
                            <div style="padding: 12px; margin: 8px 0; border: 2px solid ${url === currentUrl ? '#667eea' : '#ddd'}; border-radius: 8px; cursor: pointer; color: #333;" onclick="selectServer('${url}')">
                                <div style="font-weight: ${url === currentUrl ? 'bold' : 'normal'}; color: ${url === currentUrl ? '#667eea' : '#333'};">
                                    ${url === currentUrl ? 'âœ“ ' : ''}æœåŠ¡å™¨ ${index + 1}
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px; word-break: break-all;">
                                    ${url}
                                </div>
                            </div>
                        `).join('')}
                        <button style="width: 100%; padding: 12px; margin-top: 15px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;" onclick="closeServerSelector()">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // é€‰æ‹©æœåŠ¡å™¨
        window.selectServer = function(url) {
            setCurrentUrl(url);
            closeServerSelector();
            
            // æç¤ºå¹¶é‡æ–°åŠ è½½
            const updateInfo = document.getElementById('updateInfo');
            const updateMsg = document.getElementById('updateMsg');
            updateInfo.classList.add('show');
            updateMsg.textContent = 'å·²åˆ‡æ¢æœåŠ¡å™¨ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...';
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        };
        
        // å…³é—­æœåŠ¡å™¨é€‰æ‹©å™¨
        window.closeServerSelector = function() {
            const selector = document.getElementById('serverSelector');
            if (selector) {
                selector.remove();
            }
        };
        
        // æ£€æŸ¥æ›´æ–°
        async function checkForUpdates(manual = false) {
            if (isUpdating) return;
            isUpdating = true;
            
            const updateInfo = document.getElementById('updateInfo');
            const updateMsg = document.getElementById('updateMsg');
            const progressBar = document.getElementById('progressBar');
            
            updateInfo.classList.add('show');
            updateMsg.textContent = 'æ£€æŸ¥æ›´æ–°ä¸­...';
            progressBar.style.width = '10%';
            
            try {
                // æŸ¥æ‰¾å¯ç”¨çš„æœåŠ¡å™¨
                const remoteUrl = await findAvailableUrl();
                updateMsg.textContent = 'è¿æ¥åˆ°æœåŠ¡å™¨...';
                progressBar.style.width = '20%';
                
                // è·å–è¿œç¨‹ç‰ˆæœ¬ä¿¡æ¯
                const response = await fetch(remoteUrl + 'version.json?t=' + Date.now());
                if (!response.ok) throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                
                const remoteVersion = await response.json();
                const localVersion = localStorage.getItem(CONFIG.STORAGE_KEY);
                
                progressBar.style.width = '30%';
                
                if (localVersion !== remoteVersion.version || manual) {
                    updateMsg.textContent = 'å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ­£åœ¨ä¸‹è½½...';
                    progressBar.style.width = '50%';
                    
                    // ä¸‹è½½å¹¶ç¼“å­˜æ–°å†…å®¹
                    await cacheContent(remoteVersion, remoteUrl);
                    
                    progressBar.style.width = '100%';
                    updateMsg.textContent = 'æ›´æ–°å®Œæˆï¼';
                    
                    // ä¿å­˜ç‰ˆæœ¬å·
                    localStorage.setItem(CONFIG.STORAGE_KEY, remoteVersion.version);
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    progressBar.style.width = '100%';
                    updateMsg.textContent = 'å·²æ˜¯æœ€æ–°ç‰ˆæœ¬';
                    setTimeout(() => {
                        updateInfo.classList.remove('show');
                        isUpdating = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('æ›´æ–°æ£€æŸ¥å¤±è´¥:', error);
                updateMsg.textContent = 'æ›´æ–°æ£€æŸ¥å¤±è´¥: ' + error.message;
                setTimeout(() => {
                    updateInfo.classList.remove('show');
                    isUpdating = false;
                }, 3000);
            }
        }
        
        // ç¼“å­˜å†…å®¹
        async function cacheContent(versionInfo, remoteUrl) {
            if (!('serviceWorker' in navigator)) return;
            
            const registration = await navigator.serviceWorker.ready;
            const cache = await caches.open('cx-content-' + versionInfo.version);
            
            // ç¼“å­˜ä¸»è¦æ–‡ä»¶
            const filesToCache = [
                remoteUrl,
                remoteUrl + 'index.html',
                ...(versionInfo.files || []).map(f => remoteUrl + f)
            ];
            
            await cache.addAll(filesToCache);
        }
        
        // åŠ è½½å†…å®¹
        async function loadContent() {
            const status = document.getElementById('status');
            const spinner = document.getElementById('spinner');
            const error = document.getElementById('error');
            const errorMsg = document.getElementById('errorMsg');
            
            try {
                // æŸ¥æ‰¾å¯ç”¨çš„æœåŠ¡å™¨
                status.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';
                const remoteUrl = await findAvailableUrl();
                
                // é¦–å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½
                const cache = await caches.open('cx-content');
                const cachedResponse = await cache.match(remoteUrl + 'index.html');
                
                if (cachedResponse) {
                    // æœ‰ç¼“å­˜ï¼Œç›´æ¥è·³è½¬
                    window.location.href = remoteUrl + 'index.html';
                    return;
                }
                
                // æ²¡æœ‰ç¼“å­˜ï¼Œä»ç½‘ç»œåŠ è½½
                status.textContent = 'é¦–æ¬¡åŠ è½½ï¼Œè¯·ç¨å€™...';
                
                const response = await fetch(remoteUrl + 'index.html');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½å†…å®¹');
                
                // ç¼“å­˜å†…å®¹
                await cache.put(remoteUrl + 'index.html', response.clone());
                
                // è·³è½¬
                window.location.href = remoteUrl + 'index.html';
                
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥:', err);
                spinner.style.display = 'none';
                status.style.display = 'none';
                errorMsg.textContent = 'åŠ è½½å¤±è´¥: ' + err.message + '\n\né•¿æŒ‰ Logo å¯åˆ‡æ¢æœåŠ¡å™¨';
                error.classList.add('show');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('load', function() {
            // æ£€æŸ¥ APK æ›´æ–°ï¼ˆæ¯24å°æ—¶ä¸€æ¬¡ï¼‰
            checkApkUpdate(false);
            
            // è‡ªåŠ¨æ£€æŸ¥å†…å®¹æ›´æ–°ï¼ˆé™é»˜ï¼‰
            checkForUpdates(false);
            
            // åŠ è½½å†…å®¹
            setTimeout(loadContent, 1000);
        });
    </script>
</body>
</html>
