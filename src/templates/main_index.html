<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç‰¹ä¼šä¿¡æ¯åˆé›† - æ‰€æœ‰è®­ç»ƒæ€»è§ˆ">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="trainings.json" as="fetch" crossorigin>
    <title>ç‰¹ä¼šä¿¡æ¯åˆé›†</title>
    <style>
        :root{--brand:#667eea;--brand-dark:#5B67D4;--bg:linear-gradient(135deg,#667EEA,#5B67D4);--surface:#fff;--surface-alt:#f3f5f9;--page-bg:#f6f7fb;--header-bg:var(--brand);--nav-hover:#f7f9ff;--scripture-bg:#f6f7fa;--muted:#f8f9fa;--border:#e6e8f0;--text:#2f343a;--text-soft:#596170;--text-muted:#7b8697;--heading:#1b2436;--heading-strong:#141c2b;--heading-soft:#2a3954;--heading-muted:#3a4a67;--radius-sm:6px;--radius-md:8px;--shadow-sm:0 1px 4px rgba(0,0,0,.06);--shadow-md:0 6px 16px rgba(0,0,0,.08)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;line-height:1.65;color:var(--text);background:var(--page-bg);min-height:100vh;padding:8px 8px 16px;font-size:18px;-webkit-font-smoothing:antialiased}
        .container{max-width:800px;margin:0 auto;background:var(--surface);border-radius:12px;box-shadow:var(--shadow-md);border:1px solid var(--border);overflow:hidden}
        .header{background:var(--header-bg);color:#fff;text-align:center;padding:16px 12px;margin-bottom:20px;border-radius:8px}
        .header h1{font-size:1.17em;margin-bottom:8px;font-weight:600;line-height:1.8}
        .header .subtitle{font-size:0.88em;opacity:.9;line-height:1.8}
        .content{padding:0}
        .trainings-grid{display:flex;flex-direction:column;gap:0;margin:0;background:#fff;overflow:hidden}
        .training-card{background:#fff;overflow:hidden;border-bottom:1px solid #e8e8e8;transition:background-color .2s}
        .training-card:hover{background:#fafbfc}
        .training-card:last-child{border-bottom:none}
        .training-card-wrapper{display:flex;align-items:stretch;gap:0}
        .training-link{display:block;padding:12px 16px;text-decoration:none;color:inherit;flex:1;min-width:0;transition:background-color .2s}
        .training-link:active{background:#f0f4f8}
        .training-info{position:relative}
        .training-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:8px}
        /* éª¨æ¶å± */
        .skeleton-item{padding:16px;border-bottom:1px solid #e8e8e8}
        .skeleton-line{height:18px;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;margin-bottom:8px}
        .skeleton-line.short{width:30%;height:14px}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .training-card .year-season {
            font-size: 17px;
            color: var(--brand);
            font-weight: 600;
            flex-shrink: 0;
            line-height: 1.3;
        }
        
        .training-card .info {
            color: #a0aec0;
            font-size: 16px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .training-title-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0;
        }
        
        .training-card .title {
            font-size: 1.05em;
            color: var(--text);
            line-height: 1.6;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            border-radius: 4px;
            cursor: pointer;
            min-height: 32px;
            flex: 1;
        }

        .training-title-row .arrow {
            margin-left: auto;
            color: #cbd5e0;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        
        
        .footer {
            text-align: center;
            padding: 16px;
            color: #999;
            background: #f5f7fa;
            border-top: 1px solid #e0e0e0;
        }
        
        @media (min-width:768px){
            .header{margin-bottom:30px;padding:25px 20px}
            .header h1{font-size:1.5em;margin-bottom:10px}
        }
        
        /* ç¼“å­˜æŒ‰é’® */
        .cache-section {
            padding: 12px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            display: none;
        }
        
        .cache-section.show {
            display: block;
        }

        #dataToolsSection.show {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        #dataToolsStatus {
            flex-basis: 100%;
        }
        
        .cache-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: var(--bg);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: 42px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin: 4px;
        }
        
        .cache-btn:active {
            transform: scale(0.97);
        }
        
        .cache-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .cache-btn.cached {
            background: #48bb78;
        }
        
        .clear-btn {
            background: #e53e3e;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }
        
        .cache-icon {
            font-size: 16px;
        }
        
        .cache-status {
            margin-top: 8px;
            font-size: 13px;
            color: #666;
            padding: 0 16px;
        }
        
        .cache-status.success {
            color: #48bb78;
        }
        
        .cache-status.error {
            color: #e53e3e;
        }
        
        @media (max-width: 480px) {
            .cache-section {
                padding: 12px 8px;
            }
            
            .cache-btn {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 38px;
                margin: 3px;
            }
            
            .cache-icon {
                font-size: 14px;
            }
            
            .cache-status {
                font-size: 12px;
                padding: 0 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="mainLogo" style="cursor: pointer; user-select: none;">ğŸ  ç‰¹ä¼šä¿¡æ¯åˆé›†</h1>
            <p class="subtitle">Conference Information Collections</p>
        </div>
        
        <div class="content">
            <div class="trainings-grid" id="trainingsGrid">
                <!-- éª¨æ¶å± - åŠ è½½æ—¶æ˜¾ç¤º -->
                <div class="skeleton-item"><div class="skeleton-line" style="width:60%"></div><div class="skeleton-line short"></div></div>
                <div class="skeleton-item"><div class="skeleton-line" style="width:70%"></div><div class="skeleton-line short"></div></div>
                <div class="skeleton-item"><div class="skeleton-line" style="width:55%"></div><div class="skeleton-line short"></div></div>
            </div>
        </div>
        
        <!-- å®‰è£…æŒ‰é’®åŒºåŸŸ -->
        <div class="cache-section" id="installSection">
            <button class="cache-btn install-btn" id="installBtn" style="display:none;">
                <span class="cache-icon">ğŸ“²</span>
                <span class="cache-text">å®‰è£…åˆ°æ¡Œé¢</span>
            </button>
            <button class="cache-btn" id="androidApkBtn" style="display:none; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                <span class="cache-icon">ğŸ“±</span>
                <span class="cache-text">å®‰å“ç¦»çº¿ç‰ˆ</span>
            </button>
            <div class="cache-status" id="installStatus"></div>
        </div>

        <!-- æ•°æ®å·¥å…·åŒºåŸŸ -->
        <div class="cache-section" id="dataToolsSection" style="display: none;">
            <button class="cache-btn" id="clearDataBtn">
                <span class="cache-icon">ğŸ§¹</span>
                <span class="cache-text">æ¸…ç†æ•°æ®</span>
            </button>
            <button class="cache-btn" id="cacheAllBtn">
                <span class="cache-icon">ğŸ“¦</span>
                <span class="cache-text">ç¼“å­˜æ•°æ®</span>
            </button>
            <div class="cache-status" id="dataToolsStatus"></div>
        </div>
        
        <!-- æ£€æŸ¥æ›´æ–°æŒ‰é’®ï¼ˆä»…åœ¨ APP å†…æ˜¾ç¤ºï¼‰ -->
        <div class="cache-section" id="updateSection" style="display: none;">
            <button class="cache-btn" id="checkUpdateBtn">
                <span class="cache-icon">ğŸ”„</span>
                <span class="cache-text">æ£€æŸ¥æ›´æ–°</span>
            </button>
            <div class="cache-status" id="updateStatus"></div>
        </div>
        
        <div class="footer">
            <p>æœ¬ç«™å†…å®¹ä»…ä¾›ä¸»æ¢å¤åœ£å¾’äº¤é€šä½¿ç”¨</p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                ç”Ÿæˆæ—¶é—´: {{ generation_time }}
            </p>
        </div>
    </div>
    
    <!-- JSZip åº“ç”¨äºè§£å‹æ›´æ–°åŒ… -->
    <script src="vendor/jszip.min.js"></script>
    
    <!-- APK æ›´æ–°åŠŸèƒ½æ¨¡å—ï¼ˆä»…åœ¨ Capacitor APP ç¯å¢ƒä¸‹åŠ è½½ï¼‰ -->
    <script>
    (function() {
        // æ£€æµ‹æ˜¯å¦åœ¨ Capacitor ç¯å¢ƒä¸­
        var isCapacitor = window.Capacitor !== undefined;
        var isCapacitorScheme = window.location.protocol === 'capacitor:' || 
                                (window.location.hostname === 'localhost' && window.location.protocol === 'http:');
        
        // åªåœ¨ Capacitor APP ç¯å¢ƒä¸‹åŠ è½½ app-update.js
        if (isCapacitor || isCapacitorScheme) {
            var script = document.createElement('script');
            script.src = 'js/app-update.js';
            document.head.appendChild(script);
        }
    })();
    </script>
    <script src="js/nav-stack.js"></script>
    
    <script>
    // ä¸»é¢˜é¢œè‰²å¸¸é‡ - ç”¨äºåŠ¨æ€ç”Ÿæˆçš„ HTML
    var THEME = {
        brand: '#667eea',
        brandDark: '#5b7ce6',
        bg: 'linear-gradient(135deg, #667eea 0%, #5b7ce6 100%)',
        success: '#48bb78',
        successDark: '#38a169'
    };
    
    // ç»Ÿä¸€çš„ç¯å¢ƒæ£€æµ‹ - é¿å…é‡å¤ä»£ç 
    var CX_ENV = (function() {
        return {
            isAndroid: /Android/i.test(navigator.userAgent),
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            isCapacitor: window.Capacitor !== undefined,
            isCapacitorScheme: window.location.protocol === 'capacitor:' || 
                              (window.location.hostname === 'localhost' && window.location.protocol === 'http:'),
            isStandalone: window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches,
            get isInApp() {
                return this.isStandalone;
            },
            get isCapacitorApp() {
                return this.isCapacitor || this.isCapacitorScheme;
            }
        };
    })();
    
    // è‡ªåŠ¨è®¾ç½® APK ç‰ˆæœ¬ï¼ˆç”¨äºç¦»çº¿ç‰ˆï¼‰
    (function() {
        // æ£€æµ‹æ˜¯å¦åœ¨ Capacitor æˆ– PWA ç¯å¢ƒä¸­
        var isCapacitor = window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.App;
        var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isCapacitor || isPWA) {
            if (isCapacitor) {
                window.Capacitor.Plugins.App.getInfo().then(function(info) {
                    if (info.version) {
                        localStorage.setItem('cx_apk_version', info.version);
                        console.log('ä» Capacitor è·å–ç‰ˆæœ¬:', info.version, 'åŒ…å:', info.id);
                    }
                }).catch(function(err) {
                    console.log('æ— æ³•è·å– App ä¿¡æ¯:', err);
                });
            }
            
            if (window.CXNavStack) {
                window.CXNavStack.initHomePage({ deferPushIfEmpty: true });
            }
        }
    })();
    
    // åŠ¨æ€åŠ è½½è®­ç»ƒåˆ—è¡¨
    (function() {
        console.log('[è®­ç»ƒåˆ—è¡¨] å¼€å§‹åŠ è½½');
        
        // ä» APK å†…ç½®åŠ è½½
        loadTrainingsFromBundle();
        
        // ä» APK å†…ç½®åŠ è½½
        function loadTrainingsFromBundle() {
            console.log('[è®­ç»ƒåˆ—è¡¨] ä» APK å†…ç½®åŠ è½½');
            return fetch('trainings.json?t=' + Date.now())
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log('[è®­ç»ƒåˆ—è¡¨] APK å†…ç½®ç‰ˆæœ¬:', data.version);
                    renderTrainings(data);
                })
                .catch(function(error) {
                    console.error('[è®­ç»ƒåˆ—è¡¨] APK å†…ç½®åŠ è½½å¤±è´¥:', error);
                    showLoadError();
                });
        }
        
        // æ¸²æŸ“è®­ç»ƒåˆ—è¡¨
        function renderTrainings(data) {
            var grid = document.getElementById('trainingsGrid');
            if (!grid) return;
            
            var trainings = data.trainings || [];
            window.__cxTrainings = trainings;
            if (trainings.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— è®­ç»ƒå†…å®¹</div>';
                return;
            }
            
            var html = '';
            trainings.forEach(function(training) {
                html += '<div class="training-card">';
                html += '<div class="training-card-wrapper">';
                html += '<a href="' + training.path + '/index.html" class="training-link">';
                html += '<div class="training-info">';
                html += '<div class="training-header">';
                html += '<div class="year-season">' + training.year + 'å¹´' + training.season.split(' ')[0] + '</div>';
                html += '<div class="info">å…± ' + training.chapter_count + ' ç¯‡</div>';
                html += '</div>';
                html += '<div class="training-title-row">';
                html += '<div class="title">' + training.title + '</div>';
                html += '<span class="arrow">â†’</span>';
                html += '</div>';
                html += '</div>';
                html += '</a>';
                html += '</div>';
                html += '</div>';
            });
            
            grid.innerHTML = html;
            
            // PWA æ¨¡å¼ä¸‹ä»…æ˜¾ç¤ºæ•°æ®å·¥å…·åŒº
            var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
            if (isStandalone) {
                var dataToolsSection = document.getElementById('dataToolsSection');
                if (dataToolsSection) {
                    dataToolsSection.style.display = 'flex';
                    dataToolsSection.classList.add('show');
                }
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½é”™è¯¯
        function showLoadError() {
            var grid = document.getElementById('trainingsGrid');
            if (!grid) return;
            
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53e3e;">';
            grid.innerHTML += '<div style="font-size: 24px; margin-bottom: 10px;">âŒ</div>';
            grid.innerHTML += '<div>åŠ è½½è®­ç»ƒåˆ—è¡¨å¤±è´¥</div>';
            grid.innerHTML += '<button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: ' + THEME.brand + '; color: white; border: none; border-radius: 6px; cursor: pointer;">é‡è¯•</button>';
            grid.innerHTML += '</div>';
        }
    })();
    
    // APK æ£€æµ‹å’Œæ›´æ–°åŠŸèƒ½
    (function() {
        console.log('APK æ£€æµ‹åˆå§‹åŒ–:', {
            isAndroid: CX_ENV.isAndroid,
            isInApp: CX_ENV.isInApp,
            isCapacitor: CX_ENV.isCapacitor,
            isCapacitorScheme: CX_ENV.isCapacitorScheme,
            userAgent: navigator.userAgent,
            protocol: window.location.protocol,
            hostname: window.location.hostname
        });
        
        // æ£€æŸ¥æ›´æ–°æŒ‰é’®åªåœ¨ Capacitor APK ç¯å¢ƒæ˜¾ç¤ºï¼ˆä¸åœ¨ PWA ä¸­æ˜¾ç¤ºï¼‰
        if (CX_ENV.isAndroid && CX_ENV.isCapacitorApp) {
            // æ˜¾ç¤ºæ£€æŸ¥æ›´æ–°æŒ‰é’®
            var updateSection = document.getElementById('updateSection');
            var checkUpdateBtn = document.getElementById('checkUpdateBtn');
            var updateStatus = document.getElementById('updateStatus');
            
            if (updateSection && checkUpdateBtn) {
                updateSection.style.display = 'block';
                
                checkUpdateBtn.addEventListener('click', function() {
                    // è°ƒç”¨ AppUpdate æ¨¡å—çš„æ›´æ–°æ£€æŸ¥å¯¹è¯æ¡†
                    if (window.AppUpdate && window.AppUpdate.showCloudflareUpdateDialog) {
                        window.AppUpdate.showCloudflareUpdateDialog();
                    } else {
                        console.error('AppUpdate æ¨¡å—æœªåŠ è½½æˆ–æ–¹æ³•ä¸å¯ç”¨');
                        alert('æ›´æ–°åŠŸèƒ½æœªåŠ è½½');
                    }
                });
            }
            
            // éšè—å…¥å£ï¼šç‚¹å‡» Logo 8 æ¬¡ + å¯†ç éªŒè¯ï¼ˆç”¨äº GitHub Release ä¸‹è½½ï¼‰
            var clickCount = 0;
            var clickTimer = null;
            var logo = document.getElementById('mainLogo');
            
            console.log('APK æ›´æ–°æ£€æŸ¥å·²å¯ç”¨ï¼Œç‚¹å‡» Logo 8 æ¬¡è§¦å‘éšè—å…¥å£');
            
            if (logo) {
                logo.addEventListener('click', function() {
                    clickCount++;
                    console.log('Logo ç‚¹å‡»:', clickCount, '/8');
                    
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(function() {
                        console.log('ç‚¹å‡»è®¡æ•°é‡ç½®');
                        clickCount = 0;
                    }, 5000);
                    
                    // ç‚¹å‡» 8 æ¬¡è§¦å‘å¯†ç éªŒè¯
                    if (clickCount >= 8) {
                        clickCount = 0;
                        if (clickTimer) clearTimeout(clickTimer);
                        console.log('=== è§¦å‘å¯†ç éªŒè¯ ===');
                        
                        // å¼¹å‡ºå¯†ç è¾“å…¥æ¡†
                        var password = prompt('è¯·è¾“å…¥ç®¡ç†å¯†ç ï¼š');
                        if (password === '1189') {
                            console.log('å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºæ›´æ–°æ£€æŸ¥');
                            // è°ƒç”¨ AppUpdate æ¨¡å—çš„ GitHub æ›´æ–°æ£€æŸ¥å¯¹è¯æ¡†
                            if (window.AppUpdate && window.AppUpdate.showGitHubUpdateDialog) {
                                window.AppUpdate.showGitHubUpdateDialog();
                            } else {
                                console.error('AppUpdate æ¨¡å—æœªåŠ è½½æˆ–æ–¹æ³•ä¸å¯ç”¨');
                                alert('æ›´æ–°åŠŸèƒ½æœªåŠ è½½');
                            }
                        } else if (password !== null) {
                            alert('å¯†ç é”™è¯¯');
                        }
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ° mainLogo å…ƒç´ ');
            }
        } else {
            console.log('APK æ›´æ–°æ£€æŸ¥æœªå¯ç”¨ï¼ˆéå®‰å“ APP ç¯å¢ƒï¼‰');
        }
    })();
    
    // é¡µé¢è®°å¿†åŠŸèƒ½ - ä¿å­˜ä¸»é¡µè®¿é—®è®°å½•
    (function() {
        function saveMainPage() {
            try {
                var href = window.location.href;
                localStorage.setItem('cx_last_page', href);
                localStorage.setItem('cx_last_page_time', Date.now());
                console.log('[é¡µé¢è®°å¿†] âœ“ ä¿å­˜ä¸»é¡µ:', href);
            } catch (e) {
                console.error('[é¡µé¢è®°å¿†] ä¿å­˜å¤±è´¥:', e);
            }
        }
        
        // æ£€æŸ¥å¯¼èˆªæ ˆæ˜¯å¦æœ‰å†…å®¹ï¼ˆæœ‰å†…å®¹è¯´æ˜æ˜¯ç”¨æˆ·ä¸»åŠ¨å¯¼èˆªå›æ¥çš„ï¼‰
        var navStack = JSON.parse(sessionStorage.getItem('cx_nav_stack') || '[]');
        var isUserNavigation = navStack.length > 0;
        
        // ç”¨æˆ·ä¸»åŠ¨è¿›å…¥ä¸»é¡µæ—¶ï¼Œç«‹å³ä¿å­˜
        if (isUserNavigation) {
            saveMainPage();
        }
        
        // é¡µé¢å¸è½½å‰ä¿å­˜
        window.addEventListener('beforeunload', saveMainPage);
        
        // é¡µé¢éšè—æ—¶ä¿å­˜ï¼ˆç§»åŠ¨ç«¯åˆ‡æ¢åº”ç”¨ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                saveMainPage();
            }
        });
    })();
    
    // é¡µé¢è®°å¿†åŠŸèƒ½ - æ¢å¤ä¸Šæ¬¡è®¿é—®çš„é¡µé¢ï¼ˆPWA å’Œ Capacitor APPï¼‰
    (function() {
        try {
            // æ£€æŸ¥æ˜¯å¦åœ¨ PWA æˆ– Capacitor APP ä¸­è¿è¡Œ
            var isApp = CX_ENV.isInApp || CX_ENV.isCapacitor;
            
            console.log('[é¡µé¢è®°å¿†] ç¯å¢ƒæ£€æµ‹:', {
                isPWA: CX_ENV.isStandalone,
                isCapacitor: CX_ENV.isCapacitor,
                isApp: isApp
            });
            
            if (!isApp) {
                console.log('[é¡µé¢è®°å¿†] é APP ç¯å¢ƒï¼Œä¸å¯ç”¨è®°å¿†åŠŸèƒ½');
                return; // é APP æ¨¡å¼ä¸å¯ç”¨è®°å¿†åŠŸèƒ½
            }
            
            var lastPage = localStorage.getItem('cx_last_page');
            var lastPageTime = localStorage.getItem('cx_last_page_time');
            
            console.log('[é¡µé¢è®°å¿†] ä¸Šæ¬¡è®¿é—®:', lastPage, 'æ—¶é—´:', lastPageTime);
            
            // å¦‚æœæœ‰ä¿å­˜çš„é¡µé¢ï¼Œä¸”åœ¨7å¤©å†…è®¿é—®è¿‡ï¼Œåˆ™æ¢å¤
            if (lastPage && lastPageTime) {
                var timeDiff = Date.now() - parseInt(lastPageTime);
                var days7 = 7 * 24 * 60 * 60 * 1000;
                
                if (timeDiff < days7) {
                    // æ£€æŸ¥å¯¼èˆªæ ˆæ˜¯å¦ä¸ºç©ºï¼ˆç©ºæ ˆè¯´æ˜æ˜¯æ–°ä¼šè¯ï¼ŒAPP åˆšæ‰“å¼€ï¼‰
                    var navStack = JSON.parse(sessionStorage.getItem('cx_nav_stack') || '[]');
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨è¿”å›ï¼ˆä¸æ˜¯æ–°ä¼šè¯ï¼‰
                    var isUserBack = sessionStorage.getItem('cx_user_back') === 'true';
                    if (isUserBack) {
                        sessionStorage.removeItem('cx_user_back');
                    }
                    var isNewSession = navStack.length === 0 && !isUserBack;
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µï¼ˆæ”¯æŒå„ç§è·¯å¾„æ ¼å¼ï¼‰
                    var pathname = window.location.pathname;
                    var isMainPage = pathname === '/' || 
                                    pathname === '/index.html' ||
                                    pathname === '' ||
                                    // Capacitor å¯èƒ½ä½¿ç”¨ç‰¹æ®Šè·¯å¾„
                                    pathname === '/android_asset/public/index.html' ||
                                    pathname.includes('/public/index.html');
                    
                    // æ£€æŸ¥ä¿å­˜çš„é¡µé¢æ˜¯å¦ä¹Ÿæ˜¯ä¸»é¡µï¼ˆé¿å…ä¸»é¡µè·³ä¸»é¡µï¼‰
                    var lastPagePath = new URL(lastPage).pathname;
                    var lastPageIsMain = lastPagePath === '/' || 
                                        lastPagePath === '/index.html' ||
                                        lastPagePath === '' ||
                                        lastPagePath === '/android_asset/public/index.html' ||
                                        lastPagePath.includes('/public/index.html');
                    
                    console.log('[é¡µé¢è®°å¿†] æ£€æŸ¥æ¡ä»¶:', {
                        isNewSession: isNewSession,
                        isMainPage: isMainPage,
                        lastPageIsMain: lastPageIsMain,
                        navStackLength: navStack.length,
                        pathname: window.location.pathname
                    });
                    
                    // åªåœ¨æ–°ä¼šè¯è¿›å…¥ä¸»é¡µæ—¶æ¢å¤ï¼Œä¸”ä¿å­˜çš„é¡µé¢ä¸æ˜¯ä¸»é¡µ  
                    if (isNewSession && isMainPage && !lastPageIsMain) {
                        console.log('[é¡µé¢è®°å¿†] æ¢å¤ä¸Šæ¬¡è®¿é—®çš„é¡µé¢:', lastPage);
                        // æ¸…ç©ºå¯¼èˆªæ ˆï¼Œå› ä¸ºæ˜¯è‡ªåŠ¨è·³è½¬ï¼Œä¸åº”è¯¥è®°å½•ä¸»é¡µ
                        sessionStorage.removeItem('cx_nav_stack');
                        window.location.replace(lastPage);
                        return;
                    } else {
                        // ä¸è·³è½¬ï¼ŒæŠŠä¸»é¡µå‹å…¥æ ˆ
                        if (isNewSession) {
                            var currentPath = window.location.pathname + window.location.search + window.location.hash;
                            sessionStorage.setItem('cx_nav_stack', JSON.stringify([currentPath]));
                        }
                        var href = window.location.href;
                        localStorage.setItem('cx_last_page', href);
                        localStorage.setItem('cx_last_page_time', Date.now());
                        console.log('[é¡µé¢è®°å¿†] ä¸æ»¡è¶³æ¢å¤æ¡ä»¶ï¼Œä¿æŒåœ¨ä¸»é¡µ, ä¸”è®°å¿†');
                    }
                } else {
                    // æ—¶é—´è¿‡ä¹…ï¼Œä¸è·³è½¬ï¼ŒæŠŠä¸»é¡µå‹å…¥æ ˆ
                    if (isNewSession) {
                        var currentPath = window.location.pathname + window.location.search + window.location.hash;
                        sessionStorage.setItem('cx_nav_stack', JSON.stringify([currentPath]));
                    }
                    console.log('[é¡µé¢è®°å¿†] ä¸Šæ¬¡è®¿é—®æ—¶é—´è¿‡ä¹…ï¼Œä¸æ¢å¤');
                }
            } else {
                // æ²¡æœ‰è®°å½•ï¼ŒæŠŠä¸»é¡µå‹å…¥æ ˆ
                var navStack = JSON.parse(sessionStorage.getItem('cx_nav_stack') || '[]');
                if (navStack.length === 0) {
                    var currentPath = window.location.pathname + window.location.search + window.location.hash;
                    sessionStorage.setItem('cx_nav_stack', JSON.stringify([currentPath]));
                }
                console.log('[é¡µé¢è®°å¿†] æ²¡æœ‰ä¿å­˜çš„é¡µé¢è®°å½•');
            }
        } catch (e) {
            console.error('[é¡µé¢è®°å¿†] é”™è¯¯:', e);
        }
    })();
    
    // æ³¨å†Œ Service Worker å¹¶è‡ªåŠ¨æ›´æ–°
    if ('serviceWorker' in navigator) {
        var isInstalling = false;
        var installStartTime = Date.now();
        
        console.log('[ä¸»é¡µ] å¼€å§‹æ³¨å†Œ Service Worker');
        
        navigator.serviceWorker.register('./sw.js').then(function(reg) {
            console.log('[ä¸»é¡µ] Service Worker æ³¨å†ŒæˆåŠŸ');
            
            // æ£€æŸ¥æ›´æ–°ï¼ˆä½†ä¸é˜»å¡ï¼‰
            reg.update().catch(function(err) {
                console.log('[ä¸»é¡µ] æ£€æŸ¥æ›´æ–°å¤±è´¥:', err);
            });
            
            // ç›‘å¬å®‰è£…è¿›åº¦
            if (reg.installing) {
                trackInstalling(reg.installing);
            }
            
            // ç›‘å¬æ›´æ–°
            reg.addEventListener('updatefound', function() {
                console.log('[ä¸»é¡µ] å‘ç°æ›´æ–°');
                var newWorker = reg.installing;
                trackInstalling(newWorker);
                
                newWorker.addEventListener('statechange', function() {
                    console.log('[ä¸»é¡µ] SW çŠ¶æ€å˜åŒ–:', newWorker.state);
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œé™é»˜æ›´æ–°ï¼ˆä¸æ‰“æ‰°ç”¨æˆ·ï¼‰
                        console.log('[ä¸»é¡µ] æ–°ç‰ˆæœ¬å·²å°±ç»ªï¼Œä¸‹æ¬¡è®¿é—®æ—¶ç”Ÿæ•ˆ');
                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
            });
            
            // ç­‰å¾… Service Worker å°±ç»ª
            return navigator.serviceWorker.ready;
        }).then(function() {
            var installTime = Date.now() - installStartTime;
            console.log('[ä¸»é¡µ] Service Worker å·²å°±ç»ªï¼Œè€—æ—¶:', installTime, 'ms');
        }).catch(function(err) {
            console.error('[ä¸»é¡µ] Service Worker æ³¨å†Œå¤±è´¥:', err);
        });
        
        // ç›‘å¬ SW æ§åˆ¶å™¨å˜åŒ–ï¼ˆé™é»˜åˆ·æ–°ï¼‰
        var refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', function() {
            if (refreshing) return;
            refreshing = true;
            console.log('[ä¸»é¡µ] Service Worker å·²æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢');
            window.location.reload();
        });
        
        // è·Ÿè¸ªå®‰è£…è¿›åº¦
        function trackInstalling(worker) {
            if (isInstalling) return;
            isInstalling = true;
            console.log('[ä¸»é¡µ] Service Worker æ­£åœ¨å®‰è£…');
        }
    }
    
    // PWA å®‰è£…åŠŸèƒ½
    var deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        var installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.style.display = 'inline-flex';
        }
    });
    
    // ç”Ÿæˆå•ä¸ªè®­ç»ƒçš„èµ„æºåˆ—è¡¨ï¼ˆæå‡åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    function getTrainingResources(path, chapters, images) {
        var resources = [
            './' + path + '/',
            './' + path + '/js/speech.js',
            './' + path + '/js/font-control.js',
            './' + path + '/js/highlight.js'
        ];
        for (var i = 1; i <= chapters; i++) {
            resources.push('./' + path + '/' + i + '_cv.htm');
            resources.push('./' + path + '/' + i + '_cx.htm');
            resources.push('./' + path + '/' + i + '_sg.htm');
            resources.push('./' + path + '/' + i + '_ts.htm');
            resources.push('./' + path + '/' + i + '_zs.htm');
            resources.push('./' + path + '/' + i + '_h.htm');
        }
        // æ·»åŠ å›¾ç‰‡
        if (images && images.length > 0) {
            images.forEach(function(img) {
                resources.push('./' + path + '/' + img);
            });
        }
        return resources;
    }
    

    // ç¼“å­˜æ‰€æœ‰è®­ç»ƒèµ„æº
    function cacheAllTrainings(statusEl) {
        if (!('caches' in window)) {
            if (statusEl) {
                statusEl.textContent = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒç¼“å­˜';
                statusEl.className = 'cache-status error';
            }
            return Promise.resolve();
        }

        var trainings = window.__cxTrainings || [];
        if (!trainings.length) {
            if (statusEl) {
                statusEl.textContent = 'è®­ç»ƒåˆ—è¡¨å°šæœªåŠ è½½';
                statusEl.className = 'cache-status error';
            }
            return Promise.resolve();
        }

        var totalTrainings = trainings.length;
        var currentIndex = 0;
        var totalResources = 0;
        var cachedResources = 0;

        trainings.forEach(function(training) {
            totalResources += getTrainingResources(training.path, training.chapter_count, training.images || []).length;
        });

        if (statusEl) {
            statusEl.textContent = 'å¼€å§‹ç¼“å­˜å…¨éƒ¨è®­ç»ƒ...';
            statusEl.className = 'cache-status';
        }

        return trainings.reduce(function(promise, training) {
            return promise.then(function() {
                currentIndex++;
                var resources = getTrainingResources(training.path, training.chapter_count, training.images || []);
                var cacheKey = 'cx-' + training.path;

                if (statusEl) {
                    statusEl.textContent = 'ç¼“å­˜ä¸­ï¼š' + training.title + 'ï¼ˆ' + currentIndex + '/' + totalTrainings + 'ï¼‰';
                    statusEl.className = 'cache-status';
                }

                return caches.open(cacheKey).then(function(cache) {
                    var tasks = resources.map(function(url) {
                        return fetch(url, { redirect: 'follow', cache: 'no-cache' })
                            .then(function(response) {
                                if (response.ok && response.status >= 200 && response.status < 300) {
                                    cachedResources++;
                                    if (statusEl) {
                                        var percent = totalResources > 0 ? Math.round((cachedResources / totalResources) * 100) : 0;
                                        statusEl.textContent = 'ç¼“å­˜è¿›åº¦ï¼š' + percent + '%';
                                    }
                                    return cache.put(response.url, response.clone());
                                }
                            })
                            .catch(function() {
                                cachedResources++;
                            });
                    });
                    return Promise.all(tasks);
                });
            });
        }, Promise.resolve()).then(function() {
            if (statusEl) {
                statusEl.textContent = 'âœ“ å…¨éƒ¨ç¼“å­˜å®Œæˆ';
                statusEl.className = 'cache-status success';
            }
        }).then(function() {
            try {
                localStorage.setItem('cx_all_cached', Date.now().toString());
            } catch (e) {}
            updateCacheAllButtonState();
        }).catch(function(err) {
            console.error('ç¼“å­˜æ‰€æœ‰è®­ç»ƒå¤±è´¥:', err);
            if (statusEl) {
                statusEl.textContent = 'âš  ç¼“å­˜ä¸­æ–­ï¼Œè¯·é‡è¯•';
                statusEl.className = 'cache-status warning';
            }
        });
    }

    function updateCacheAllButtonState() {
        var cacheAllBtn = document.getElementById('cacheAllBtn');
        var dataToolsStatus = document.getElementById('dataToolsStatus');
        if (!cacheAllBtn) return;

        var flag = null;
        try {
            flag = localStorage.getItem('cx_all_cached');
        } catch (e) {}

        if (!flag) {
            cacheAllBtn.querySelector('.cache-icon').textContent = 'ğŸ“¦';
            cacheAllBtn.querySelector('.cache-text').textContent = 'ç¼“å­˜æ•°æ®';
            return;
        }

        if ('caches' in window) {
            caches.keys().then(function(keys) {
                var hasTrainingCache = keys.some(function(key) { return key.indexOf('cx-') === 0; });
                if (hasTrainingCache) {
                    cacheAllBtn.querySelector('.cache-icon').textContent = 'âœ…';
                    cacheAllBtn.querySelector('.cache-text').textContent = 'å·²ç¼“å­˜';
                    if (dataToolsStatus && !dataToolsStatus.textContent) {
                        dataToolsStatus.textContent = 'âœ“ å·²ç¼“å­˜å…¨éƒ¨æ•°æ®';
                        dataToolsStatus.className = 'cache-status success';
                    }
                } else {
                    try { localStorage.removeItem('cx_all_cached'); } catch (e) {}
                    cacheAllBtn.querySelector('.cache-icon').textContent = 'ğŸ“¦';
                    cacheAllBtn.querySelector('.cache-text').textContent = 'ç¼“å­˜æ•°æ®';
                }
            }).catch(function() {
                cacheAllBtn.querySelector('.cache-icon').textContent = 'ğŸ“¦';
                cacheAllBtn.querySelector('.cache-text').textContent = 'ç¼“å­˜æ•°æ®';
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        var installSection = document.getElementById('installSection');
        var installBtn = document.getElementById('installBtn');
        var androidApkBtn = document.getElementById('androidApkBtn');
        var installStatus = document.getElementById('installStatus');
        var dataToolsSection = document.getElementById('dataToolsSection');
        var clearDataBtn = document.getElementById('clearDataBtn');
        var cacheAllBtn = document.getElementById('cacheAllBtn');
        var dataToolsStatus = document.getElementById('dataToolsStatus');
        
        if (!('serviceWorker' in navigator)) {
            return;
        }
        
        // å¦‚æœæ˜¯å®‰å“è®¾å¤‡ä¸”ä¸åœ¨ APP å†…ï¼Œæ˜¾ç¤º APK ä¸‹è½½æŒ‰é’®
        if (CX_ENV.isAndroid && !CX_ENV.isInApp && !CX_ENV.isCapacitor) {
            installSection.classList.add('show');
            androidApkBtn.style.display = 'inline-flex';
            
            androidApkBtn.addEventListener('click', function() {
                installStatus.textContent = 'æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬...';
                installStatus.className = 'cache-status';
                
                // ä»å½“å‰ç½‘ç«™è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰
                fetch('version.json?t=' + Date.now(), { cache: 'no-cache' })
                    .then(function(response) {
                        if (!response.ok) throw new Error('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯');
                        return response.json();
                    })
                    .then(function(versionInfo) {
                        var version = versionInfo.apk_version || versionInfo.version;
                        var apkFile = versionInfo.apk_file || ('TeHui-v' + version + '.apk');
                        var apkSize = versionInfo.apk_size;
                        var downloadUrl = apkFile;  // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                        var sizeText = apkSize ? ' (' + (apkSize / 1024 / 1024).toFixed(1) + ' MB)' : '';
                        
                        installStatus.textContent = 'æ­£åœ¨ä¸‹è½½ v' + version + sizeText + '...';
                        installStatus.className = 'cache-status success';
                        window.open(downloadUrl, '_blank');
                    })
                    .catch(function(error) {
                        installStatus.textContent = 'è·å–å¤±è´¥: ' + error.message;
                        installStatus.className = 'cache-status error';
                    });
            });
        }
        
        // åªåœ¨ PWA æ¨¡å¼ä¸‹æ˜¾ç¤ºæ•°æ®å·¥å…·åŒº
        if (CX_ENV.isStandalone) {
            if (dataToolsSection) {
                dataToolsSection.style.display = 'flex';
                dataToolsSection.classList.add('show');
            }
        } else {
            // é PWA æ¨¡å¼ï¼Œæ˜¾ç¤ºå®‰è£…åŒºåŸŸ
            installSection.classList.add('show');
        }

        // iOS å®‰è£…æç¤º
        if (CX_ENV.isIOS && !CX_ENV.isStandalone) {
            installBtn.style.display = 'inline-flex';
            installBtn.innerHTML = '<span class="cache-icon">ğŸ“²</span><span class="cache-text">æ·»åŠ åˆ°ä¸»å±å¹•</span>';
            installBtn.addEventListener('click', function() {
                installStatus.innerHTML = 'è¯·ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨ <strong>åˆ†äº«æŒ‰é’® â†‘</strong>ï¼Œç„¶åé€‰æ‹© <strong>"æ·»åŠ åˆ°ä¸»å±å¹•"</strong>';
                installStatus.className = 'cache-status';
            });
        } else if (installBtn) {
            installBtn.addEventListener('click', function() {
                if (deferredPrompt) {
                    installStatus.textContent = 'æ­£åœ¨å‡†å¤‡å®‰è£…...';
                    installStatus.className = 'cache-status';
                    
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(function(result) {
                        if (result.outcome === 'accepted') {
                            installStatus.textContent = 'âœ“ å®‰è£…æˆåŠŸï¼PWA å·²æ·»åŠ åˆ°ä¸»å±å¹•';
                            installStatus.className = 'cache-status success';
                            
                            // ç­‰å¾… Service Worker å°±ç»ª
                            if ('serviceWorker' in navigator) {
                                navigator.serviceWorker.ready.then(function() {
                                    installStatus.textContent = 'âœ“ å®‰è£…å®Œæˆï¼ç¦»çº¿åŠŸèƒ½å·²å¯ç”¨';
                                });
                            }
                            
                            setTimeout(function() {
                                installBtn.style.display = 'none';
                            }, 3000);
                        } else {
                            installStatus.textContent = '';
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
        
        // æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†åŠŸèƒ½ï¼ˆé€šè¿‡é•¿æŒ‰ Logo è§¦å‘ï¼‰
        var logo = document.getElementById('mainLogo');
        
        if (logo) {
            var longPressTimer = null;
            var isLongPress = false;
            
            // è§¦æ‘¸å¼€å§‹
            logo.addEventListener('touchstart', function(e) {
                isLongPress = false;
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    // è§¦å‘æ¸…ç†ç¼“å­˜
                    promptClearData();
                }, 2000); // é•¿æŒ‰2ç§’è§¦å‘
            });
            
            // è§¦æ‘¸ç»“æŸ
            logo.addEventListener('touchend', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                // å¦‚æœæ˜¯é•¿æŒ‰ï¼Œé˜»æ­¢ç‚¹å‡»äº‹ä»¶
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // è§¦æ‘¸ç§»åŠ¨ï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
            logo.addEventListener('touchmove', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                isLongPress = false;
            });
            
            // æ¡Œé¢ç«¯ï¼šé¼ æ ‡é•¿æŒ‰
            logo.addEventListener('mousedown', function(e) {
                isLongPress = false;
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    promptClearData();
                }, 2000);
            });
            
            logo.addEventListener('mouseup', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            logo.addEventListener('mouseleave', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                isLongPress = false;
            });
        }

        function promptClearData() {
            var ok = confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ï¼š\nâ€¢ æ‰€æœ‰è®­ç»ƒçš„ç¦»çº¿ç¼“å­˜\nâ€¢ é¡µé¢è®°å¿†\nâ€¢ å­—ä½“å¤§å°è®¾ç½®\nâ€¢ è¯­é€Ÿè®¾ç½®\n\nä¸‹ä¸€æ­¥å¯é€‰æ‹©æ˜¯å¦ä¿ç•™åˆ’çº¿ç¬”è®°ã€‚');
            if (!ok) return;
            var keepNotes = confirm('æ˜¯å¦ä¿ç•™åˆ’çº¿ç¬”è®°ï¼Ÿ\n\nâ€œç¡®å®šâ€= ä¿ç•™ç¬”è®°\nâ€œå–æ¶ˆâ€= åŒæ—¶æ¸…ç†ç¬”è®°');
            clearAllCachesAndMemory({ keepNotes: keepNotes });
        }

        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', function() {
                promptClearData();
            });
        }

        if (cacheAllBtn) {
            cacheAllBtn.addEventListener('click', function() {
                cacheAllBtn.disabled = true;
                cacheAllTrainings(dataToolsStatus).finally(function() {
                    cacheAllBtn.disabled = false;
                });
            });
        }

        updateCacheAllButtonState();
        
        // æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†çš„å‡½æ•°
        function clearAllCachesAndMemory(options) {
            options = options || {};
            var keepNotes = options.keepNotes === true;
            console.log('[æ¸…ç†] å¼€å§‹æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†');
            
            var installStatus = document.getElementById('installStatus');
            var dataToolsStatus = document.getElementById('dataToolsStatus');
            if (installStatus) {
                installStatus.textContent = 'æ­£åœ¨æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†...';
                installStatus.className = 'cache-status';
            }
            if (dataToolsStatus) {
                dataToolsStatus.textContent = 'æ­£åœ¨æ¸…ç†æ•°æ®...';
                dataToolsStatus.className = 'cache-status';
            }
            
            var cleanupSteps = [];
            
            // 1. æ¸…ç† localStorageï¼ˆé¡µé¢è®°å¿†ã€å­—ä½“è®¾ç½®ã€è¯­é€Ÿè®¾ç½®ç­‰ï¼‰
            cleanupSteps.push(new Promise(function(resolve) {
                try {
                    var keysToRemove = [];
                    for (var i = 0; i < localStorage.length; i++) {
                        var key = localStorage.key(i);
                        // æ¸…ç†æ‰€æœ‰ cx_ å¼€å¤´çš„é”®
                        if (key && key.startsWith('cx_')) {
                            if (keepNotes && key === 'cx_highlights') {
                                continue;
                            }
                            keysToRemove.push(key);
                        }
                        // æ¸…ç†å­—ä½“å’Œè¯­é€Ÿè®¾ç½®
                        if (key === 'fontSize' || key === 'speechRate') {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(function(key) {
                        localStorage.removeItem(key);
                        console.log('[æ¸…ç†] åˆ é™¤ localStorage:', key);
                    });
                    console.log('[æ¸…ç†] localStorage æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤', keysToRemove.length, 'é¡¹');
                    resolve();
                } catch (e) {
                    console.error('[æ¸…ç†] æ¸…ç† localStorage å¤±è´¥:', e);
                    resolve(); // ç»§ç»­æ‰§è¡Œå…¶ä»–æ¸…ç†
                }
            }));
            
            // 2. æ¸…ç† sessionStorage
            cleanupSteps.push(new Promise(function(resolve) {
                try {
                    sessionStorage.clear();
                    console.log('[æ¸…ç†] sessionStorage å·²æ¸…ç†');
                    resolve();
                } catch (e) {
                    console.error('[æ¸…ç†] æ¸…ç† sessionStorage å¤±è´¥:', e);
                    resolve();
                }
            }));
            
            // 3. æ³¨é”€æ‰€æœ‰ Service Worker
            if ('serviceWorker' in navigator) {
                cleanupSteps.push(
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        console.log('[æ¸…ç†] æ‰¾åˆ° Service Worker:', registrations.length, 'ä¸ª');
                        return Promise.all(
                            registrations.map(function(registration) {
                                console.log('[æ¸…ç†] æ³¨é”€ Service Worker:', registration.scope);
                                return registration.unregister();
                            })
                        );
                    }).catch(function(e) {
                        console.error('[æ¸…ç†] æ³¨é”€ Service Worker å¤±è´¥:', e);
                    })
                );
            }
            
            // 4. æ¸…ç†æ‰€æœ‰ Cache Storage
            if ('caches' in window) {
                cleanupSteps.push(
                    caches.keys().then(function(keys) {
                        console.log('[æ¸…ç†] æ‰¾åˆ°ç¼“å­˜:', keys.length, 'ä¸ª');
                        return Promise.all(
                            keys.map(function(key) {
                                console.log('[æ¸…ç†] åˆ é™¤ç¼“å­˜:', key);
                                return caches.delete(key);
                            })
                        );
                    }).catch(function(e) {
                        console.error('[æ¸…ç†] æ¸…ç† Cache Storage å¤±è´¥:', e);
                    })
                );
            }
            
            // 5. æ¸…ç† IndexedDB
            if ('indexedDB' in window) {
                cleanupSteps.push(new Promise(function(resolve) {
                    try {
                        // å°è¯•åˆ é™¤å¸¸è§çš„ IndexedDB æ•°æ®åº“
                        var dbNames = ['cx-trainings', 'cx-cache', 'workbox-expiration'];
                        var deletePromises = dbNames.map(function(dbName) {
                            return new Promise(function(resolveDB) {
                                var request = indexedDB.deleteDatabase(dbName);
                                request.onsuccess = function() {
                                    console.log('[æ¸…ç†] åˆ é™¤ IndexedDB:', dbName);
                                    resolveDB();
                                };
                                request.onerror = function() {
                                    console.log('[æ¸…ç†] IndexedDB ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥:', dbName);
                                    resolveDB();
                                };
                                request.onblocked = function() {
                                    console.log('[æ¸…ç†] IndexedDB åˆ é™¤è¢«é˜»æ­¢:', dbName);
                                    resolveDB();
                                };
                            });
                        });
                        Promise.all(deletePromises).then(resolve);
                    } catch (e) {
                        console.error('[æ¸…ç†] æ¸…ç† IndexedDB å¤±è´¥:', e);
                        resolve();
                    }
                }));
            }
            
            // æ‰§è¡Œæ‰€æœ‰æ¸…ç†æ­¥éª¤
            Promise.all(cleanupSteps).then(function() {
                console.log('[æ¸…ç†] æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†å·²æ¸…ç†å®Œæˆ');
                
                if (installStatus) {
                    installStatus.textContent = 'âœ“ æ¸…ç†å®Œæˆï¼å³å°†åˆ·æ–°';
                    installStatus.className = 'cache-status success';
                }
                if (dataToolsStatus) {
                    dataToolsStatus.textContent = 'âœ“ æ¸…ç†å®Œæˆï¼å³å°†åˆ·æ–°';
                    dataToolsStatus.className = 'cache-status success';
                }
                
                // ç«‹å³åˆ·æ–°é¡µé¢
                setTimeout(function() {
                    window.location.reload(true);
                }, 0);
            }).catch(function(err) {
                console.error('[æ¸…ç†] æ¸…ç†è¿‡ç¨‹å‡ºé”™:', err);
                if (installStatus) {
                    installStatus.textContent = 'âš  éƒ¨åˆ†æ¸…ç†å®Œæˆï¼Œé¡µé¢å³å°†åˆ·æ–°';
                    installStatus.className = 'cache-status warning';
                }
                if (dataToolsStatus) {
                    dataToolsStatus.textContent = 'âš  éƒ¨åˆ†æ¸…ç†å®Œæˆï¼Œé¡µé¢å³å°†åˆ·æ–°';
                    dataToolsStatus.className = 'cache-status warning';
                }
                // å³ä½¿å‡ºé”™ä¹Ÿåˆ·æ–°é¡µé¢
                setTimeout(function() {
                    window.location.reload(true);
                }, 0);
            });
        }
    });
    </script>
</body>
</html>
