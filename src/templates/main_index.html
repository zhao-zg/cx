<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç‰¹ä¼šä¿¡æ¯åˆé›† - æ‰€æœ‰è®­ç»ƒæ€»è§ˆ">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="trainings.json" as="fetch" crossorigin>
    <title>ç‰¹ä¼šä¿¡æ¯åˆé›†</title>
    <style>
        :root{--brand:#667eea;--brand-dark:#5B67D4;--bg:linear-gradient(135deg,#667EEA,#5B67D4);--surface:#fff;--surface-alt:#f3f5f9;--page-bg:#f6f7fb;--header-bg:var(--brand);--nav-hover:#f7f9ff;--scripture-bg:#f6f7fa;--muted:#f8f9fa;--border:#e6e8f0;--text:#2f343a;--text-soft:#596170;--text-muted:#7b8697;--heading:#1b2436;--heading-strong:#141c2b;--heading-soft:#2a3954;--heading-muted:#3a4a67;--radius-sm:6px;--radius-md:8px;--shadow-sm:0 1px 4px rgba(0,0,0,.06);--shadow-md:0 6px 16px rgba(0,0,0,.08)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;line-height:1.6;color:#2d3748;background:#f7fafc;min-height:100vh;padding:12px}
        .container{max-width:800px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
        .header{background:var(--header-bg);color:#fff;text-align:center;padding:20px 16px}
        .header h1{font-size:25px;margin-bottom:8px;font-weight:600}
        .header p{font-size:16px;opacity:.9}
        .content{padding:0}
        .trainings-grid{display:flex;flex-direction:column;gap:0;margin:0;background:#fff;overflow:hidden}
        .training-card{background:#fff;overflow:hidden;border-bottom:1px solid #e8e8e8;transition:background-color .2s}
        .training-card:hover{background:#fafbfc}
        .training-card:last-child{border-bottom:none}
        .training-card-wrapper{display:flex;align-items:stretch;gap:0}
        .training-link{display:block;padding:12px 16px;text-decoration:none;color:inherit;flex:1;min-width:0;transition:background-color .2s}
        .training-link:active{background:#f0f4f8}
        .training-info{position:relative}
        .training-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:8px}
        /* éª¨æ¶å± */
        .skeleton-item{padding:16px;border-bottom:1px solid #e8e8e8}
        .skeleton-line{height:18px;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;margin-bottom:8px}
        .skeleton-line.short{width:30%;height:14px}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .training-card .year-season {
            font-size: 17px;
            color: var(--brand);
            font-weight: 600;
            flex-shrink: 0;
            line-height: 1.3;
        }
        
        .training-card .info {
            color: #a0aec0;
            font-size: 16px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .training-title-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0;
        }
        
        .training-card .title {
            font-size: 19px;
            color: #2d3748;
            line-height: 1.5;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            min-height: 32px;
            white-space: nowrap;
        }
        
        
        
        .footer {
            text-align: center;
            padding: 16px;
            color: #999;
            background: #f5f7fa;
            border-top: 1px solid #e0e0e0;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
        }
        
        /* ç¼“å­˜æŒ‰é’® */
        .cache-section {
            padding: 12px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            display: none;
        }
        
        .cache-section.show {
            display: block;
        }
        
        .cache-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: var(--bg);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: 40px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            margin: 4px;
        }
        
        .cache-btn:active {
            transform: scale(0.97);
        }
        
        .cache-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .cache-btn.cached {
            background: #48bb78;
        }
        
        .clear-btn {
            background: #e53e3e;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }
        
        .cache-icon {
            font-size: 16px;
        }
        
        .cache-status {
            margin-top: 8px;
            font-size: 13px;
            color: #666;
            padding: 0 16px;
        }
        
        .cache-status.success {
            color: #48bb78;
        }
        
        .cache-status.error {
            color: #e53e3e;
        }
        
        @media (max-width: 480px) {
            .cache-section {
                padding: 12px 8px;
            }
            
            .cache-btn {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 36px;
                margin: 3px;
            }
            
            .cache-icon {
                font-size: 14px;
            }
            
            .cache-status {
                font-size: 12px;
                padding: 0 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="mainLogo" style="cursor: pointer; user-select: none;">ğŸ  ç‰¹ä¼šä¿¡æ¯åˆé›†</h1>
            <p>Conference Information Collections</p>
        </div>
        
        <div class="content">
            <div class="trainings-grid" id="trainingsGrid">
                <!-- éª¨æ¶å± - åŠ è½½æ—¶æ˜¾ç¤º -->
                <div class="skeleton-item"><div class="skeleton-line" style="width:60%"></div><div class="skeleton-line short"></div></div>
                <div class="skeleton-item"><div class="skeleton-line" style="width:70%"></div><div class="skeleton-line short"></div></div>
                <div class="skeleton-item"><div class="skeleton-line" style="width:55%"></div><div class="skeleton-line short"></div></div>
            </div>
        </div>
        
        <!-- å®‰è£…æŒ‰é’®åŒºåŸŸ -->
        <div class="cache-section" id="installSection">
            <button class="cache-btn install-btn" id="installBtn" style="display:none;">
                <span class="cache-icon">ğŸ“²</span>
                <span class="cache-text">å®‰è£…åˆ°æ¡Œé¢</span>
            </button>
            <button class="cache-btn" id="androidApkBtn" style="display:none; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                <span class="cache-icon">ğŸ“±</span>
                <span class="cache-text">å®‰å“ç¦»çº¿ç‰ˆ</span>
            </button>
            <div class="cache-status" id="installStatus"></div>
        </div>

        <!-- æ•°æ®å·¥å…·åŒºåŸŸ -->
        <div class="cache-section" id="dataToolsSection" style="display: none;">
            <button class="cache-btn" id="clearDataBtn">
                <span class="cache-icon">ğŸ§¹</span>
                <span class="cache-text">æ¸…ç†æ•°æ®</span>
            </button>
            <button class="cache-btn" id="cacheAllBtn">
                <span class="cache-icon">ğŸ“¦</span>
                <span class="cache-text">ç¼“å­˜æ•°æ®</span>
            </button>
            <div class="cache-status" id="dataToolsStatus"></div>
        </div>
        
        <!-- æ£€æŸ¥æ›´æ–°æŒ‰é’®ï¼ˆä»…åœ¨ APP å†…æ˜¾ç¤ºï¼‰ -->
        <div class="cache-section" id="updateSection" style="display: none;">
            <button class="cache-btn" id="checkUpdateBtn">
                <span class="cache-icon">ğŸ”„</span>
                <span class="cache-text">æ£€æŸ¥æ›´æ–°</span>
            </button>
            <div class="cache-status" id="updateStatus"></div>
        </div>
        
        <div class="footer">
            <p>æœ¬ç«™å†…å®¹ä»…ä¾›ä¸»æ¢å¤åœ£å¾’äº¤é€šä½¿ç”¨</p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                ç”Ÿæˆæ—¶é—´: {{ generation_time }}
            </p>
        </div>
    </div>
    
    <!-- JSZip åº“ç”¨äºè§£å‹æ›´æ–°åŒ… -->
    <script src="vendor/jszip.min.js"></script>
    
    <!-- APK æ›´æ–°åŠŸèƒ½æ¨¡å— -->
    <script src="js/app-update.js"></script>
    
    <script>
    // ä¸»é¢˜é¢œè‰²å¸¸é‡ - ç”¨äºåŠ¨æ€ç”Ÿæˆçš„ HTML
    var THEME = {
        brand: '#667eea',
        brandDark: '#5b7ce6',
        bg: 'linear-gradient(135deg, #667eea 0%, #5b7ce6 100%)',
        success: '#48bb78',
        successDark: '#38a169'
    };
    
    // è‡ªåŠ¨è®¾ç½® APK ç‰ˆæœ¬ï¼ˆç”¨äºç¦»çº¿ç‰ˆï¼‰
    (function() {
        // æ£€æµ‹æ˜¯å¦åœ¨ Capacitor æˆ– PWA ç¯å¢ƒä¸­
        var isCapacitor = window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.App;
        var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isCapacitor || isPWA) {
            if (isCapacitor) {
                window.Capacitor.Plugins.App.getInfo().then(function(info) {
                    if (info.version) {
                        localStorage.setItem('cx_apk_version', info.version);
                        console.log('ä» Capacitor è·å–ç‰ˆæœ¬:', info.version, 'åŒ…å:', info.id);
                    }
                }).catch(function(err) {
                    console.log('æ— æ³•è·å– App ä¿¡æ¯:', err);
                });
            }
            
            // ä½¿ç”¨å¯¼èˆªæ ˆæ¥è¿½è¸ªå†å²
            var navKey = 'cx_nav_stack';
            var navStack = JSON.parse(sessionStorage.getItem(navKey) || '[]');
            var currentPath = window.location.pathname + window.location.search + window.location.hash;
            var isNewSession = navStack.length === 0;
            var maxNavStack = 12;

            function trimNavStack(stack) {
                if (stack.length > maxNavStack) {
                    return stack.slice(stack.length - maxNavStack);
                }
                return stack;
            }
            
            // å¦‚æœæ ˆé¡¶ä¸æ˜¯å½“å‰é¡µé¢ï¼Œå‹å…¥æ ˆï¼ˆæ–°ä¼šè¯æ—¶å»¶è¿Ÿå‹å…¥ï¼Œç­‰é¡µé¢è®°å¿†æ£€æŸ¥å®Œï¼‰
            if (!isNewSession && navStack[navStack.length - 1] !== currentPath) {
                navStack.push(currentPath);
                navStack = trimNavStack(navStack);
                sessionStorage.setItem(navKey, JSON.stringify(navStack));
            }
            
            // ç›‘å¬è¿”å›é”® - ä¸»é¡µé€€å‡ºåº”ç”¨
            if (isCapacitor) {
                window.Capacitor.Plugins.App.addListener('backButton', function(data) {
                    // é‡æ–°è¯»å–æ ˆ
                    navStack = JSON.parse(sessionStorage.getItem(navKey) || '[]');
                    
                    // å¼¹å‡ºå½“å‰é¡µé¢
                    navStack.pop();
                    sessionStorage.setItem(navKey, JSON.stringify(navStack));
                    
                    if (navStack.length > 0) {
                        // æ ˆé‡Œè¿˜æœ‰é¡µé¢ï¼Œåé€€
                        window.history.back();
                    } else {
                        // æ ˆç©ºäº†ï¼Œä¸»é¡µé€€å‡ºåº”ç”¨
                        sessionStorage.removeItem(navKey);
                        // æ¸…é™¤é¡µé¢è®°å¿†ï¼Œä¸‹æ¬¡é‡è¿›ä»ä¸»é¡µå¼€å§‹
                        localStorage.removeItem('cx_last_page');
                        localStorage.removeItem('cx_last_page_time');
                        window.Capacitor.Plugins.App.exitApp();
                    }
                });
            }
        }
    })();
    
    // åŠ¨æ€åŠ è½½è®­ç»ƒåˆ—è¡¨
    (function() {
        console.log('[è®­ç»ƒåˆ—è¡¨] å¼€å§‹åŠ è½½');
        
        // ä» APK å†…ç½®åŠ è½½
        loadTrainingsFromBundle();
        
        // ä» APK å†…ç½®åŠ è½½
        function loadTrainingsFromBundle() {
            console.log('[è®­ç»ƒåˆ—è¡¨] ä» APK å†…ç½®åŠ è½½');
            return fetch('trainings.json?t=' + Date.now())
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log('[è®­ç»ƒåˆ—è¡¨] APK å†…ç½®ç‰ˆæœ¬:', data.version);
                    renderTrainings(data);
                })
                .catch(function(error) {
                    console.error('[è®­ç»ƒåˆ—è¡¨] APK å†…ç½®åŠ è½½å¤±è´¥:', error);
                    showLoadError();
                });
        }
        
        // æ¸²æŸ“è®­ç»ƒåˆ—è¡¨
        function renderTrainings(data) {
            var grid = document.getElementById('trainingsGrid');
            if (!grid) return;
            
            var trainings = data.trainings || [];
            window.__cxTrainings = trainings;
            if (trainings.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— è®­ç»ƒå†…å®¹</div>';
                return;
            }
            
            var html = '';
            trainings.forEach(function(training) {
                html += '<div class="training-card">';
                html += '<div class="training-card-wrapper">';
                html += '<a href="' + training.path + '/index.html" class="training-link">';
                html += '<div class="training-info">';
                html += '<div class="training-header">';
                html += '<div class="year-season">' + training.year + 'å¹´' + training.season.split(' ')[0] + '</div>';
                html += '<div class="info">å…± ' + training.chapter_count + ' ç¯‡</div>';
                html += '</div>';
                html += '<div class="training-title-row">';
                html += '<div class="title">' + training.title + '</div>';
                html += '<span class="arrow">â†’</span>';
                html += '</div>';
                html += '</div>';
                html += '</a>';
                html += '</div>';
                html += '</div>';
            });
            
            grid.innerHTML = html;
            
            // PWA æ¨¡å¼ä¸‹ä»…æ˜¾ç¤ºæ•°æ®å·¥å…·åŒº
            var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
            if (isStandalone) {
                var dataToolsSection = document.getElementById('dataToolsSection');
                if (dataToolsSection) {
                    dataToolsSection.style.display = 'flex';
                    dataToolsSection.classList.add('show');
                }
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½é”™è¯¯
        function showLoadError() {
            var grid = document.getElementById('trainingsGrid');
            if (!grid) return;
            
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53e3e;">';
            grid.innerHTML += '<div style="font-size: 24px; margin-bottom: 10px;">âŒ</div>';
            grid.innerHTML += '<div>åŠ è½½è®­ç»ƒåˆ—è¡¨å¤±è´¥</div>';
            grid.innerHTML += '<button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: ' + THEME.brand + '; color: white; border: none; border-radius: 6px; cursor: pointer;">é‡è¯•</button>';
            grid.innerHTML += '</div>';
        }
    })();
    
    // APK æ£€æµ‹å’Œæ›´æ–°åŠŸèƒ½
    (function() {
        var isAndroid = /Android/i.test(navigator.userAgent);
        var isInApp = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true;
        
        // æ£€æµ‹æ˜¯å¦åœ¨ Capacitor WebView ä¸­
        var isCapacitor = window.Capacitor !== undefined;
        
        // æ£€æµ‹ URL schemeï¼ˆCapacitor ä½¿ç”¨ capacitor:// æˆ– http://localhostï¼‰
        var isCapacitorScheme = window.location.protocol === 'capacitor:' || 
                                (window.location.hostname === 'localhost' && window.location.protocol === 'http:');
        
        console.log('APK æ£€æµ‹åˆå§‹åŒ–:', {
            isAndroid: isAndroid,
            isInApp: isInApp,
            isCapacitor: isCapacitor,
            isCapacitorScheme: isCapacitorScheme,
            userAgent: navigator.userAgent,
            displayMode: window.matchMedia('(display-mode: standalone)').matches,
            protocol: window.location.protocol,
            hostname: window.location.hostname
        });
        
        // æ£€æŸ¥æ›´æ–°æŒ‰é’®åªåœ¨ Capacitor APK ç¯å¢ƒæ˜¾ç¤ºï¼ˆä¸åœ¨ PWA ä¸­æ˜¾ç¤ºï¼‰
        // å¿…é¡»åŒæ—¶æ»¡è¶³ï¼šisCapacitor æˆ– isCapacitorSchemeï¼ˆæ’é™¤çº¯ PWA standalone æ¨¡å¼ï¼‰
        if (isAndroid && (isCapacitor || isCapacitorScheme)) {
            // æ˜¾ç¤ºæ£€æŸ¥æ›´æ–°æŒ‰é’®
            var updateSection = document.getElementById('updateSection');
            var checkUpdateBtn = document.getElementById('checkUpdateBtn');
            var updateStatus = document.getElementById('updateStatus');
            
            if (updateSection && checkUpdateBtn) {
                updateSection.style.display = 'block';
                
                checkUpdateBtn.addEventListener('click', function() {
                    // æ˜¾ç¤ºå®Œæ•´çš„æ›´æ–°æ£€æŸ¥å¯¹è¯æ¡†
                    showCloudflareUpdateDialog();
                });
            }
            
            // éšè—å…¥å£ï¼šç‚¹å‡» Logo 8 æ¬¡ + å¯†ç éªŒè¯ï¼ˆç”¨äº GitHub Release ä¸‹è½½ï¼‰
            var clickCount = 0;
            var clickTimer = null;
            var logo = document.getElementById('mainLogo');
            
            console.log('APK æ›´æ–°æ£€æŸ¥å·²å¯ç”¨ï¼Œç‚¹å‡» Logo 8 æ¬¡è§¦å‘éšè—å…¥å£');
            
            if (logo) {
                logo.addEventListener('click', function() {
                    clickCount++;
                    console.log('Logo ç‚¹å‡»:', clickCount, '/8');
                    
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(function() {
                        console.log('ç‚¹å‡»è®¡æ•°é‡ç½®');
                        clickCount = 0;
                    }, 5000);
                    
                    // ç‚¹å‡» 8 æ¬¡è§¦å‘å¯†ç éªŒè¯
                    if (clickCount >= 8) {
                        clickCount = 0;
                        if (clickTimer) clearTimeout(clickTimer);
                        console.log('=== è§¦å‘å¯†ç éªŒè¯ ===');
                        
                        // å¼¹å‡ºå¯†ç è¾“å…¥æ¡†
                        var password = prompt('è¯·è¾“å…¥ç®¡ç†å¯†ç ï¼š');
                        if (password === '1189') {
                            console.log('å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºæ›´æ–°æ£€æŸ¥');
                            showGitHubUpdateDialog();
                        } else if (password !== null) {
                            alert('å¯†ç é”™è¯¯');
                        }
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ° mainLogo å…ƒç´ ');
            }
        } else {
            console.log('APK æ›´æ–°æ£€æŸ¥æœªå¯ç”¨ï¼ˆéå®‰å“ APP ç¯å¢ƒï¼‰');
        }
        
        // Cloudflare Pages æ›´æ–°æ£€æŸ¥é…ç½®
        var CLOUDFLARE_UPDATE_URL = 'https://cx.zhaozg.cloudns.org/version.json';
        var CLOUDFLARE_APK_BASE = 'https://cx.zhaozg.cloudns.org/';
        
        // Cloudflare æ›´æ–°æ£€æŸ¥å¯¹è¯æ¡†ï¼ˆä¸»é¡µåº•éƒ¨æŒ‰é’®ï¼‰
        function showCloudflareUpdateDialog() {
            console.log('[æ›´æ–°æ£€æŸ¥] æ˜¾ç¤º Cloudflare æ›´æ–°å¯¹è¯æ¡†');
            
            // åˆ›å»ºå¯¹è¯æ¡†
            var html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="cloudflareUpdateDialog">';
            html += '<div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;">';
            html += '<h3 style="color: ' + THEME.brand + '; margin-bottom: 15px; font-size: 20px; text-align: center;">ğŸ”„ æ£€æŸ¥æ›´æ–°</h3>';
            
            // APK ç‰ˆæœ¬æ£€æŸ¥åŒºåŸŸ
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 8px; border: 1px solid #e0e4ff;">';
            html += '<h4 style="color: ' + THEME.brand + '; margin-bottom: 10px; font-size: 16px;">ğŸ“± åº”ç”¨ç‰ˆæœ¬</h4>';
            html += '<div id="cfCheckStatus" style="color: #666; font-size: 14px;">æ­£åœ¨æ£€æŸ¥...</div>';
            html += '<button id="cfUpdateBtn" style="display: none; width: 100%; padding: 10px; margin-top: 10px; background: ' + THEME.bg + '; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">ç«‹å³æ›´æ–°åº”ç”¨</button>';
            html += '</div>';
            
            html += '<button style="width: 100%; padding: 12px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;" onclick="document.getElementById(\'cloudflareUpdateDialog\').remove();">å…³é—­</button>';
            html += '</div></div>';
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // æ£€æŸ¥æ›´æ–°
            checkCloudflareUpdateStatus();
        }
        
        // æ£€æŸ¥ Cloudflare æ›´æ–°çŠ¶æ€
        function checkCloudflareUpdateStatus() {
            var statusEl = document.getElementById('cfCheckStatus');
            var btnEl = document.getElementById('cfUpdateBtn');
            
            if (!statusEl || !btnEl) {
                console.error('[æ›´æ–°æ£€æŸ¥] æ‰¾ä¸åˆ°çŠ¶æ€å…ƒç´ ');
                return;
            }
            
            getCurrentApkVersion().then(function(currentVersion) {
                statusEl.innerHTML = 'å½“å‰ç‰ˆæœ¬: ' + currentVersion + '<br>æ­£åœ¨æ£€æŸ¥è¿œç¨‹ç‰ˆæœ¬...';
                
                return fetch(CLOUDFLARE_UPDATE_URL + '?t=' + Date.now(), { cache: 'no-cache' })
                    .then(function(response) {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return response.json();
                    })
                    .then(function(versionInfo) {
                        console.log('[æ›´æ–°æ£€æŸ¥] è¿œç¨‹ç‰ˆæœ¬ä¿¡æ¯:', versionInfo);
                        
                        var latestVersion = versionInfo.apk_version || versionInfo.version || 'æœªçŸ¥';
                        var apkFile = versionInfo.apk_file || ('TeHui-v' + latestVersion + '.apk');
                        var apkSize = versionInfo.apk_size;
                        var currentVersionClean = currentVersion.replace('v', '');
                        var latestVersionClean = latestVersion.replace('v', '');
                        
                        var downloadUrl = CLOUDFLARE_APK_BASE + apkFile;
                        var comparison = compareVersion(latestVersionClean, currentVersionClean);
                        var sizeText = apkSize ? ' (' + (apkSize / 1024 / 1024).toFixed(1) + ' MB)' : '';
                        
                        if (comparison > 0) {
                            statusEl.innerHTML = 'âœ… å‘ç°æ–°ç‰ˆæœ¬<br>å½“å‰: v' + currentVersionClean + '<br>æœ€æ–°: v' + latestVersionClean + sizeText;
                            btnEl.style.display = 'block';
                            btnEl.textContent = 'ç«‹å³æ›´æ–°' + sizeText;
                            btnEl.onclick = function() {
                                console.log('[APKæ›´æ–°] å¼€å§‹ä¸‹è½½:', downloadUrl);
                                downloadApk(downloadUrl);
                            };
                        } else if (comparison === 0) {
                            statusEl.innerHTML = 'âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬<br>ç‰ˆæœ¬: v' + currentVersionClean;
                            btnEl.style.display = 'block';
                            btnEl.textContent = 'é‡æ–°ä¸‹è½½' + sizeText;
                            btnEl.onclick = function() {
                                console.log('[APKæ›´æ–°] é‡æ–°ä¸‹è½½:', downloadUrl);
                                downloadApk(downloadUrl);
                            };
                        } else if (comparison === null) {
                            statusEl.innerHTML = 'âš ï¸ æ— æ³•æ¯”è¾ƒç‰ˆæœ¬<br>å½“å‰: ' + currentVersion + '<br>æœ€æ–°: v' + latestVersionClean;
                            btnEl.style.display = 'block';
                            btnEl.textContent = 'ä¸‹è½½æœ€æ–°ç‰ˆ' + sizeText;
                            btnEl.onclick = function() {
                                console.log('[APKæ›´æ–°] ä¸‹è½½æœ€æ–°ç‰ˆ:', downloadUrl);
                                downloadApk(downloadUrl);
                            };
                        } else {
                            statusEl.innerHTML = 'å½“å‰: v' + currentVersionClean + '<br>è¿œç¨‹: v' + latestVersionClean;
                        }
                    });
            }).catch(function(error) {
                console.error('[æ›´æ–°æ£€æŸ¥] å¤±è´¥:', error);
                statusEl.innerHTML = 'âŒ æ£€æŸ¥å¤±è´¥: ' + error.message;
            });
        }
        
        // GitHub Release æ›´æ–°æ£€æŸ¥å¯¹è¯æ¡†ï¼ˆéšè—å…¥å£ï¼‰
        function showGitHubUpdateDialog() {
            console.log('[æ›´æ–°æ£€æŸ¥] æ˜¾ç¤º GitHub æ›´æ–°å¯¹è¯æ¡†');
            
            // åˆ›å»ºå¯¹è¯æ¡†
            var html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="githubUpdateDialog">';
            html += '<div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;">';
            html += '<h3 style="color: ' + THEME.brand + '; margin-bottom: 15px; font-size: 20px; text-align: center;">ğŸ”„ æ£€æŸ¥æ›´æ–° (GitHub)</h3>';
            
            // APK ç‰ˆæœ¬æ£€æŸ¥åŒºåŸŸ
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 8px; border: 1px solid #e0e4ff;">';
            html += '<h4 style="color: ' + THEME.brand + '; margin-bottom: 10px; font-size: 16px;">ğŸ“± åº”ç”¨ç‰ˆæœ¬</h4>';
            html += '<div id="ghCheckStatus" style="color: #666; font-size: 14px;">æ­£åœ¨æ£€æŸ¥...</div>';
            html += '<button id="ghUpdateBtn" style="display: none; width: 100%; padding: 10px; margin-top: 10px; background: ' + THEME.bg + '; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">ç«‹å³æ›´æ–°åº”ç”¨</button>';
            html += '</div>';
            
            html += '<button style="width: 100%; padding: 12px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;" onclick="document.getElementById(\'githubUpdateDialog\').remove();">å…³é—­</button>';
            html += '</div></div>';
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // æ£€æŸ¥ APK æ›´æ–°
            checkGitHubUpdateStatus();
        }
        
        // æ£€æŸ¥ GitHub æ›´æ–°çŠ¶æ€
        function checkGitHubUpdateStatus() {
            var statusEl = document.getElementById('ghCheckStatus');
            var btnEl = document.getElementById('ghUpdateBtn');
            
            if (!statusEl || !btnEl) {
                console.error('[æ›´æ–°æ£€æŸ¥] æ‰¾ä¸åˆ°çŠ¶æ€å…ƒç´ ');
                return;
            }
            
            getCurrentApkVersion().then(function(currentVersion) {
                statusEl.innerHTML = 'å½“å‰ç‰ˆæœ¬: ' + currentVersion + '<br>æ­£åœ¨æ£€æŸ¥è¿œç¨‹ç‰ˆæœ¬...';
                
                return fetch('https://api.github.com/repos/zhao-zg/cx/releases/latest')
                    .then(function(response) {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return response.json();
                    })
                    .then(function(release) {
                        var latestVersion = release.tag_name.replace('v', '');
                        var currentVersionClean = currentVersion.replace('v', '');
                        var comparison = compareVersion(latestVersion, currentVersionClean);
                        
                        // æŸ¥æ‰¾ APK æ–‡ä»¶
                        var apk = release.assets.find(function(a) {
                            return a.name.endsWith('.apk');
                        });
                        
                        var sizeText = apk ? ' (' + (apk.size / 1024 / 1024).toFixed(1) + ' MB)' : '';
                        
                        if (comparison > 0) {
                            statusEl.innerHTML = 'âœ… å‘ç°æ–°ç‰ˆæœ¬<br>å½“å‰: v' + currentVersionClean + '<br>æœ€æ–°: ' + release.tag_name + sizeText;
                            if (apk) {
                                btnEl.style.display = 'block';
                                btnEl.textContent = 'ç«‹å³æ›´æ–°' + sizeText;
                                btnEl.onclick = function() {
                                    console.log('[APKæ›´æ–°] å¼€å§‹ä¸‹è½½:', apk.browser_download_url);
                                    downloadApk(apk.browser_download_url);
                                };
                            } else {
                                statusEl.innerHTML += '<br>âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶';
                            }
                        } else if (comparison === 0) {
                            statusEl.innerHTML = 'âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬<br>ç‰ˆæœ¬: v' + currentVersionClean;
                            if (apk) {
                                btnEl.style.display = 'block';
                                btnEl.textContent = 'é‡æ–°ä¸‹è½½' + sizeText;
                                btnEl.onclick = function() {
                                    console.log('[APKæ›´æ–°] é‡æ–°ä¸‹è½½:', apk.browser_download_url);
                                    downloadApk(apk.browser_download_url);
                                };
                            }
                        } else if (comparison === null) {
                            statusEl.innerHTML = 'âš ï¸ æ— æ³•æ¯”è¾ƒç‰ˆæœ¬<br>å½“å‰: ' + currentVersion + '<br>æœ€æ–°: ' + release.tag_name;
                            if (apk) {
                                btnEl.style.display = 'block';
                                btnEl.textContent = 'ä¸‹è½½æœ€æ–°ç‰ˆ' + sizeText;
                                btnEl.onclick = function() {
                                    console.log('[APKæ›´æ–°] ä¸‹è½½æœ€æ–°ç‰ˆ:', apk.browser_download_url);
                                    downloadApk(apk.browser_download_url);
                                };
                            }
                        } else {
                            statusEl.innerHTML = 'å½“å‰: v' + currentVersionClean + '<br>è¿œç¨‹: ' + release.tag_name;
                        }
                    });
            }).catch(function(error) {
                console.error('[æ›´æ–°æ£€æŸ¥] å¤±è´¥:', error);
                statusEl.innerHTML = 'âŒ æ£€æŸ¥å¤±è´¥: ' + error.message;
            });
        }
        
        // è·å–å½“å‰ APK ç‰ˆæœ¬ï¼ˆå¼‚æ­¥ï¼‰
        function getCurrentApkVersion() {
            return new Promise(function(resolve) {
                // å…ˆå°è¯•ä» localStorage è·å–
                var cachedVersion = localStorage.getItem('cx_apk_version');
                
                // å¦‚æœåœ¨ Capacitor ç¯å¢ƒä¸­ï¼Œå°è¯•å®æ—¶è·å–
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.App) {
                    window.Capacitor.Plugins.App.getInfo().then(function(info) {
                        if (info.version) {
                            localStorage.setItem('cx_apk_version', info.version);
                            console.log('ä» Capacitor å®æ—¶è·å–ç‰ˆæœ¬:', info.version, 'åŒ…å:', info.id);
                            resolve(info.version);
                        } else {
                            console.log('Capacitor æœªè¿”å›ç‰ˆæœ¬å·ï¼Œä½¿ç”¨ç¼“å­˜:', cachedVersion || 'æœªçŸ¥');
                            resolve(cachedVersion || 'æœªçŸ¥');
                        }
                    }).catch(function(err) {
                        console.log('è·å– Capacitor ç‰ˆæœ¬å¤±è´¥:', err, 'ä½¿ç”¨ç¼“å­˜:', cachedVersion || 'æœªçŸ¥');
                        resolve(cachedVersion || 'æœªçŸ¥');
                    });
                } else {
                    // é Capacitor ç¯å¢ƒï¼Œç›´æ¥è¿”å›ç¼“å­˜
                    console.log('é Capacitor ç¯å¢ƒï¼Œå½“å‰ç‰ˆæœ¬:', cachedVersion || 'æœªçŸ¥');
                    resolve(cachedVersion || 'æœªçŸ¥');
                }
            });
        }
        
        // æ¯”è¾ƒç‰ˆæœ¬å·
        // è¿”å›å€¼ï¼š1 = v1 > v2, -1 = v1 < v2, 0 = v1 == v2, null = æ— æ³•æ¯”è¾ƒï¼ˆç‰ˆæœ¬æœªçŸ¥ï¼‰
        function compareVersion(v1, v2) {
            if (v1 === 'æœªçŸ¥' || v2 === 'æœªçŸ¥') return null;
            
            var parts1 = v1.replace('v', '').split('.').map(Number);
            var parts2 = v2.replace('v', '').split('.').map(Number);
            
            for (var i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                var p1 = parts1[i] || 0;
                var p2 = parts2[i] || 0;
                if (p1 > p2) return 1;
                if (p1 < p2) return -1;
            }
            return 0;
        }
        
        // æ£€æŸ¥ APK æ›´æ–°
        function checkApkUpdate() {
            console.log('å¼€å§‹æ£€æŸ¥ APK æ›´æ–°...');
            
            // å¼‚æ­¥è·å–å½“å‰ç‰ˆæœ¬
            getCurrentApkVersion().then(function(currentVersion) {
                console.log('å½“å‰ç‰ˆæœ¬:', currentVersion);
                
                return fetch('https://api.github.com/repos/zhao-zg/cx/releases/latest')
                    .then(function(response) {
                        console.log('GitHub API å“åº”çŠ¶æ€:', response.status);
                        if (!response.ok) throw new Error('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯: ' + response.status);
                        return response.json();
                    })
                    .then(function(release) {
                        console.log('è·å–åˆ° Release ä¿¡æ¯:', {
                            tag: release.tag_name,
                            assetsCount: release.assets.length
                        });
                        
                        // æŸ¥æ‰¾ç¦»çº¿ç‰ˆ APK æ–‡ä»¶
                        var apk = release.assets.find(function(a) {
                            return a.name.endsWith('.apk');
                        });
                        
                        if (!apk) {
                            console.warn('æœªæ‰¾åˆ° APK æ–‡ä»¶');
                            alert('æœªæ‰¾åˆ°å¯ç”¨çš„ APK æ–‡ä»¶');
                            return;
                        }
                        
                        // æ¯”è¾ƒç‰ˆæœ¬
                        var latestVersion = release.tag_name.replace('v', '');
                        var currentVersionClean = currentVersion.replace('v', '');
                        var comparison = compareVersion(latestVersion, currentVersionClean);
                        
                        console.log('ç‰ˆæœ¬æ¯”è¾ƒ:', {
                            current: currentVersion,
                            latest: latestVersion,
                            comparison: comparison
                        });
                        
                        // æ˜¾ç¤ºæ›´æ–°å¯¹è¯æ¡†
                        showApkUpdateDialog(release, apk, currentVersion, comparison);
                    });
            }).catch(function(error) {
                console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
                alert('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + error.message);
            });
        }
        
    // ==================== APK ä¸‹è½½åŠŸèƒ½ ====================
    
    // ä¸‹è½½ APKï¼ˆä½¿ç”¨ AppUpdate æ¨¡å—ï¼‰
    window.downloadApk = function(url) {
        console.log('[APKä¸‹è½½] å¼€å§‹ä¸‹è½½:', url);
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ Capacitor ç¯å¢ƒ
        if (!window.Capacitor || !window.Capacitor.Plugins) {
            console.log('[APKä¸‹è½½] é Capacitor ç¯å¢ƒï¼Œä½¿ç”¨æµè§ˆå™¨ä¸‹è½½');
            var link = document.createElement('a');
            link.href = url;
            link.download = url.split('/').pop();
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(function() {
                document.body.removeChild(link);
            }, 100);
            return;
        }
        
        // ä½¿ç”¨ AppUpdate æ¨¡å—ä¸‹è½½
        if (!window.AppUpdate) {
            alert('AppUpdate æ¨¡å—æœªåŠ è½½');
            return;
        }
        
        // æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
        showApkDownloadProgress('æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 0, 0, 0);
        
        window.AppUpdate.downloadApk(
            url,
            // onProgress: function(message, progress, speed, downloaded)
            function(message, progress, speed, downloaded) {
                updateApkDownloadProgress(message, progress, speed, downloaded);
            },
            // onComplete
            function() {
                setTimeout(function() {
                    closeApkDownloadProgress();
                }, 500);
            },
            // onError
            function(error) {
                closeApkDownloadProgress();
                if (confirm('APK ä¸‹è½½å¤±è´¥\n\n' + error.message + '\n\næ˜¯å¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸‹è½½é“¾æ¥ï¼Ÿ')) {
                    window.open(url, '_blank');
                }
            }
        );
    };
    
    // APK ä¸‹è½½è¿›åº¦å¯¹è¯æ¡†
    function showApkDownloadProgress(message, progress, speed, downloaded) {
        var dialogId = 'apkDownloadProgressDialog';
        var oldDialog = document.getElementById(dialogId);
        if (oldDialog) oldDialog.remove();
        
            var html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;" id="' + dialogId + '">';
            html += '<div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%;">';
            html += '<h3 style="color: ' + THEME.brand + '; margin-bottom: 15px; font-size: 18px; text-align: center;">ğŸ“± æ­£åœ¨ä¸‹è½½ APK</h3>';
            html += '<p style="color: #666; margin-bottom: 10px; text-align: center; font-size: 14px;" id="apkProgressMessage">' + message + '</p>';
            
            // é€Ÿåº¦å’Œå·²ä¸‹è½½ä¿¡æ¯
            html += '<p style="color: #999; margin-bottom: 15px; text-align: center; font-size: 12px;" id="apkProgressInfo">';
            if (speed > 0) {
                html += 'é€Ÿåº¦: ' + speed + ' KB/s';
            }
            if (downloaded > 0) {
                html += ' | å·²ä¸‹è½½: ' + (downloaded / 1024 / 1024).toFixed(2) + ' MB';
            }
            html += '</p>';
            
            // è¿›åº¦æ¡
            html += '<div style="background: #e2e8f0; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 10px;">';
            html += '<div id="apkProgressBar" style="background: ' + THEME.bg + '; height: 100%; width: ' + progress + '%; transition: width 0.3s;"></div>';
            html += '</div>';
            
            html += '<p style="color: #999; text-align: center; font-size: 12px;" id="apkProgressPercent">' + progress + '%</p>';
            html += '</div></div>';
            
            document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function updateApkDownloadProgress(message, progress, speed, downloaded) {
        var msgEl = document.getElementById('apkProgressMessage');
        var barEl = document.getElementById('apkProgressBar');
        var pctEl = document.getElementById('apkProgressPercent');
        var infoEl = document.getElementById('apkProgressInfo');
        
        if (msgEl) msgEl.textContent = message;
        if (barEl) barEl.style.width = progress + '%';
        if (pctEl) pctEl.textContent = progress + '%';
        
        // æ›´æ–°é€Ÿåº¦å’Œå·²ä¸‹è½½ä¿¡æ¯
        if (infoEl) {
            var info = '';
            if (speed > 0) {
                info += 'é€Ÿåº¦: ' + speed + ' KB/s';
            }
            if (downloaded > 0) {
                if (info) info += ' | ';
                info += 'å·²ä¸‹è½½: ' + (downloaded / 1024 / 1024).toFixed(2) + ' MB';
            }
            infoEl.textContent = info || ' ';
        }
    }
    
    function closeApkDownloadProgress() {
        var dialog = document.getElementById('apkDownloadProgressDialog');
        if (dialog) dialog.remove();
    }
    
    // æ˜¾ç¤º APK æ›´æ–°å¯¹è¯æ¡†
    function showApkUpdateDialog(release, apk, currentVersion, comparison) {
            var latestVersion = release.tag_name;
            var isVersionUnknown = (currentVersion === 'æœªçŸ¥');
            
            var html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="apkUpdateDialog">';
            html += '<div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;">';
            
            // æ ‡é¢˜æ ¹æ®ç‰ˆæœ¬æƒ…å†µå˜åŒ–
            if (isVersionUnknown) {
                html += '<h3 style="color: ' + THEME.brand + '; margin-bottom: 15px; font-size: 20px;">ğŸ“± APK ä¸‹è½½</h3>';
            } else if (comparison > 0) {
                html += '<h3 style="color: ' + THEME.brand + '; margin-bottom: 15px; font-size: 20px;">ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬</h3>';
            } else if (comparison === 0) {
                html += '<h3 style="color: ' + THEME.success + '; margin-bottom: 15px; font-size: 20px;">âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬</h3>';
            } else {
                html += '<h3 style="color: ' + THEME.brand + '; margin-bottom: 15px; font-size: 20px;">ğŸ“± ç‰ˆæœ¬ä¿¡æ¯</h3>';
            }
            
            html += '<div style="color: #333; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">';
            html += '<p style="margin-bottom: 10px;">';
            html += '<strong>å½“å‰ç‰ˆæœ¬ï¼š</strong>' + (isVersionUnknown ? 'æœªçŸ¥' : 'v' + currentVersion) + '<br>';
            html += '<strong>æœ€æ–°ç‰ˆæœ¬ï¼š</strong>' + latestVersion;
            html += '</p>';
            
            // æ˜¾ç¤ºç‰ˆæœ¬çŠ¶æ€æç¤º
            if (isVersionUnknown) {
                html += '<div style="background: #fff3cd; padding: 10px; border-radius: 8px; font-size: 13px; text-align: center; color: #856404; margin-bottom: 15px;">';
                html += 'âš ï¸ æ— æ³•è·å–å½“å‰ç‰ˆæœ¬å·<br>å»ºè®®ä¸‹è½½æœ€æ–°ç‰ˆæœ¬';
                html += '</div>';
            } else if (comparison === 0) {
                html += '<div style="background: #e6f7ed; padding: 10px; border-radius: 8px; font-size: 13px; text-align: center; color: ' + THEME.success + '; margin-bottom: 15px;">';
                html += 'âœ¨ æ‚¨ä½¿ç”¨çš„å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬';
                html += '</div>';
            } else if (comparison > 0) {
                html += '<div style="background: #fff3cd; padding: 10px; border-radius: 8px; font-size: 13px; text-align: center; color: #856404; margin-bottom: 15px;">';
                html += 'ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬å¯æ›´æ–°';
                html += '</div>';
            } else if (comparison < 0) {
                html += '<div style="background: #fff3cd; padding: 10px; border-radius: 8px; font-size: 13px; text-align: center; color: #856404; margin-bottom: 15px;">';
                html += 'âš ï¸ æ‚¨çš„ç‰ˆæœ¬æ¯”æœ€æ–°ç‰ˆæœ¬è¿˜æ–°ï¼ˆæµ‹è¯•ç‰ˆï¼‰';
                html += '</div>';
            }
            
            // æ ¹æ®ç‰ˆæœ¬æƒ…å†µæ˜¾ç¤ºä¸åŒçš„æŒ‰é’®
            if (isVersionUnknown || comparison > 0) {
                // ç‰ˆæœ¬æœªçŸ¥æˆ–æœ‰æ–°ç‰ˆæœ¬ï¼Œæ˜¾ç¤º"ç«‹å³ä¸‹è½½/æ›´æ–°"æŒ‰é’®
                var btnText = isVersionUnknown ? 'ğŸ’¾ ç«‹å³ä¸‹è½½' : 'ğŸ’¾ ç«‹å³æ›´æ–°';
                html += '<button style="width: 100%; padding: 12px; margin-bottom: 10px; background: linear-gradient(135deg, ' + THEME.success + ' 0%, ' + THEME.successDark + ' 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;" onclick="downloadApk(\'' + apk.browser_download_url + '\')">';
                html += btnText + ' (' + (apk.size / 1024 / 1024).toFixed(1) + ' MB)';
                html += '</button>';
            } else {
                // å·²æ˜¯æœ€æ–°ç‰ˆæœ¬æˆ–æ›´æ–°çš„ç‰ˆæœ¬ï¼Œæ˜¾ç¤º"é‡æ–°ä¸‹è½½"æŒ‰é’®
                html += '<button style="width: 100%; padding: 12px; margin-bottom: 10px; background: ' + THEME.bg + '; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;" onclick="downloadApk(\'' + apk.browser_download_url + '\')">';
                html += 'ğŸ’¾ é‡æ–°ä¸‹è½½ (' + (apk.size / 1024 / 1024).toFixed(1) + ' MB)';
                html += '</button>';
            }
            
            html += '</div>';
            html += '<button style="width: 100%; padding: 12px; background: #f0f0f0; color: #666; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;" onclick="document.getElementById(\'apkUpdateDialog\').remove()">å…³é—­</button>';
            html += '</div></div>';
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
    })();
    
    // é¡µé¢è®°å¿†åŠŸèƒ½ - ä¿å­˜ä¸»é¡µè®¿é—®è®°å½•
    (function() {
        function saveMainPage() {
            try {
                var href = window.location.href;
                localStorage.setItem('cx_last_page', href);
                localStorage.setItem('cx_last_page_time', Date.now());
                console.log('[é¡µé¢è®°å¿†] âœ“ ä¿å­˜ä¸»é¡µ:', href);
            } catch (e) {
                console.error('[é¡µé¢è®°å¿†] ä¿å­˜å¤±è´¥:', e);
            }
        }
        
        // æ£€æŸ¥å¯¼èˆªæ ˆæ˜¯å¦æœ‰å†…å®¹ï¼ˆæœ‰å†…å®¹è¯´æ˜æ˜¯ç”¨æˆ·ä¸»åŠ¨å¯¼èˆªå›æ¥çš„ï¼‰
        var navStack = JSON.parse(sessionStorage.getItem('cx_nav_stack') || '[]');
        var isUserNavigation = navStack.length > 0;
        
        // ç”¨æˆ·ä¸»åŠ¨è¿›å…¥ä¸»é¡µæ—¶ï¼Œç«‹å³ä¿å­˜
        if (isUserNavigation) {
            saveMainPage();
        }
        
        // é¡µé¢å¸è½½å‰ä¿å­˜
        window.addEventListener('beforeunload', saveMainPage);
        
        // é¡µé¢éšè—æ—¶ä¿å­˜ï¼ˆç§»åŠ¨ç«¯åˆ‡æ¢åº”ç”¨ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                saveMainPage();
            }
        });
    })();
    
    // é¡µé¢è®°å¿†åŠŸèƒ½ - æ¢å¤ä¸Šæ¬¡è®¿é—®çš„é¡µé¢ï¼ˆPWA å’Œ Capacitor APPï¼‰
    (function() {
        try {
            // æ£€æŸ¥æ˜¯å¦åœ¨ PWA æˆ– Capacitor APP ä¸­è¿è¡Œ
            var isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                        window.navigator.standalone === true;
            var isCapacitor = window.Capacitor !== undefined;
            var isApp = isPWA || isCapacitor;
            
            console.log('[é¡µé¢è®°å¿†] ç¯å¢ƒæ£€æµ‹:', {
                isPWA: isPWA,
                isCapacitor: isCapacitor,
                isApp: isApp
            });
            
            if (!isApp) {
                console.log('[é¡µé¢è®°å¿†] é APP ç¯å¢ƒï¼Œä¸å¯ç”¨è®°å¿†åŠŸèƒ½');
                return; // é APP æ¨¡å¼ä¸å¯ç”¨è®°å¿†åŠŸèƒ½
            }
            
            var lastPage = localStorage.getItem('cx_last_page');
            var lastPageTime = localStorage.getItem('cx_last_page_time');
            
            console.log('[é¡µé¢è®°å¿†] ä¸Šæ¬¡è®¿é—®:', lastPage, 'æ—¶é—´:', lastPageTime);
            
            // å¦‚æœæœ‰ä¿å­˜çš„é¡µé¢ï¼Œä¸”åœ¨7å¤©å†…è®¿é—®è¿‡ï¼Œåˆ™æ¢å¤
            if (lastPage && lastPageTime) {
                var timeDiff = Date.now() - parseInt(lastPageTime);
                var days7 = 7 * 24 * 60 * 60 * 1000;
                
                if (timeDiff < days7) {
                    // æ£€æŸ¥å¯¼èˆªæ ˆæ˜¯å¦ä¸ºç©ºï¼ˆç©ºæ ˆè¯´æ˜æ˜¯æ–°ä¼šè¯ï¼ŒAPP åˆšæ‰“å¼€ï¼‰
                    var navStack = JSON.parse(sessionStorage.getItem('cx_nav_stack') || '[]');
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨è¿”å›ï¼ˆä¸æ˜¯æ–°ä¼šè¯ï¼‰
                    var isUserBack = sessionStorage.getItem('cx_user_back') === 'true';
                    if (isUserBack) {
                        sessionStorage.removeItem('cx_user_back');
                    }
                    var isNewSession = navStack.length === 0 && !isUserBack;
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µï¼ˆæ”¯æŒå„ç§è·¯å¾„æ ¼å¼ï¼‰
                    var pathname = window.location.pathname;
                    var isMainPage = pathname === '/' || 
                                    pathname === '/index.html' ||
                                    pathname === '' ||
                                    // Capacitor å¯èƒ½ä½¿ç”¨ç‰¹æ®Šè·¯å¾„
                                    pathname === '/android_asset/public/index.html' ||
                                    pathname.includes('/public/index.html');
                    
                    // æ£€æŸ¥ä¿å­˜çš„é¡µé¢æ˜¯å¦ä¹Ÿæ˜¯ä¸»é¡µï¼ˆé¿å…ä¸»é¡µè·³ä¸»é¡µï¼‰
                    var lastPagePath = new URL(lastPage).pathname;
                    var lastPageIsMain = lastPagePath === '/' || 
                                        lastPagePath === '/index.html' ||
                                        lastPagePath === '' ||
                                        lastPagePath === '/android_asset/public/index.html' ||
                                        lastPagePath.includes('/public/index.html');
                    
                    console.log('[é¡µé¢è®°å¿†] æ£€æŸ¥æ¡ä»¶:', {
                        isNewSession: isNewSession,
                        isMainPage: isMainPage,
                        lastPageIsMain: lastPageIsMain,
                        navStackLength: navStack.length,
                        pathname: window.location.pathname
                    });
                    
                    // åªåœ¨æ–°ä¼šè¯è¿›å…¥ä¸»é¡µæ—¶æ¢å¤ï¼Œä¸”ä¿å­˜çš„é¡µé¢ä¸æ˜¯ä¸»é¡µ  
                    if (isNewSession && isMainPage && !lastPageIsMain) {
                        console.log('[é¡µé¢è®°å¿†] æ¢å¤ä¸Šæ¬¡è®¿é—®çš„é¡µé¢:', lastPage);
                        // æ¸…ç©ºå¯¼èˆªæ ˆï¼Œå› ä¸ºæ˜¯è‡ªåŠ¨è·³è½¬ï¼Œä¸åº”è¯¥è®°å½•ä¸»é¡µ
                        sessionStorage.removeItem('cx_nav_stack');
                        window.location.replace(lastPage);
                        return;
                    } else {
                        // ä¸è·³è½¬ï¼ŒæŠŠä¸»é¡µå‹å…¥æ ˆ
                        if (isNewSession) {
                            var currentPath = window.location.pathname + window.location.search + window.location.hash;
                            sessionStorage.setItem('cx_nav_stack', JSON.stringify([currentPath]));
                        }
                        var href = window.location.href;
                        localStorage.setItem('cx_last_page', href);
                        localStorage.setItem('cx_last_page_time', Date.now());
                        console.log('[é¡µé¢è®°å¿†] ä¸æ»¡è¶³æ¢å¤æ¡ä»¶ï¼Œä¿æŒåœ¨ä¸»é¡µ, ä¸”è®°å¿†');
                    }
                } else {
                    // æ—¶é—´è¿‡ä¹…ï¼Œä¸è·³è½¬ï¼ŒæŠŠä¸»é¡µå‹å…¥æ ˆ
                    if (isNewSession) {
                        var currentPath = window.location.pathname + window.location.search + window.location.hash;
                        sessionStorage.setItem('cx_nav_stack', JSON.stringify([currentPath]));
                    }
                    console.log('[é¡µé¢è®°å¿†] ä¸Šæ¬¡è®¿é—®æ—¶é—´è¿‡ä¹…ï¼Œä¸æ¢å¤');
                }
            } else {
                // æ²¡æœ‰è®°å½•ï¼ŒæŠŠä¸»é¡µå‹å…¥æ ˆ
                var navStack = JSON.parse(sessionStorage.getItem('cx_nav_stack') || '[]');
                if (navStack.length === 0) {
                    var currentPath = window.location.pathname + window.location.search + window.location.hash;
                    sessionStorage.setItem('cx_nav_stack', JSON.stringify([currentPath]));
                }
                console.log('[é¡µé¢è®°å¿†] æ²¡æœ‰ä¿å­˜çš„é¡µé¢è®°å½•');
            }
        } catch (e) {
            console.error('[é¡µé¢è®°å¿†] é”™è¯¯:', e);
        }
    })();
    
    // æ³¨å†Œ Service Worker å¹¶è‡ªåŠ¨æ›´æ–°
    if ('serviceWorker' in navigator) {
        var isInstalling = false;
        var installStartTime = Date.now();
        
        console.log('[ä¸»é¡µ] å¼€å§‹æ³¨å†Œ Service Worker');
        
        navigator.serviceWorker.register('./sw.js').then(function(reg) {
            console.log('[ä¸»é¡µ] Service Worker æ³¨å†ŒæˆåŠŸ');
            
            // æ£€æŸ¥æ›´æ–°ï¼ˆä½†ä¸é˜»å¡ï¼‰
            reg.update().catch(function(err) {
                console.log('[ä¸»é¡µ] æ£€æŸ¥æ›´æ–°å¤±è´¥:', err);
            });
            
            // ç›‘å¬å®‰è£…è¿›åº¦
            if (reg.installing) {
                trackInstalling(reg.installing);
            }
            
            // ç›‘å¬æ›´æ–°
            reg.addEventListener('updatefound', function() {
                console.log('[ä¸»é¡µ] å‘ç°æ›´æ–°');
                var newWorker = reg.installing;
                trackInstalling(newWorker);
                
                newWorker.addEventListener('statechange', function() {
                    console.log('[ä¸»é¡µ] SW çŠ¶æ€å˜åŒ–:', newWorker.state);
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œé™é»˜æ›´æ–°ï¼ˆä¸æ‰“æ‰°ç”¨æˆ·ï¼‰
                        console.log('[ä¸»é¡µ] æ–°ç‰ˆæœ¬å·²å°±ç»ªï¼Œä¸‹æ¬¡è®¿é—®æ—¶ç”Ÿæ•ˆ');
                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
            });
            
            // ç­‰å¾… Service Worker å°±ç»ª
            return navigator.serviceWorker.ready;
        }).then(function() {
            var installTime = Date.now() - installStartTime;
            console.log('[ä¸»é¡µ] Service Worker å·²å°±ç»ªï¼Œè€—æ—¶:', installTime, 'ms');
        }).catch(function(err) {
            console.error('[ä¸»é¡µ] Service Worker æ³¨å†Œå¤±è´¥:', err);
        });
        
        // ç›‘å¬ SW æ§åˆ¶å™¨å˜åŒ–ï¼ˆé™é»˜åˆ·æ–°ï¼‰
        var refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', function() {
            if (refreshing) return;
            refreshing = true;
            console.log('[ä¸»é¡µ] Service Worker å·²æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢');
            window.location.reload();
        });
        
        // è·Ÿè¸ªå®‰è£…è¿›åº¦
        function trackInstalling(worker) {
            if (isInstalling) return;
            isInstalling = true;
            console.log('[ä¸»é¡µ] Service Worker æ­£åœ¨å®‰è£…');
        }
    }
    
    // PWA å®‰è£…åŠŸèƒ½
    var deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        var installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.style.display = 'inline-flex';
        }
    });
    
    // ç”Ÿæˆå•ä¸ªè®­ç»ƒçš„èµ„æºåˆ—è¡¨ï¼ˆæå‡åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    function getTrainingResources(path, chapters, images) {
        var resources = [
            './' + path + '/',
            './' + path + '/js/speech.js',
            './' + path + '/js/font-control.js',
            './' + path + '/js/highlight.js'
        ];
        for (var i = 1; i <= chapters; i++) {
            resources.push('./' + path + '/' + i + '_cv.htm');
            resources.push('./' + path + '/' + i + '_cx.htm');
            resources.push('./' + path + '/' + i + '_sg.htm');
            resources.push('./' + path + '/' + i + '_ts.htm');
            resources.push('./' + path + '/' + i + '_zs.htm');
            resources.push('./' + path + '/' + i + '_h.htm');
        }
        // æ·»åŠ å›¾ç‰‡
        if (images && images.length > 0) {
            images.forEach(function(img) {
                resources.push('./' + path + '/' + img);
            });
        }
        return resources;
    }
    

    // ç¼“å­˜æ‰€æœ‰è®­ç»ƒèµ„æº
    function cacheAllTrainings(statusEl) {
        if (!('caches' in window)) {
            if (statusEl) {
                statusEl.textContent = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒç¼“å­˜';
                statusEl.className = 'cache-status error';
            }
            return Promise.resolve();
        }

        var trainings = window.__cxTrainings || [];
        if (!trainings.length) {
            if (statusEl) {
                statusEl.textContent = 'è®­ç»ƒåˆ—è¡¨å°šæœªåŠ è½½';
                statusEl.className = 'cache-status error';
            }
            return Promise.resolve();
        }

        var totalTrainings = trainings.length;
        var currentIndex = 0;
        var totalResources = 0;
        var cachedResources = 0;

        trainings.forEach(function(training) {
            totalResources += getTrainingResources(training.path, training.chapter_count, training.images || []).length;
        });

        if (statusEl) {
            statusEl.textContent = 'å¼€å§‹ç¼“å­˜å…¨éƒ¨è®­ç»ƒ...';
            statusEl.className = 'cache-status';
        }

        return trainings.reduce(function(promise, training) {
            return promise.then(function() {
                currentIndex++;
                var resources = getTrainingResources(training.path, training.chapter_count, training.images || []);
                var cacheKey = 'cx-' + training.path;

                if (statusEl) {
                    statusEl.textContent = 'ç¼“å­˜ä¸­ï¼š' + training.title + 'ï¼ˆ' + currentIndex + '/' + totalTrainings + 'ï¼‰';
                    statusEl.className = 'cache-status';
                }

                return caches.open(cacheKey).then(function(cache) {
                    var tasks = resources.map(function(url) {
                        return fetch(url, { redirect: 'follow', cache: 'no-cache' })
                            .then(function(response) {
                                if (response.ok && response.status >= 200 && response.status < 300) {
                                    cachedResources++;
                                    if (statusEl) {
                                        var percent = totalResources > 0 ? Math.round((cachedResources / totalResources) * 100) : 0;
                                        statusEl.textContent = 'ç¼“å­˜è¿›åº¦ï¼š' + percent + '%';
                                    }
                                    return cache.put(response.url, response.clone());
                                }
                            })
                            .catch(function() {
                                cachedResources++;
                            });
                    });
                    return Promise.all(tasks);
                });
            });
        }, Promise.resolve()).then(function() {
            if (statusEl) {
                statusEl.textContent = 'âœ“ å…¨éƒ¨ç¼“å­˜å®Œæˆ';
                statusEl.className = 'cache-status success';
            }
        }).then(function() {
            try {
                localStorage.setItem('cx_all_cached', Date.now().toString());
            } catch (e) {}
            updateCacheAllButtonState();
        }).catch(function(err) {
            console.error('ç¼“å­˜æ‰€æœ‰è®­ç»ƒå¤±è´¥:', err);
            if (statusEl) {
                statusEl.textContent = 'âš  ç¼“å­˜ä¸­æ–­ï¼Œè¯·é‡è¯•';
                statusEl.className = 'cache-status warning';
            }
        });
    }

    function updateCacheAllButtonState() {
        var cacheAllBtn = document.getElementById('cacheAllBtn');
        var dataToolsStatus = document.getElementById('dataToolsStatus');
        if (!cacheAllBtn) return;

        var flag = null;
        try {
            flag = localStorage.getItem('cx_all_cached');
        } catch (e) {}

        if (!flag) {
            cacheAllBtn.querySelector('.cache-icon').textContent = 'ğŸ“¦';
            cacheAllBtn.querySelector('.cache-text').textContent = 'ç¼“å­˜æ•°æ®';
            return;
        }

        if ('caches' in window) {
            caches.keys().then(function(keys) {
                var hasTrainingCache = keys.some(function(key) { return key.indexOf('cx-') === 0; });
                if (hasTrainingCache) {
                    cacheAllBtn.querySelector('.cache-icon').textContent = 'âœ…';
                    cacheAllBtn.querySelector('.cache-text').textContent = 'å·²ç¼“å­˜';
                    if (dataToolsStatus && !dataToolsStatus.textContent) {
                        dataToolsStatus.textContent = 'âœ“ å·²ç¼“å­˜å…¨éƒ¨æ•°æ®';
                        dataToolsStatus.className = 'cache-status success';
                    }
                } else {
                    try { localStorage.removeItem('cx_all_cached'); } catch (e) {}
                    cacheAllBtn.querySelector('.cache-icon').textContent = 'ğŸ“¦';
                    cacheAllBtn.querySelector('.cache-text').textContent = 'ç¼“å­˜æ•°æ®';
                }
            }).catch(function() {
                cacheAllBtn.querySelector('.cache-icon').textContent = 'ğŸ“¦';
                cacheAllBtn.querySelector('.cache-text').textContent = 'ç¼“å­˜æ•°æ®';
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        var installSection = document.getElementById('installSection');
        var installBtn = document.getElementById('installBtn');
        var androidApkBtn = document.getElementById('androidApkBtn');
        var installStatus = document.getElementById('installStatus');
        var dataToolsSection = document.getElementById('dataToolsSection');
        var clearDataBtn = document.getElementById('clearDataBtn');
        var cacheAllBtn = document.getElementById('cacheAllBtn');
        var dataToolsStatus = document.getElementById('dataToolsStatus');
        
        if (!('serviceWorker' in navigator)) {
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å®‰å“è®¾å¤‡ï¼ˆé APK ç¯å¢ƒï¼‰
        var isAndroid = /Android/i.test(navigator.userAgent);
        var isInApp = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true;
        var isCapacitor = window.Capacitor !== undefined;
        
        // å¦‚æœæ˜¯å®‰å“è®¾å¤‡ä¸”ä¸åœ¨ APP å†…ï¼Œæ˜¾ç¤º APK ä¸‹è½½æŒ‰é’®
        if (isAndroid && !isInApp && !isCapacitor) {
            installSection.classList.add('show');
            androidApkBtn.style.display = 'inline-flex';
            
            androidApkBtn.addEventListener('click', function() {
                installStatus.textContent = 'æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬...';
                installStatus.className = 'cache-status';
                
                // ä» Cloudflare Pages è·å–ç‰ˆæœ¬ä¿¡æ¯
                fetch('https://cx.zhaozg.cloudns.org/version.json?t=' + Date.now(), { cache: 'no-cache' })
                    .then(function(response) {
                        if (!response.ok) throw new Error('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯');
                        return response.json();
                    })
                    .then(function(versionInfo) {
                        var version = versionInfo.apk_version || versionInfo.version;
                        var apkFile = versionInfo.apk_file || ('TeHui-v' + version + '.apk');
                        var apkSize = versionInfo.apk_size;
                        var downloadUrl = 'https://cx.zhaozg.cloudns.org/' + apkFile;
                        var sizeText = apkSize ? ' (' + (apkSize / 1024 / 1024).toFixed(1) + ' MB)' : '';
                        
                        installStatus.textContent = 'æ­£åœ¨ä¸‹è½½ v' + version + sizeText + '...';
                        installStatus.className = 'cache-status success';
                        window.open(downloadUrl, '_blank');
                    })
                    .catch(function(error) {
                        installStatus.textContent = 'è·å–å¤±è´¥: ' + error.message;
                        installStatus.className = 'cache-status error';
                    });
            });
        }
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ PWA æ¨¡å¼ä¸‹è¿è¡Œï¼ˆå·²å®‰è£…ï¼‰
        var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        
        // åªåœ¨ PWA æ¨¡å¼ä¸‹æ˜¾ç¤ºæ•°æ®å·¥å…·åŒº
        if (isStandalone) {
            if (dataToolsSection) {
                dataToolsSection.style.display = 'flex';
                dataToolsSection.classList.add('show');
            }
        } else {
            // é PWA æ¨¡å¼ï¼Œæ˜¾ç¤ºå®‰è£…åŒºåŸŸ
            installSection.classList.add('show');
        }

        // iOS å®‰è£…æç¤º
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        if (isIOS && !isStandalone) {
            installBtn.style.display = 'inline-flex';
            installBtn.innerHTML = '<span class="cache-icon">ğŸ“²</span><span class="cache-text">æ·»åŠ åˆ°ä¸»å±å¹•</span>';
            installBtn.addEventListener('click', function() {
                installStatus.innerHTML = 'è¯·ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨ <strong>åˆ†äº«æŒ‰é’® â†‘</strong>ï¼Œç„¶åé€‰æ‹© <strong>"æ·»åŠ åˆ°ä¸»å±å¹•"</strong>';
                installStatus.className = 'cache-status';
            });
        } else if (installBtn) {
            installBtn.addEventListener('click', function() {
                if (deferredPrompt) {
                    installStatus.textContent = 'æ­£åœ¨å‡†å¤‡å®‰è£…...';
                    installStatus.className = 'cache-status';
                    
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(function(result) {
                        if (result.outcome === 'accepted') {
                            installStatus.textContent = 'âœ“ å®‰è£…æˆåŠŸï¼PWA å·²æ·»åŠ åˆ°ä¸»å±å¹•';
                            installStatus.className = 'cache-status success';
                            
                            // ç­‰å¾… Service Worker å°±ç»ª
                            if ('serviceWorker' in navigator) {
                                navigator.serviceWorker.ready.then(function() {
                                    installStatus.textContent = 'âœ“ å®‰è£…å®Œæˆï¼ç¦»çº¿åŠŸèƒ½å·²å¯ç”¨';
                                });
                            }
                            
                            setTimeout(function() {
                                installBtn.style.display = 'none';
                            }, 3000);
                        } else {
                            installStatus.textContent = '';
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
        
        // æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†åŠŸèƒ½ï¼ˆé€šè¿‡é•¿æŒ‰ Logo è§¦å‘ï¼‰
        var logo = document.getElementById('mainLogo');
        
        if (logo) {
            var longPressTimer = null;
            var isLongPress = false;
            
            // è§¦æ‘¸å¼€å§‹
            logo.addEventListener('touchstart', function(e) {
                isLongPress = false;
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    // è§¦å‘æ¸…ç†ç¼“å­˜
                    promptClearData();
                }, 2000); // é•¿æŒ‰2ç§’è§¦å‘
            });
            
            // è§¦æ‘¸ç»“æŸ
            logo.addEventListener('touchend', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                // å¦‚æœæ˜¯é•¿æŒ‰ï¼Œé˜»æ­¢ç‚¹å‡»äº‹ä»¶
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // è§¦æ‘¸ç§»åŠ¨ï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
            logo.addEventListener('touchmove', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                isLongPress = false;
            });
            
            // æ¡Œé¢ç«¯ï¼šé¼ æ ‡é•¿æŒ‰
            logo.addEventListener('mousedown', function(e) {
                isLongPress = false;
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    promptClearData();
                }, 2000);
            });
            
            logo.addEventListener('mouseup', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            logo.addEventListener('mouseleave', function(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
                isLongPress = false;
            });
        }

        function promptClearData() {
            var ok = confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ï¼š\nâ€¢ æ‰€æœ‰è®­ç»ƒçš„ç¦»çº¿ç¼“å­˜\nâ€¢ é¡µé¢è®°å¿†\nâ€¢ å­—ä½“å¤§å°è®¾ç½®\nâ€¢ è¯­é€Ÿè®¾ç½®\n\nä¸‹ä¸€æ­¥å¯é€‰æ‹©æ˜¯å¦ä¿ç•™åˆ’çº¿ç¬”è®°ã€‚');
            if (!ok) return;
            var keepNotes = confirm('æ˜¯å¦ä¿ç•™åˆ’çº¿ç¬”è®°ï¼Ÿ\n\nâ€œç¡®å®šâ€= ä¿ç•™ç¬”è®°\nâ€œå–æ¶ˆâ€= åŒæ—¶æ¸…ç†ç¬”è®°');
            clearAllCachesAndMemory({ keepNotes: keepNotes });
        }

        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', function() {
                promptClearData();
            });
        }

        if (cacheAllBtn) {
            cacheAllBtn.addEventListener('click', function() {
                cacheAllBtn.disabled = true;
                cacheAllTrainings(dataToolsStatus).finally(function() {
                    cacheAllBtn.disabled = false;
                });
            });
        }

        updateCacheAllButtonState();
        
        // æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†çš„å‡½æ•°
        function clearAllCachesAndMemory(options) {
            options = options || {};
            var keepNotes = options.keepNotes === true;
            console.log('[æ¸…ç†] å¼€å§‹æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†');
            
            var installStatus = document.getElementById('installStatus');
            var dataToolsStatus = document.getElementById('dataToolsStatus');
            if (installStatus) {
                installStatus.textContent = 'æ­£åœ¨æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†...';
                installStatus.className = 'cache-status';
            }
            if (dataToolsStatus) {
                dataToolsStatus.textContent = 'æ­£åœ¨æ¸…ç†æ•°æ®...';
                dataToolsStatus.className = 'cache-status';
            }
            
            var cleanupSteps = [];
            
            // 1. æ¸…ç† localStorageï¼ˆé¡µé¢è®°å¿†ã€å­—ä½“è®¾ç½®ã€è¯­é€Ÿè®¾ç½®ç­‰ï¼‰
            cleanupSteps.push(new Promise(function(resolve) {
                try {
                    var keysToRemove = [];
                    for (var i = 0; i < localStorage.length; i++) {
                        var key = localStorage.key(i);
                        // æ¸…ç†æ‰€æœ‰ cx_ å¼€å¤´çš„é”®
                        if (key && key.startsWith('cx_')) {
                            if (keepNotes && key === 'cx_highlights') {
                                continue;
                            }
                            keysToRemove.push(key);
                        }
                        // æ¸…ç†å­—ä½“å’Œè¯­é€Ÿè®¾ç½®
                        if (key === 'fontSize' || key === 'speechRate') {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(function(key) {
                        localStorage.removeItem(key);
                        console.log('[æ¸…ç†] åˆ é™¤ localStorage:', key);
                    });
                    console.log('[æ¸…ç†] localStorage æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤', keysToRemove.length, 'é¡¹');
                    resolve();
                } catch (e) {
                    console.error('[æ¸…ç†] æ¸…ç† localStorage å¤±è´¥:', e);
                    resolve(); // ç»§ç»­æ‰§è¡Œå…¶ä»–æ¸…ç†
                }
            }));
            
            // 2. æ¸…ç† sessionStorage
            cleanupSteps.push(new Promise(function(resolve) {
                try {
                    sessionStorage.clear();
                    console.log('[æ¸…ç†] sessionStorage å·²æ¸…ç†');
                    resolve();
                } catch (e) {
                    console.error('[æ¸…ç†] æ¸…ç† sessionStorage å¤±è´¥:', e);
                    resolve();
                }
            }));
            
            // 3. æ³¨é”€æ‰€æœ‰ Service Worker
            if ('serviceWorker' in navigator) {
                cleanupSteps.push(
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        console.log('[æ¸…ç†] æ‰¾åˆ° Service Worker:', registrations.length, 'ä¸ª');
                        return Promise.all(
                            registrations.map(function(registration) {
                                console.log('[æ¸…ç†] æ³¨é”€ Service Worker:', registration.scope);
                                return registration.unregister();
                            })
                        );
                    }).catch(function(e) {
                        console.error('[æ¸…ç†] æ³¨é”€ Service Worker å¤±è´¥:', e);
                    })
                );
            }
            
            // 4. æ¸…ç†æ‰€æœ‰ Cache Storage
            if ('caches' in window) {
                cleanupSteps.push(
                    caches.keys().then(function(keys) {
                        console.log('[æ¸…ç†] æ‰¾åˆ°ç¼“å­˜:', keys.length, 'ä¸ª');
                        return Promise.all(
                            keys.map(function(key) {
                                console.log('[æ¸…ç†] åˆ é™¤ç¼“å­˜:', key);
                                return caches.delete(key);
                            })
                        );
                    }).catch(function(e) {
                        console.error('[æ¸…ç†] æ¸…ç† Cache Storage å¤±è´¥:', e);
                    })
                );
            }
            
            // 5. æ¸…ç† IndexedDB
            if ('indexedDB' in window) {
                cleanupSteps.push(new Promise(function(resolve) {
                    try {
                        // å°è¯•åˆ é™¤å¸¸è§çš„ IndexedDB æ•°æ®åº“
                        var dbNames = ['cx-trainings', 'cx-cache', 'workbox-expiration'];
                        var deletePromises = dbNames.map(function(dbName) {
                            return new Promise(function(resolveDB) {
                                var request = indexedDB.deleteDatabase(dbName);
                                request.onsuccess = function() {
                                    console.log('[æ¸…ç†] åˆ é™¤ IndexedDB:', dbName);
                                    resolveDB();
                                };
                                request.onerror = function() {
                                    console.log('[æ¸…ç†] IndexedDB ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥:', dbName);
                                    resolveDB();
                                };
                                request.onblocked = function() {
                                    console.log('[æ¸…ç†] IndexedDB åˆ é™¤è¢«é˜»æ­¢:', dbName);
                                    resolveDB();
                                };
                            });
                        });
                        Promise.all(deletePromises).then(resolve);
                    } catch (e) {
                        console.error('[æ¸…ç†] æ¸…ç† IndexedDB å¤±è´¥:', e);
                        resolve();
                    }
                }));
            }
            
            // æ‰§è¡Œæ‰€æœ‰æ¸…ç†æ­¥éª¤
            Promise.all(cleanupSteps).then(function() {
                console.log('[æ¸…ç†] æ‰€æœ‰ç¼“å­˜å’Œè®°å¿†å·²æ¸…ç†å®Œæˆ');
                
                if (installStatus) {
                    installStatus.textContent = 'âœ“ æ¸…ç†å®Œæˆï¼å³å°†åˆ·æ–°';
                    installStatus.className = 'cache-status success';
                }
                if (dataToolsStatus) {
                    dataToolsStatus.textContent = 'âœ“ æ¸…ç†å®Œæˆï¼å³å°†åˆ·æ–°';
                    dataToolsStatus.className = 'cache-status success';
                }
                
                // ç«‹å³åˆ·æ–°é¡µé¢
                setTimeout(function() {
                    window.location.reload(true);
                }, 0);
            }).catch(function(err) {
                console.error('[æ¸…ç†] æ¸…ç†è¿‡ç¨‹å‡ºé”™:', err);
                if (installStatus) {
                    installStatus.textContent = 'âš  éƒ¨åˆ†æ¸…ç†å®Œæˆï¼Œé¡µé¢å³å°†åˆ·æ–°';
                    installStatus.className = 'cache-status warning';
                }
                if (dataToolsStatus) {
                    dataToolsStatus.textContent = 'âš  éƒ¨åˆ†æ¸…ç†å®Œæˆï¼Œé¡µé¢å³å°†åˆ·æ–°';
                    dataToolsStatus.className = 'cache-status warning';
                }
                // å³ä½¿å‡ºé”™ä¹Ÿåˆ·æ–°é¡µé¢
                setTimeout(function() {
                    window.location.reload(true);
                }, 0);
            });
        }
    });
    </script>
</body>
</html>
