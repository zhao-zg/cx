{% extends "base.html" %}

{% block title %}第{{ chapter.number }}篇 - 晨兴{% endblock %}

{% block content %}
<div class="morning-revival-page">
    {% include "page_navigation.html" %}

    <h2 class="chapter-title">第{{ chapter.number }}篇 {{ chapter.title }}</h2>
    
    <!-- 天导航栏 -->
    {% if chapter.morning_revivals %}
    <div class="day-navigation">
        {% for revival in chapter.morning_revivals %}
        <button class="day-link" data-day="{{ loop.index0 }}">{{ revival.day|extract_day }}</button>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- 分页容器 -->
    {% if chapter.morning_revivals %}
    <div class="pages-container">
        {% for revival in chapter.morning_revivals %}
        <div class="day-page" data-day="{{ loop.index }}" data-page="{{ loop.index0 }}" style="display: {% if loop.index0 == 0 %}block{% else %}none{% endif %};">
            {% if revival.outline %}
            <div class="outline-section">
                {% macro render_outline(items) %}
                    {% for item in items %}
                    <div class="outline-item {{ item.level|outline_level_class }}">
                        {{ item.level }}　{{ item.title }}
                    </div>
                    {% if item.children %}
                        {{ render_outline(item.children) }}
                    {% endif %}
                    {% endfor %}
                {% endmacro %}
                {{ render_outline(revival.outline) }}
            </div>
            {% endif %}
            
            {% if revival.morning_feeding or revival.message_reading %}
            <div class="content-separator"></div>
            {% endif %}
            
            {% if revival.feeding_scriptures or revival.morning_feeding %}
            <div class="feeding-section">
                <h4>晨兴喂养</h4>
                {% if revival.feeding_scriptures %}
                {% for scripture in revival.feeding_scriptures %}
                <div class="feeding-scripture">{{ scripture }}</div>
                {% endfor %}
                {% endif %}
                {% for para in revival.morning_feeding %}
                <p class="content-text">{{ para }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if revival.message_reading %}
            <div class="reading-section">
                <h4>信息选读</h4>
                {% for para in revival.message_reading %}
                <p class="content-text">{{ para }}</p>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- 翻页控制 -->
    <div class="page-controls">
        <button class="prev-btn" id="prevBtn">
            <span>←</span>
            <span class="btn-text">上一天</span>
        </button>
        <span class="page-indicator" id="pageIndicator">1 / {{ chapter.morning_revivals|length }}</span>
        <button class="next-btn" id="nextBtn">
            <span class="btn-text">下一天</span>
            <span>→</span>
        </button>
    </div>
    {% else %}
    <p class="no-content">暂无晨兴内容</p>
    {% endif %}
</div>

<script>
// 分页功能
(function() {
    const totalPages = {{ chapter.morning_revivals|length if chapter.morning_revivals else 0 }};
    if (totalPages === 0) return;
    
    let currentPage = 0;
    const pages = document.querySelectorAll('.day-page');
    const dayLinks = document.querySelectorAll('.day-link');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageIndicator = document.getElementById('pageIndicator');
    const pagesContainer = document.querySelector('.pages-container');
    
    // 显示指定页面，scrollToTop 控制是否滚动到顶部
    function showPage(pageIndex, scrollToTop) {
        if (pageIndex < 0 || pageIndex >= totalPages) return;
        
        // 隐藏所有页面
        pages.forEach(page => page.style.display = 'none');
        
        // 显示目标页面
        pages[pageIndex].style.display = 'block';
        
        // 切页时停止朗读，避免误报与状态错乱
        if (window.CXSpeech && typeof window.CXSpeech.cancel === 'function') {
            window.CXSpeech.cancel();
        }
        // 更新当前页
        currentPage = pageIndex;
        
        // 更新导航按钮状态
        dayLinks.forEach((link, index) => {
            if (index === currentPage) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // 更新翻页按钮状态
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage === totalPages - 1;
        
        // 更新页码指示器
        pageIndicator.textContent = `${currentPage + 1} / ${totalPages}`;
        
        // 仅在用户手动切换时滚动到顶部
        if (scrollToTop !== false) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    // 上一页
    prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            showPage(currentPage - 1);
        }
    });
    
    // 下一页
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages - 1) {
            showPage(currentPage + 1);
        }
    });
    
    // 导航按钮点击
    dayLinks.forEach((link, index) => {
        link.addEventListener('click', () => {
            showPage(index);
        });
    });
    
    // 键盘导航
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
            prevBtn.click();
        } else if (e.key === 'ArrowRight') {
            nextBtn.click();
        }
    });
    
    // 移动端滑动支持（仅水平滑动）
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    
    document.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });
    
    document.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    }, { passive: true });
    
    function handleSwipe() {
        const swipeThreshold = 80; // 最小滑动距离
        const verticalTolerance = 2; // 垂直容忍度：水平滑动必须是垂直滑动的2倍
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        
        // 只有当水平滑动距离明显大于垂直滑动距离，且超过阈值时才触发翻页
        if (Math.abs(diffX) > Math.abs(diffY) * verticalTolerance && Math.abs(diffX) > swipeThreshold) {
            if (diffX > 0) {
                // 向左滑动 - 下一页
                nextBtn.click();
            } else {
                // 向右滑动 - 上一页
                prevBtn.click();
            }
        }
    }
    
    // 根据 URL hash 初始化页面
    function initFromHash(isInitial) {
        const hash = window.location.hash;
        if (hash) {
            // 支持 #day1, #day2, ... #day6 格式
            const match = hash.match(/^#day(\d+)$/);
            if (match) {
                const dayNum = parseInt(match[1], 10);
                if (dayNum >= 1 && dayNum <= totalPages) {
                    // 初始加载时不滚动
                    showPage(dayNum - 1, !isInitial);
                    return;
                }
            }
        }
        showPage(0, !isInitial);
    }
    
    // 监听 hash 变化
    window.addEventListener('hashchange', function() {
        initFromHash(false);
    });
    
    // 初始化（不滚动）
    initFromHash(true);
})();

// 朗读功能初始化
function initSpeech() {
    window.CXSpeech.init({
        getText: function() {
            const activePage = document.querySelector('.day-page[style*="display: block"]') || document.querySelector('.day-page');
            if (!activePage) return '';

            let text = '';

            const outlineSection = activePage.querySelector('.outline-section');
            if (outlineSection) {
                const outlineItems = outlineSection.querySelectorAll('.outline-item');
                outlineItems.forEach(item => {
                    const t = item.textContent.trim();
                    if (t) text += t + '。';
                });
            }

            const feedingSection = activePage.querySelector('.feeding-section');
            if (feedingSection) {
                const paragraphs = feedingSection.querySelectorAll('.content-text');
                paragraphs.forEach(p => {
                    const t = p.textContent.trim();
                    if (t) text += t + '。';
                });
            }

            const readingSection = activePage.querySelector('.reading-section');
            if (readingSection) {
                const paragraphs = readingSection.querySelectorAll('.content-text');
                paragraphs.forEach(p => {
                    const t = p.textContent.trim();
                    if (t) text += t + '。';
                });
            }

            return text;
        }
    });
}

// 等待 CXSpeech 加载
function checkAndInitSpeech() {
    if (window.CXSpeech && window.CXSpeech.init) {
        initSpeech();
    } else {
        var attempts = 0;
        var checkInterval = setInterval(function() {
            attempts++;
            if (window.CXSpeech && window.CXSpeech.init) {
                clearInterval(checkInterval);
                initSpeech();
            } else if (attempts >= 50) {
                clearInterval(checkInterval);
            }
        }, 100);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkAndInitSpeech);
} else {
    checkAndInitSpeech();
}
</script>

<style>
.morning-revival-page {
    padding: 5px;
    max-width: 820px;
    margin: 0 auto;
}

/* 天导航栏 */
.day-navigation {
    display: flex;
    gap: 6px;
    margin: 15px 0;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    justify-content: center;
    font-size: 0.88em;
    box-sizing: border-box;
}

.day-link {
    min-height: 40px;
    padding: 8px 6px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 0.83em;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    max-width: 120px;
    white-space: nowrap;
    box-sizing: border-box;
}

.day-link:active {
    background: var(--bg);
    color: #ffffff;
    border-color: rgba(102, 126, 234, 0.5);
}

.day-link.active {
    background: var(--bg);
    color: #ffffff;
    border-color: rgba(102, 126, 234, 0.5);
    font-weight: 700;
}

/* 分页容器 */
.pages-container {
    position: relative;
    min-height: 400px;
    touch-action: pan-y;
}

.day-page {
    background: #fff;
    padding: 0;
}

.day-section {
    margin: 20px 0;
    background: #fff;
    padding: 0;
}

/* 纲目样式 - 使用 base.html 的公共样式 */
.outline-section {
    margin: 18px 0;
}

/* 内容分隔线 */
.content-separator {
    height: 1px;
    background: #ddd;
    margin: 20px 0;
}

/* 晨兴喂养和信息选读 */
.feeding-section,
.reading-section {
    margin: 20px 0;
}

/* 晨兴喂养/信息选读标题 - 与二级标题一样大 */
.feeding-section h4,
.reading-section h4 {
    font-size: 1.05em;
    font-weight: 600;
    color: #2d3748;
    margin: 16px 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
}

/* 晨兴喂养的经文样式 - 与三级标题一样大 */
.feeding-scripture {
    margin: 10px 0;
    padding: 10px 14px;
    background: #f7f8ff;
    border-left: 3px solid #667eea;
    border-radius: 4px;
    font-size: 1.02em;
    color: #4a5568;
    line-height: 1.7;
    font-weight: 550;
}

@media (min-width: 768px) {
    /* 晨兴喂养/信息选读标题 - 与二级标题一样大 */
    .feeding-section h4,
    .reading-section h4 {
        font-size: 1.08em;
    }
    
    .feeding-scripture {
        font-size: 1.05em;
        padding: 12px 16px;
    }
}

/* 翻页控制 */
.page-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 0 15px 0;
    padding: 10px;
    background: var(--surface-muted);
    border-radius: 12px;
    border: 1px solid var(--border);
}

.prev-btn,
.next-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    min-height: 44px;
    padding: 12px 16px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    color: #333;
    font-size: 0.9375em; /* 15px -> 0.9375em */
    cursor: pointer;
    transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
}

.prev-btn:active:not(:disabled),
.next-btn:active:not(:disabled) {
    background: var(--bg);
    color: #ffffff;
    border-color: rgba(102, 126, 234, 0.55);
}

.prev-btn:disabled,
.next-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.page-indicator {
    font-size: 0.94em;
    color: var(--text-muted);
    font-weight: 800;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .morning-revival-page {
        padding: 5px;
    }
    
    .day-navigation {
        gap: 5px;
        padding: 8px;
    }
    
    .day-link {
        padding: 5px 10px;
        font-size: 0.8125em; /* 13px -> 0.8125em */
    }
    
    .day-title {
        font-size: 0.9375em; /* 15px -> 0.9375em */
    }
    
    .page-controls {
        padding: 10px;
        margin: 20px 0 10px 0;
    }
    
    .prev-btn,
    .next-btn {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .btn-text {
        display: none;
    }
    
    .page-indicator {
        font-size: 13px;
    }
}
</style>
{% endblock %}
