{% extends "base.html" %}

{% block title %}第{{ chapter.number }}篇 - 晨兴{% endblock %}

{% block content %}
<div class="morning-revival-page">
    {% include "page_navigation.html" %}

    <h2 class="chapter-title">第{{ chapter.number }}篇 {{ chapter.title }}</h2>
    
    <!-- 天导航栏 -->
    {% if chapter.morning_revivals %}
    <div class="day-navigation">
        {% for revival in chapter.morning_revivals %}
        <button class="day-link" data-day="{{ loop.index0 }}">{{ revival.day|extract_day }}</button>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- 分页容器 -->
    {% if chapter.morning_revivals %}
    <div class="pages-container">
        {% for revival in chapter.morning_revivals %}
        <div class="day-page" data-day="{{ loop.index }}" data-page="{{ loop.index0 }}" style="display: {% if loop.index0 == 0 %}block{% else %}none{% endif %};">
            {% if revival.outline %}
            <div class="outline-section">
                {% for section in revival.outline %}
                <div class="outline-item {{ section.level|outline_level_class }}">
                    <span class="outline-level">{{ section.level }}</span>
                    <span class="outline-text">{{ section.title }}</span>
                    
                    {% if section.children %}
                    <div class="outline-children">
                        {% for child in section.children %}
                        <div class="outline-item {{ child.level|outline_level_class }}">
                            <span class="outline-level">{{ child.level }}</span>
                            <span class="outline-text">{{ child.title }}</span>
                            
                            {% if child.children %}
                            <div class="outline-children">
                                {% for grandchild in child.children %}
                                <div class="outline-item {{ grandchild.level|outline_level_class }}">
                                    <span class="outline-level">{{ grandchild.level }}</span>
                                    <span class="outline-text">{{ grandchild.title }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if revival.morning_feeding or revival.message_reading %}
            <div class="content-separator"></div>
            {% endif %}
            
            {% if revival.morning_feeding %}
            <div class="feeding-section">
                <h4>晨兴喂养</h4>
                {% for para in revival.morning_feeding %}
                <p class="content-paragraph">{{ para }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if revival.message_reading %}
            <div class="reading-section">
                <h4>信息选读</h4>
                {% for para in revival.message_reading %}
                <p class="content-paragraph">{{ para }}</p>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- 翻页控制 -->
    <div class="page-controls">
        <button class="prev-btn" id="prevBtn">
            <span>←</span>
            <span class="btn-text">上一天</span>
        </button>
        <span class="page-indicator" id="pageIndicator">1 / {{ chapter.morning_revivals|length }}</span>
        <button class="next-btn" id="nextBtn">
            <span class="btn-text">下一天</span>
            <span>→</span>
        </button>
    </div>
    {% else %}
    <p class="no-content">暂无晨兴内容</p>
    {% endif %}
</div>

<script>
// 分页功能
(function() {
    const totalPages = {{ chapter.morning_revivals|length if chapter.morning_revivals else 0 }};
    if (totalPages === 0) return;
    
    let currentPage = 0;
    const pages = document.querySelectorAll('.day-page');
    const dayLinks = document.querySelectorAll('.day-link');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageIndicator = document.getElementById('pageIndicator');
    const pagesContainer = document.querySelector('.pages-container');
    
    // 显示指定页面，scrollToTop 控制是否滚动到顶部
    function showPage(pageIndex, scrollToTop) {
        if (pageIndex < 0 || pageIndex >= totalPages) return;
        
        // 隐藏所有页面
        pages.forEach(page => page.style.display = 'none');
        
        // 显示目标页面
        pages[pageIndex].style.display = 'block';
        
        // 切页时停止朗读，避免误报与状态错乱
        if (window.CXSpeech && typeof window.CXSpeech.cancel === 'function') {
            window.CXSpeech.cancel();
        }
        // 更新当前页
        currentPage = pageIndex;
        
        // 更新导航按钮状态
        dayLinks.forEach((link, index) => {
            if (index === currentPage) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // 更新翻页按钮状态
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage === totalPages - 1;
        
        // 更新页码指示器
        pageIndicator.textContent = `${currentPage + 1} / ${totalPages}`;
        
        // 仅在用户手动切换时滚动到顶部
        if (scrollToTop !== false) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    // 上一页
    prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            showPage(currentPage - 1);
        }
    });
    
    // 下一页
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages - 1) {
            showPage(currentPage + 1);
        }
    });
    
    // 导航按钮点击
    dayLinks.forEach((link, index) => {
        link.addEventListener('click', () => {
            showPage(index);
        });
    });
    
    // 键盘导航
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
            prevBtn.click();
        } else if (e.key === 'ArrowRight') {
            nextBtn.click();
        }
    });
    
    // 移动端滑动支持（仅水平滑动）
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    
    pagesContainer.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });
    
    pagesContainer.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    }, { passive: true });
    
    function handleSwipe() {
        const swipeThreshold = 80; // 增加最小滑动距离
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        
        // 只有当水平滑动距离大于垂直滑动距离时才触发翻页
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > swipeThreshold) {
            if (diffX > 0) {
                // 向左滑动 - 下一页
                nextBtn.click();
            } else {
                // 向右滑动 - 上一页
                prevBtn.click();
            }
        }
    }
    
    // 根据 URL hash 初始化页面
    function initFromHash(isInitial) {
        const hash = window.location.hash;
        if (hash) {
            // 支持 #day1, #day2, ... #day6 格式
            const match = hash.match(/^#day(\d+)$/);
            if (match) {
                const dayNum = parseInt(match[1], 10);
                if (dayNum >= 1 && dayNum <= totalPages) {
                    // 初始加载时不滚动
                    showPage(dayNum - 1, !isInitial);
                    return;
                }
            }
        }
        showPage(0, !isInitial);
    }
    
    // 监听 hash 变化
    window.addEventListener('hashchange', function() {
        initFromHash(false);
    });
    
    // 初始化（不滚动）
    initFromHash(true);
})();

// 朗读功能（共享脚本）
window.addEventListener('DOMContentLoaded', function() {
    if (!window.CXSpeech || !window.CXSpeech.init) return;
    window.CXSpeech.init({
        getText: function() {
            const activePage = document.querySelector('.day-page[style*="display: block"]') || document.querySelector('.day-page');
            if (!activePage) return '';

            let text = '';

            const outlineSection = activePage.querySelector('.outline-section');
            if (outlineSection) {
                const outlineItems = outlineSection.querySelectorAll('.outline-item');
                outlineItems.forEach(item => {
                    const t = item.textContent.trim();
                    if (t) text += t + '。';
                });
            }

            const feedingSection = activePage.querySelector('.feeding-section');
            if (feedingSection) {
                const paragraphs = feedingSection.querySelectorAll('.content-paragraph');
                paragraphs.forEach(p => {
                    const t = p.textContent.trim();
                    if (t) text += t + '。';
                });
            }

            const readingSection = activePage.querySelector('.reading-section');
            if (readingSection) {
                const paragraphs = readingSection.querySelectorAll('.content-paragraph');
                paragraphs.forEach(p => {
                    const t = p.textContent.trim();
                    if (t) text += t + '。';
                });
            }

            return text;
        }
    });
});
</script>

<style>
.morning-revival-page {
    padding: 5px;
    max-width: 820px;
    margin: 0 auto;
}

/* 天导航栏 */
.day-navigation {
    display: flex;
    gap: 6px;
    margin: 15px 0;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    justify-content: center;
    font-size: 15px;
    box-sizing: border-box;
}

.day-link {
    min-height: 40px;
    padding: 8px 6px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    max-width: 120px;
    white-space: nowrap;
    box-sizing: border-box;
}

.day-link:active {
    background: var(--bg);
    color: #ffffff;
    border-color: rgba(102, 126, 234, 0.5);
}

.day-link.active {
    background: var(--bg);
    color: #ffffff;
    border-color: rgba(102, 126, 234, 0.5);
    font-weight: 700;
}

/* 分页容器 */
.pages-container {
    position: relative;
    min-height: 400px;
    touch-action: pan-y;
}

.day-page {
    background: #fff;
    padding: 0;
}

.day-section {
    margin: 20px 0;
    background: #fff;
    padding: 0;
}

/* 纲目样式 - 优化层级视觉差异 */
.outline-section {
    margin: 16px 0;
    line-height: 2.0;
}

.outline-item {
    margin: 8px 0;
    color: #2d3748;
    font-size: 0.9375em;
    line-height: 1.8;
}

/* Level 1: 大纲 (壹贰叁、I II III、A B C) - 最突出 */
.outline-item.level-1 {
    margin-top: 16px;
    margin-bottom: 12px;
    font-size: 1.0625em; /* 17px -> 1.0625em */
    font-weight: 800;
    color: var(--brand-1);
    padding: 8px 0;
    border-bottom: 2px solid rgba(var(--brand-1-rgb), 0.2);
}

.outline-item.level-1 > .outline-level {
    font-size: 1.125em; /* 18px -> 1.125em */
    font-weight: 800;
    color: var(--brand-1);
    background: var(--brand-soft-bg);
    padding: 4px 8px;
    border-radius: 6px;
    margin-right: 8px;
}

.outline-item.level-1 > .outline-text {
    color: var(--text);
    font-weight: 700;
}

/* Level 2: 中纲 (一二三、a b c) - 中等突出 */
.outline-item.level-2 {
    padding-left: 1.8em;
    font-size: 1em; /* 16px -> 1em */
    margin-top: 8px;
    margin-bottom: 6px;
    font-weight: 600;
}

.outline-item.level-2 > .outline-level {
    font-weight: 700;
    color: var(--brand-2);
    background: rgba(var(--brand-2-rgb), 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 6px;
}

.outline-item.level-2 > .outline-text {
    color: var(--text);
    font-weight: 600;
}

/* Level 3: 小纲 (1 2 3) - 普通样式 */
.outline-item.level-3 {
    padding-left: 3.2em;
    font-size: 0.9375em; /* 15px -> 0.9375em */
    margin-top: 4px;
    margin-bottom: 3px;
    font-weight: 500;
}

.outline-item.level-3 > .outline-level {
    font-weight: 600;
    color: var(--text-muted);
    margin-right: 5px;
}

.outline-item.level-3 > .outline-text {
    color: var(--text);
    font-weight: 400;
}

.outline-children {
    margin-left: 0;
}

.outline-level {
    margin-right: 5px;
}

.outline-text {
    color: #333;
}

@media (min-width: 768px) {
    .outline-item {
        font-size: 0.9375em; /* 15px -> 0.9375em */
    }

    .outline-item.level-1 {
        margin-top: 15px;
        font-size: 1em; /* 16px -> 1em */
    }

    .outline-item.level-1 > .outline-level {
        font-size: 1.0625em; /* 17px -> 1.0625em */
    }
}

/* 内容分隔线 */
.content-separator {
    height: 1px;
    background: #ddd;
    margin: 20px 0;
}

/* 晨兴喂养和信息选读 */
.feeding-section,
.reading-section {
    margin: 20px 0;
}

.feeding-section h4,
.reading-section h4 {
    font-size: 1.0625em;
    font-weight: 600;
    color: #2d3748;
    margin: 16px 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
}

.content-paragraph {
    margin: 14px 0;
    text-indent: 2em;
    line-height: 2.0;
    color: #4a5568;
    font-size: 0.9375em;
}

/* 翻页控制 */
.page-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 0 15px 0;
    padding: 10px;
    background: var(--surface-muted);
    border-radius: 12px;
    border: 1px solid var(--border);
}

.prev-btn,
.next-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    min-height: 44px;
    padding: 12px 16px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    color: #333;
    font-size: 0.9375em; /* 15px -> 0.9375em */
    cursor: pointer;
    transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
}

.prev-btn:active:not(:disabled),
.next-btn:active:not(:disabled) {
    background: var(--bg);
    color: #ffffff;
    border-color: rgba(102, 126, 234, 0.55);
}

.prev-btn:disabled,
.next-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.page-indicator {
    font-size: 0.9375em; /* 15px -> 0.9375em */
    color: var(--text-muted);
    font-weight: 800;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .morning-revival-page {
        padding: 5px;
    }
    
    .day-navigation {
        gap: 5px;
        padding: 8px;
    }
    
    .day-link {
        padding: 5px 10px;
        font-size: 0.8125em; /* 13px -> 0.8125em */
    }
    
    .day-title {
        font-size: 0.9375em; /* 15px -> 0.9375em */
    }
    
    .outline-item {
        font-size: 0.9375em; /* 15px -> 0.9375em */
        line-height: 1.8;
    }
    
    .content-paragraph {
        font-size: 0.9375em; /* 15px -> 0.9375em */
        line-height: 1.9;
    }
    
    .feeding-section h4,
    .reading-section h4 {
        font-size: 0.9375em; /* 15px -> 0.9375em */
    }
    
    .page-controls {
        padding: 10px;
        margin: 20px 0 10px 0;
    }
    
    .prev-btn,
    .next-btn {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .btn-text {
        display: none;
    }
    
    .page-indicator {
        font-size: 13px;
    }
}
</style>
{% endblock %}
