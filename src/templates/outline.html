{% extends "base.html" %}

{% block title %}第{{ chapter.number }}篇 - 纲目{% endblock %}

{% block header %}
<div class="header header--chapter">
    <h2 class="chapter-title">第{{ chapter.number }}篇 {{ chapter.title }}</h2>
</div>
{% endblock %}

{% block head_css %}
<style>
/* 展开级别控制按钮 - 关键CSS放head避免FOUC */
.outline-level-controls{display:flex;justify-content:center;gap:8px;margin:15px 0;padding:10px;background:var(--surface-alt);border-radius:var(--radius-md)}
.level-btn{min-width:60px;min-height:36px;padding:8px 14px;background:var(--btn-secondary-bg);border:1px solid var(--btn-secondary-border);border-radius:var(--radius-sm);font-size:14px;font-weight:600;color:var(--btn-secondary-text);cursor:pointer;transition:all 0.2s ease;box-shadow:var(--shadow-sm)}
.level-btn.active{background:var(--bg);border-color:var(--brand);color:#fff;box-shadow:0 2px 6px rgba(102,126,234,0.3)}
</style>
{% endblock %}

{% block content %}
{% from "outline_macro.html" import render_outline, render_section %}
<div class="outline-page">
    {% include "page_navigation.html" %}

    {% if chapter.scripture %}
    <div class="scripture-section">
        <div class="scripture">读经：{{ chapter.scripture }}</div>
        {% if chapter.scripture_verses %}
        <button class="scripture-toggle-btn chapter-scripture-toggle" onclick="toggleScripture('chapter-scripture')">展开经文</button>
        <div class="scripture-content chapter-scripture-content" id="chapter-scripture" style="display: none;" onclick="toggleScripture('chapter-scripture')">
            {% for verse in chapter.scripture_verses.split('\n') %}
                {% if verse.strip() %}
                <div class="verse-line">{{ verse }}</div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- 展开级别控制按钮 -->
    <div class="outline-level-controls">
        <button class="level-btn" onclick="expandToLevel(1)" title="只显示大纲（一级）">大纲</button>
        <button class="level-btn" onclick="expandToLevel(2)" title="显示大纲和中纲（一二级）">大中纲</button>
        <button class="level-btn active" onclick="expandToLevel(4)" title="显示全部内容">全部</button>
    </div>
    
    <div class="outline-content">
        {{ render_outline(chapter.outline_sections, True, default_collapsed) }}
    </div>
</div>

<style>
.outline-page{padding:5px}
.level-btn:active{transform:scale(0.95)}
.outline-content{margin-top:20px}
.subsections{margin-left:0;display:block}
.scripture-section{margin:15px 0;padding:12px 15px;background:var(--surface-alt);border-radius:8px}
.chapter-scripture-content{margin-top:6px;margin-left:0;background:var(--surface);border:1px solid rgba(102,126,234,0.18)}
.scripture-content{cursor:pointer}
</style>

<script src="js/outline.js"></script>
<script>
// 朗读功能初始化
function initSpeech() {
    window.CXSpeech.init({
        getText: function() {
            let text = '';
            const titleElem = document.querySelector('.chapter-title');
            if (titleElem) text += titleElem.textContent.trim() + '。';

            const scriptureElem = document.querySelector('.scripture');
            if (scriptureElem) text += scriptureElem.textContent.trim() + '。';

            // 读取所有纲目项目
            const outlineItems = document.querySelectorAll('.outline-item');
            outlineItems.forEach(item => {
                // 获取纲目文本，排除按钮和经文内容
                const clone = item.cloneNode(true);
                const buttons = clone.querySelectorAll('button');
                buttons.forEach(btn => btn.remove());
                const scriptures = clone.querySelectorAll('.scripture-content');
                scriptures.forEach(sc => sc.remove());
                const verseLines = clone.querySelectorAll('.verse-line');
                verseLines.forEach(vl => vl.remove());
                
                const t = clone.textContent.trim();
                if (t) {
                    text += t + '。';
                }
            });
            
            return text;
        }
    });
}

// 等待 CXSpeech 加载
function checkAndInitSpeech() {
    if (window.CXSpeech && window.CXSpeech.init) {
        initSpeech();
    } else {
        var attempts = 0;
        var checkInterval = setInterval(function() {
            attempts++;
            if (window.CXSpeech && window.CXSpeech.init) {
                clearInterval(checkInterval);
                initSpeech();
            } else if (attempts >= 50) {
                clearInterval(checkInterval);
            }
        }, 100);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkAndInitSpeech);
} else {
    checkAndInitSpeech();
}
</script>
{% endblock %}
