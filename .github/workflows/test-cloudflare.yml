name: æµ‹è¯• Cloudflare é…ç½®

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  test-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€æŸ¥ Secrets æ˜¯å¦é…ç½®
        run: |
          echo "æ£€æŸ¥ GitHub Secrets..."
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN æœªé…ç½®"
            exit 1
          else
            echo "âœ“ CLOUDFLARE_API_TOKEN å·²é…ç½®"
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID æœªé…ç½®"
            exit 1
          else
            echo "âœ“ CLOUDFLARE_ACCOUNT_ID å·²é…ç½®"
            echo "Account ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          fi
      
      - name: æµ‹è¯• Cloudflare API
        run: |
          echo "æµ‹è¯• Cloudflare API è¿æ¥..."
          echo "Account ID (å‰8ä½): ${ACCOUNT_ID:0:8}..."
          echo ""
          
          # åˆ—å‡ºæ‰€æœ‰ Pages é¡¹ç›®
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "HTTP çŠ¶æ€ç : $http_code"
          echo ""
          echo "API å“åº”:"
          echo "$body" | jq '.' || echo "$body"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          success=$(echo "$body" | jq -r '.success' 2>/dev/null || echo "false")
          if [ "$success" = "true" ]; then
            echo "âœ… API è¿æ¥æˆåŠŸ"
            
            # åˆ—å‡ºæ‰€æœ‰é¡¹ç›®åç§°
            echo ""
            echo "ğŸ“‹ ä½ çš„ Cloudflare Pages é¡¹ç›®åˆ—è¡¨:"
            projects=$(echo "$body" | jq -r '.result[].name' 2>/dev/null)
            if [ -z "$projects" ]; then
              echo "  (æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é¡¹ç›®)"
            else
              echo "$projects" | while read -r project; do
                echo "  - $project"
              done
            fi
            
            # æ£€æŸ¥ cx é¡¹ç›®æ˜¯å¦å­˜åœ¨
            echo ""
            project_exists=$(echo "$body" | jq -r '.result[] | select(.name=="cx") | .name' 2>/dev/null)
            if [ -n "$project_exists" ]; then
              echo "âœ… æ‰¾åˆ°é¡¹ç›®: cx"
              echo ""
              echo "é¡¹ç›®è¯¦æƒ…:"
              echo "$body" | jq '.result[] | select(.name=="cx")' 2>/dev/null
            else
              echo "âŒ æœªæ‰¾åˆ°é¡¹ç›®: cx"
              echo ""
              echo "å¯èƒ½çš„åŸå› :"
              echo "1. é¡¹ç›®åç§°ä¸åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰"
              echo "2. é¡¹ç›®åœ¨ä¸åŒçš„ Account ä¸‹"
              echo "3. API Token æƒé™ä¸è¶³"
            fi
          else
            echo "âŒ API è¿æ¥å¤±è´¥"
            echo ""
            echo "é”™è¯¯ä¿¡æ¯:"
            echo "$body" | jq -r '.errors[]' 2>/dev/null || echo "$body"
            echo ""
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Account ID ä¸æ­£ç¡®"
            echo "2. API Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
            echo "3. API Token æƒé™ä¸è¶³ï¼ˆéœ€è¦ 'Cloudflare Pages - Edit'ï¼‰"
          fi
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
