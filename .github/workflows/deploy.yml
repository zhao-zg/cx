name: æ„å»ºå¹¶éƒ¨ç½²åˆ° Cloudflare Pages å’Œ GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'resource/**'
      - 'src/generator.py'
      - 'src/models.py'
      - 'src/parser.py'
      - 'src/parser_improved.py'
      - 'src/templates/base.html'
      - 'src/templates/index.html'
      - 'src/templates/main_*.html'
      - 'src/templates/main_*.js'
      - 'src/templates/main_*.json'
      - 'src/templates/morning_revival.html'
      - 'src/templates/outline.html'
      - 'src/templates/scripture.html'
      - 'src/templates/details.html'
      - 'src/templates/hymn.html'
      - 'src/templates/message.html'
      - 'src/templates/ministry.html'
      - 'src/templates/page_navigation.html'
      - 'src/static/**'
      - 'main.py'
      - 'config.yaml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æ¨é€åˆ° gh-pages åˆ†æ”¯
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£… LibreOffice
        run: |
          echo "ğŸ“¦ å®‰è£… LibreOffice..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq libreoffice-writer libreoffice-core --no-install-recommends
          echo "âœ“ LibreOffice å·²å®‰è£…"
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
          pip install -r requirements.txt
      
      - name: ç”Ÿæˆé™æ€æ–‡ä»¶
        run: |
          echo "ğŸ”¨ ç”Ÿæˆé™æ€æ–‡ä»¶..."
          python main.py
          
          echo "ğŸ“‹ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
          python generate_version.py
          
          echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          ls -la output/
          
          echo "ğŸ“„ æ£€æŸ¥ version.json æ˜¯å¦å­˜åœ¨..."
          if [ -f output/version.json ]; then
            echo "âœ“ version.json æ–‡ä»¶å­˜åœ¨"
            echo "å†…å®¹é¢„è§ˆ:"
            cat output/version.json | head -20
          else
            echo "âš ï¸ version.json æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo "ğŸ“„ æ£€æŸ¥ sw.js æ˜¯å¦å­˜åœ¨..."
          if [ -f output/sw.js ]; then
            echo "âœ“ sw.js æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < output/sw.js) bytes"
            echo "å‰ 5 è¡Œå†…å®¹:"
            head -5 output/sw.js
          else
            echo "âŒ sw.js æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
      
      - name: æ£€æŸ¥å¹¶åˆ›å»º Cloudflare Pages é¡¹ç›®
        run: |
          echo "ğŸ” æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨..."
          
          # æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
          response=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/cx" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          success=$(echo "$response" | jq -r '.success')
          
          if [ "$success" = "true" ]; then
            echo "âœ“ é¡¹ç›® cx å·²å­˜åœ¨"
          else
            echo "ğŸ“¦ é¡¹ç›®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            
            create_response=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "cx",
                "production_branch": "main"
              }')
            
            create_success=$(echo "$create_response" | jq -r '.success')
            
            if [ "$create_success" = "true" ]; then
              echo "âœ“ é¡¹ç›® cx åˆ›å»ºæˆåŠŸ"
            else
              echo "âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥"
              echo "$create_response" | jq '.'
              exit 1
            fi
          fi
      
      - name: éƒ¨ç½²åˆ° Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages..."
          
          # å®‰è£…æœ€æ–°ç‰ˆ wrangler
          npm install -g wrangler
          
          # è·å– commit ä¿¡æ¯ï¼ˆè½¬æ¢ä¸º ASCIIï¼Œé¿å… UTF-8 é—®é¢˜ï¼‰
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG="Deploy $COMMIT_HASH"
          
          # éƒ¨ç½²
          wrangler pages deploy output \
            --project-name=cx \
            --branch=main \
            --commit-hash="$COMMIT_HASH" \
            --commit-message="$COMMIT_MSG"
          
          echo "âœ“ Cloudflare Pages éƒ¨ç½²å®Œæˆ"
      
      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'éƒ¨ç½²åˆ° GitHub Pages'
          cname: cx.xzdjx.dynv6.net
