name: æ„å»ºå¹¶éƒ¨ç½²åˆ° Cloudflare Pages å’Œ GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æ¨é€åˆ° gh-pages åˆ†æ”¯
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£… LibreOffice
        run: |
          echo "ğŸ“¦ å®‰è£… LibreOffice..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq libreoffice-writer libreoffice-core --no-install-recommends
          echo "âœ“ LibreOffice å·²å®‰è£…"
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
          pip install -r requirements.txt
      
      - name: ç”Ÿæˆé™æ€æ–‡ä»¶
        run: |
          echo "ğŸ”¨ ç”Ÿæˆé™æ€æ–‡ä»¶..."
          python main.py
      
      - name: æ£€æŸ¥å¹¶åˆ›å»º Cloudflare Pages é¡¹ç›®
        run: |
          echo "ğŸ” æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨..."
          
          # æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
          response=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/cx" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          success=$(echo "$response" | jq -r '.success')
          
          if [ "$success" = "true" ]; then
            echo "âœ“ é¡¹ç›® cx å·²å­˜åœ¨"
          else
            echo "ğŸ“¦ é¡¹ç›®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            
            create_response=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "cx",
                "production_branch": "main"
              }')
            
            create_success=$(echo "$create_response" | jq -r '.success')
            
            if [ "$create_success" = "true" ]; then
              echo "âœ“ é¡¹ç›® cx åˆ›å»ºæˆåŠŸ"
            else
              echo "âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥"
              echo "$create_response" | jq '.'
              exit 1
            fi
          fi
      
      - name: éƒ¨ç½²åˆ° Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: cx
          directory: output
      
      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'éƒ¨ç½²åˆ° GitHub Pages'
          cname: cx.zhaozg.dpdns.org
