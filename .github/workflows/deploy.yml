name: æ„å»ºå¹¶éƒ¨ç½²åˆ° Cloudflare Pages å’Œ GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'resource/**'
      - 'src/generator.py'
      - 'src/models.py'
      - 'src/parser.py'
      - 'src/parser_improved.py'
      - 'src/templates/base.html'
      - 'src/templates/index.html'
      - 'src/templates/main_*.html'
      - 'src/templates/main_*.js'
      - 'src/templates/main_*.json'
      - 'src/templates/morning_revival.html'
      - 'src/templates/outline.html'
      - 'src/templates/scripture.html'
      - 'src/templates/details.html'
      - 'src/templates/hymn.html'
      - 'src/templates/message.html'
      - 'src/templates/ministry.html'
      - 'src/templates/page_navigation.html'
      - 'src/static/**'
      - 'main.py'
      - 'config.yaml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æ¨é€åˆ° gh-pages åˆ†æ”¯
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£… LibreOffice
        run: |
          echo "ğŸ“¦ å®‰è£… LibreOffice..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq libreoffice-writer libreoffice-core --no-install-recommends
          echo "âœ“ LibreOffice å·²å®‰è£…"
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
          pip install -r requirements.txt
      
      - name: ç”Ÿæˆé™æ€æ–‡ä»¶
        run: |
          echo "ğŸ”¨ ç”Ÿæˆé™æ€æ–‡ä»¶..."
          python main.py
          
          echo "ğŸ“‹ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
          python generate_version.py
          
          echo "ï¿½ï¸ åˆ é™¤ app-update.jsï¼ˆä»… APK éœ€è¦ï¼‰..."
          if [ -f output/js/app-update.js ]; then
            rm -f output/js/app-update.js
            echo "âœ“ å·²åˆ é™¤ app-update.jsï¼ˆç½‘é¡µç‰ˆä¸éœ€è¦ï¼‰"
          fi
          
          echo "ï¿½ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          ls -la output/
          
          echo "ğŸ“„ æ£€æŸ¥ version.json æ˜¯å¦å­˜åœ¨..."
          if [ -f output/version.json ]; then
            echo "âœ“ version.json æ–‡ä»¶å­˜åœ¨"
            echo "å†…å®¹é¢„è§ˆ:"
            cat output/version.json | head -20
          else
            echo "âš ï¸ version.json æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo "ğŸ“„ æ£€æŸ¥ sw.js æ˜¯å¦å­˜åœ¨..."
          if [ -f output/sw.js ]; then
            echo "âœ“ sw.js æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < output/sw.js) bytes"
            echo "å‰ 5 è¡Œå†…å®¹:"
            head -5 output/sw.js
          else
            echo "âŒ sw.js æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
      
      - name: ä» GitHub Release ä¸‹è½½ APK
        run: |
          echo "ğŸ” ä» GitHub Release è·å–æœ€æ–° APK..."
          
          # è·å–æœ€æ–° Release ä¿¡æ¯
          RELEASE_INFO=$(curl -sf "https://api.github.com/repos/zhao-zg/cx/releases/latest" || echo "{}")
          
          if [ "$RELEASE_INFO" = "{}" ]; then
            echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ° Release"
            exit 0
          fi
          
          # æå– APK ä¿¡æ¯
          APK_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url // empty')
          APK_NAME=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".apk")) | .name // empty')
          APK_SIZE=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".apk")) | .size // empty')
          APK_VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name // empty' | sed 's/^v//')
          
          if [ -n "$APK_URL" ] && [ "$APK_URL" != "null" ]; then
            echo "ğŸ“¥ ä¸‹è½½ APK: $APK_NAME"
            echo "   ç‰ˆæœ¬: $APK_VERSION"
            echo "   å¤§å°: $APK_SIZE bytes"
            echo "   URL: $APK_URL"
            
            if curl -sfL -o "output/$APK_NAME" "$APK_URL"; then
              DOWNLOADED_SIZE=$(stat -c%s "output/$APK_NAME" 2>/dev/null || echo "0")
              echo "âœ“ APK ä¸‹è½½æˆåŠŸ: $APK_NAME ($DOWNLOADED_SIZE bytes)"
              
              # æ›´æ–° version.json æ·»åŠ  APK ä¿¡æ¯
              if [ -f output/version.json ]; then
                python3 << PYTHON_EOF
          import json
          
          with open('output/version.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          data['apk_file'] = '$APK_NAME'
          data['apk_version'] = '$APK_VERSION'
          data['apk_size'] = $DOWNLOADED_SIZE
          
          with open('output/version.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          
          print('âœ“ version.json å·²æ›´æ–°')
          print(f'  APK: $APK_NAME')
          print(f'  ç‰ˆæœ¬: $APK_VERSION')
          print(f'  å¤§å°: $DOWNLOADED_SIZE bytes')
          PYTHON_EOF
              fi
            else
              echo "âš ï¸ APK ä¸‹è½½å¤±è´¥"
            fi
          else
            echo "â„¹ï¸ Release ä¸­æ²¡æœ‰ APK æ–‡ä»¶"
          fi
      
      - name: æ£€æŸ¥å¹¶åˆ›å»º Cloudflare Pages é¡¹ç›®
        run: |
          echo "ğŸ” æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨..."
          
          # æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
          response=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/cx" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          success=$(echo "$response" | jq -r '.success')
          
          if [ "$success" = "true" ]; then
            echo "âœ“ é¡¹ç›® cx å·²å­˜åœ¨"
          else
            echo "ğŸ“¦ é¡¹ç›®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            
            create_response=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "cx",
                "production_branch": "main"
              }')
            
            create_success=$(echo "$create_response" | jq -r '.success')
            
            if [ "$create_success" = "true" ]; then
              echo "âœ“ é¡¹ç›® cx åˆ›å»ºæˆåŠŸ"
            else
              echo "âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥"
              echo "$create_response" | jq '.'
              exit 1
            fi
          fi
      
      - name: éƒ¨ç½²åˆ° Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages..."
          
          # å®‰è£…æœ€æ–°ç‰ˆ wrangler
          npm install -g wrangler
          
          # è·å– commit ä¿¡æ¯ï¼ˆè½¬æ¢ä¸º ASCIIï¼Œé¿å… UTF-8 é—®é¢˜ï¼‰
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG="Deploy $COMMIT_HASH"
          
          # éƒ¨ç½²ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "â³ ç­‰å¾… 30 ç§’åé‡è¯•..."
              sleep 30
              echo "ğŸ”„ é‡è¯•ç¬¬ $RETRY_COUNT æ¬¡..."
            fi
            
            if wrangler pages deploy output \
              --project-name=cx \
              --branch=main \
              --commit-hash="$COMMIT_HASH" \
              --commit-message="$COMMIT_MSG"; then
              SUCCESS=true
              echo "âœ“ Cloudflare Pages éƒ¨ç½²æˆåŠŸ"
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œå‡†å¤‡é‡è¯• ($RETRY_COUNT/$MAX_RETRIES)"
              else
                echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
            fi
          done
      
      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'éƒ¨ç½²åˆ° GitHub Pages'
          cname: cx.xzdjx.dynv6.net
      
      - name: ä¸Šä¼ å…¨é‡èµ„æºåŒ…åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: resource-package
          path: output/*.zip
          retention-days: 90
          if-no-files-found: warn
