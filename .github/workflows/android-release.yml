name: 构建安卓APK

on:
  push:
    tags:
      - 'v*.*.*'  # 只在推送版本号标签时触发，如 v1.0.0, v1.2.3
  workflow_dispatch:  # 允许手动触发
    inputs:
      sign_apk:
        description: '是否签名APK'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write  # 允许创建 Release 和上传文件

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 设置 Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 安装 LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: 安装 Python 依赖
      run: |
        pip install -r requirements.txt
        
    - name: 安装 Node.js 依赖
      run: npm install
      
    - name: 创建应用启动页
      run: |
        mkdir -p output
        
        # 提取版本号
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # 替换版本号并复制
        sed "s/CURRENT_APK_VERSION: '0.1.0'/CURRENT_APK_VERSION: '$VERSION'/g" \
          src/templates/app_index.html > output/index.html
        
        # 创建简单的 manifest.json
        cat > output/manifest.json << 'EOF'
        {
          "name": "特会信息",
          "short_name": "特会信息",
          "start_url": "./",
          "display": "standalone",
          "background_color": "#667eea",
          "theme_color": "#667eea",
          "icons": [
            {
              "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='white'>特</text></svg>",
              "sizes": "any",
              "type": "image/svg+xml"
            }
          ]
        }
        EOF
      
    - name: 添加安卓平台
      run: |
        npx cap add android
        
        # 确保 android 目录存在
        if [ ! -d "android" ]; then
          echo "✗ Android 平台添加失败"
          exit 1
        fi
        echo "✓ Android 平台添加成功"
      
    - name: 配置安卓项目版本信息
      run: |
        # 提取版本号
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # 计算 versionCode (将 1.0.0 转换为 10000)
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # 创建 variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # 检查并更新 app/build.gradle 中的版本信息
        if grep -q "versionCode" android/app/build.gradle; then
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION\"/" android/app/build.gradle
        else
          # 如果没有版本信息，添加到 defaultConfig
          sed -i "/defaultConfig {/a\        versionCode $VERSION_CODE\n        versionName \"$VERSION\"" android/app/build.gradle
        fi
        
        echo "✓ 版本配置完成: versionCode=$VERSION_CODE, versionName=$VERSION"
        
        # 显示配置结果
        echo "=== build.gradle 版本信息 ==="
        grep -A 2 "versionCode\|versionName" android/app/build.gradle || echo "未找到版本信息"
      
    - name: 构建在线版（空壳）
      run: |
        echo "=== 构建在线版 APK ==="
        
        # 同步在线版（使用当前的 output，只有启动页）
        npx cap sync
        
        # 备份 android 目录为在线版
        cp -r android android-online
        echo "✓ 在线版准备完成"
      
    - name: 解码密钥库（如果配置了签名）
      if: github.event.inputs.sign_apk == 'true'
      run: |
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "⚠️ 未配置签名密钥，将构建未签名版本"
          exit 0
        fi
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > my-release-key.keystore
        cat > android/keystore.properties << EOF
        storeFile=../../my-release-key.keystore
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        EOF
        
        cat >> android/app/build.gradle << 'EOF'
        
        def keystorePropertiesFile = rootProject.file("keystore.properties")
        def keystoreProperties = new Properties()
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
            
            android.signingConfigs {
                release {
                    storeFile file(keystoreProperties['storeFile'])
                    storePassword keystoreProperties['storePassword']
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                }
            }
            
            android.buildTypes.release.signingConfig = android.signingConfigs.release
        }
        EOF
      
    - name: 生成完整内容（离线版）
      run: |
        echo "=== 生成完整内容 ==="
        
        # 检查是否有 resource 文件夹
        if [ ! -d "resource" ] || [ -z "$(ls -A resource)" ]; then
          echo "⚠️ resource 文件夹为空，跳过完整内容生成"
          mkdir -p output-full
          cp output/index.html output-full/
          cp output/manifest.json output-full/
        else
          # 生成完整的静态网站
          python main.py
          python generate_version.py
          
          # 复制到 output-full
          cp -r output output-full
        fi
        
        echo "✓ 完整内容已生成"
        echo "在线版大小: $(du -sh output | cut -f1)"
        echo "离线版大小: $(du -sh output-full | cut -f1)"
        
    - name: 构建离线版（完整内容）
      run: |
        echo "=== 构建离线版 APK ==="
        
        # 临时替换 output 为完整内容
        mv output output-online
        mv output-full output
        
        # 更新 capacitor 配置为离线版
        sed -i 's/"appId": "com.tehui.app"/"appId": "com.tehui.offline"/' capacitor.config.json
        sed -i 's/"appName": "TeHui"/"appName": "TeHui离线版"/' capacitor.config.json
        
        # 同步离线版
        npx cap sync
        
        # 备份 android 目录为离线版
        cp -r android android-offline
        
        # 恢复配置和目录
        sed -i 's/"appId": "com.tehui.offline"/"appId": "com.tehui.app"/' capacitor.config.json
        sed -i 's/"appName": "TeHui离线版"/"appName": "TeHui"/' capacitor.config.json
        mv output output-full
        mv output-online output
        
        echo "✓ 离线版准备完成"
        
    - name: 授予 Gradle 执行权限
      run: |
        chmod +x android-online/gradlew
        chmod +x android-offline/gradlew
        
    - name: 构建在线版 APK
      run: |
        echo "=== 构建在线版 APK ==="
        cd android-online
        ./gradlew clean assembleRelease --stacktrace
        cd ..
        echo "✓ 在线版 APK 构建完成"
        
    - name: 构建离线版 APK
      run: |
        echo "=== 构建离线版 APK ==="
        cd android-offline
        ./gradlew clean assembleRelease --stacktrace
        cd ..
        echo "✓ 离线版 APK 构建完成"
        
    - name: 验证 APK
      run: |
        echo "=== 在线版 APK ==="
        ls -lh android-online/app/build/outputs/apk/release/
        
        echo ""
        echo "=== 离线版 APK ==="
        ls -lh android-offline/app/build/outputs/apk/release/
        
        # 验证在线版
        if [ -z "$(ls -A android-online/app/build/outputs/apk/release/*.apk 2>/dev/null)" ]; then
          echo "✗ 在线版 APK 未找到"
          exit 1
        fi
        
        # 验证离线版
        if [ -z "$(ls -A android-offline/app/build/outputs/apk/release/*.apk 2>/dev/null)" ]; then
          echo "✗ 离线版 APK 未找到"
          exit 1
        fi
        
        echo "✓ 所有 APK 构建成功"
        
    - name: 重命名和收集 APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        echo "=== 处理在线版 APK ==="
        cd android-online/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            NEW_NAME="TeHui-Online-v${VERSION}.apk"
            cp "$apk" "../../../../../../$NEW_NAME"
            echo "✓ 在线版: $NEW_NAME"
            echo "  大小: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== 处理离线版 APK ==="
        cd android-offline/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            NEW_NAME="TeHui-Offline-v${VERSION}.apk"
            cp "$apk" "../../../../../../$NEW_NAME"
            echo "✓ 离线版: $NEW_NAME"
            echo "  大小: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== 所有 APK 文件 ==="
        ls -lh TeHui-*.apk
        
        # 验证 APK 完整性
        echo ""
        echo "=== APK 详细信息 ==="
        for apk in TeHui-*.apk; do
          if [ -f "$apk" ]; then
            echo "----------------------------------------"
            echo "文件: $apk"
            echo "大小: $(du -h "$apk" | cut -f1)"
            echo "MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            
            # 使用 aapt 验证
            if $ANDROID_HOME/build-tools/*/aapt dump badging "$apk" | head -5; then
              echo "✓ APK 结构有效"
            else
              echo "✗ APK 结构无效"
            fi
            echo "----------------------------------------"
          fi
        done
        
    - name: 生成完整内容（用于离线版）
      run: |
        echo "=== 生成完整内容 ==="
        
        # 检查是否有 resource 文件夹
        if [ ! -d "resource" ] || [ -z "$(ls -A resource)" ]; then
          echo "⚠️ resource 文件夹为空，跳过内容生成"
        else
          python main.py
          python generate_version.py
        fi
        
        echo "✓ 完整内容已生成"
        du -sh output
        
    - name: 打包内容包
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        cd output
        zip -r ../TeHui-Content-v${VERSION}.zip .
        cd ..
        
        echo "✓ 内容包已生成"
        ls -lh TeHui-Content-*.zip
        
    - name: 上传 APK 到 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: TeHui-*.apk
        
    - name: 上传内容包到 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: content-package
        path: TeHui-Content-*.zip
        
    - name: 创建 Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TeHui-*.apk
          TeHui-Content-*.zip
        body: |
          ## �  特会信息 ${{ github.ref_name }}
          
          ### 📦 下载说明
          
          #### 1. 在线版 APK（推荐，约 5-10 MB）
          - 文件名：`TeHui-Online-${{ github.ref_name }}.apk`
          - 特点：体积小，内容从服务器动态加载
          - 优势：更新内容无需重装 APK
          - 适合：网络条件好的用户
          
          #### 2. 离线版 APK（约 50-100 MB）
          - 文件名：`TeHui-Offline-${{ github.ref_name }}.apk`
          - 特点：包含所有内容，完全离线使用
          - 优势：无需网络即可使用
          - 适合：网络不稳定或需要离线使用的用户
          
          #### 3. 内容包（完整网站）
          - 文件名：`TeHui-Content-${{ github.ref_name }}.zip`
          - 用途：部署到你的服务器，供在线版使用
          - 内容：所有训练文档的 HTML 页面
          - 部署：解压后上传到服务器根目录
          
          > **注意**：两个 APK 包名不同，可以同时安装
          
          ### ⚠️ 安装提示
          
          如果安装时提示"解析包出现问题"：
          1. 确认下载完整（检查文件大小）
          2. 清除旧版本后重新安装
          3. 确保安卓版本 ≥ 5.1（API 22）
          4. 尝试在设置中清除下载管理器的缓存
          
          ### 📝 版本信息
          - 版本号: ${{ github.ref_name }}
          - 签名状态: ${{ github.event.inputs.sign_apk == 'true' && '✅ 已签名' || '⚠️ 未签名（测试版）' }}
          - 构建时间: ${{ github.event.head_commit.timestamp }}
          - 提交: ${{ github.sha }}
          
          ### 🚀 使用流程
          
          #### 方案一：在线版（推荐）
          1. 下载并安装 `TeHui-Online-${{ github.ref_name }}.apk`
          2. 下载内容包，部署到服务器
          3. 打开应用，自动从服务器加载内容
          4. 更新内容时，只需更新服务器上的内容包，无需重装 APK
          
          #### 方案二：离线版
          1. 下载并安装 `TeHui-Offline-${{ github.ref_name }}.apk`
          2. 打开应用，直接使用（无需网络）
          3. 更新内容时，需要重新下载并安装新版 APK
          
          ### 💡 提示
          - 在线版和离线版可以同时安装（包名不同）
          - 在线版支持多服务器部署，长按 Logo 可切换服务器
          - 点击 Logo 10 次可检查 APK 更新
          - 在线版 APK 很少需要更新，主要更新内容包
          - 离线版每次内容更新都需要重装 APK
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
