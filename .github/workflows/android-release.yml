name: æ„å»ºå®‰å“APK

on:
  push:
    tags:
      - 'v*.*.*'  # åªåœ¨æ¨é€ç‰ˆæœ¬å·æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v1.2.3
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sign_apk:
        description: 'æ˜¯å¦ç­¾åAPK'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: è®¾ç½® Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: å®‰è£… LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: å®‰è£… Node.js ä¾èµ–
      run: npm install
      
    - name: åˆ›å»ºåº”ç”¨å¯åŠ¨é¡µ
      run: |
        mkdir -p output
        
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # æ›¿æ¢ç‰ˆæœ¬å·å¹¶å¤åˆ¶
        sed "s/CURRENT_APK_VERSION: '0.1.0'/CURRENT_APK_VERSION: '$VERSION'/g" \
          src/templates/app_index.html > output/index.html
        
        # åˆ›å»ºç®€å•çš„ manifest.json
        cat > output/manifest.json << 'EOF'
        {
          "name": "ç‰¹ä¼šä¿¡æ¯",
          "short_name": "ç‰¹ä¼šä¿¡æ¯",
          "start_url": "./",
          "display": "standalone",
          "background_color": "#667eea",
          "theme_color": "#667eea",
          "icons": [
            {
              "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='white'>ç‰¹</text></svg>",
              "sizes": "any",
              "type": "image/svg+xml"
            }
          ]
        }
        EOF
      
    - name: æ·»åŠ å®‰å“å¹³å°
      run: |
        npx cap add android
        
        # ç¡®ä¿ android ç›®å½•å­˜åœ¨
        if [ ! -d "android" ]; then
          echo "âœ— Android å¹³å°æ·»åŠ å¤±è´¥"
          exit 1
        fi
        echo "âœ“ Android å¹³å°æ·»åŠ æˆåŠŸ"
      
    - name: é…ç½®å®‰å“é¡¹ç›®ç‰ˆæœ¬ä¿¡æ¯
      run: |
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # è®¡ç®— versionCode (å°† 1.0.0 è½¬æ¢ä¸º 10000)
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # åˆ›å»º variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # æ£€æŸ¥å¹¶æ›´æ–° app/build.gradle ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
        if grep -q "versionCode" android/app/build.gradle; then
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION\"/" android/app/build.gradle
        else
          # å¦‚æœæ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ·»åŠ åˆ° defaultConfig
          sed -i "/defaultConfig {/a\        versionCode $VERSION_CODE\n        versionName \"$VERSION\"" android/app/build.gradle
        fi
        
        echo "âœ“ ç‰ˆæœ¬é…ç½®å®Œæˆ: versionCode=$VERSION_CODE, versionName=$VERSION"
        
        # æ˜¾ç¤ºé…ç½®ç»“æœ
        echo "=== build.gradle ç‰ˆæœ¬ä¿¡æ¯ ==="
        grep -A 2 "versionCode\|versionName" android/app/build.gradle || echo "æœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯"
      
    - name: åŒæ­¥åˆ°å®‰å“é¡¹ç›®
      run: npx cap sync
      
    - name: è§£ç å¯†é’¥åº“ï¼ˆå¦‚æœé…ç½®äº†ç­¾åï¼‰
      if: github.event.inputs.sign_apk == 'true'
      run: |
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "âš ï¸ æœªé…ç½®ç­¾åå¯†é’¥ï¼Œå°†æ„å»ºæœªç­¾åç‰ˆæœ¬"
          exit 0
        fi
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > my-release-key.keystore
        cat > android/keystore.properties << EOF
        storeFile=../../my-release-key.keystore
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        EOF
        
        cat >> android/app/build.gradle << 'EOF'
        
        def keystorePropertiesFile = rootProject.file("keystore.properties")
        def keystoreProperties = new Properties()
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
            
            android.signingConfigs {
                release {
                    storeFile file(keystoreProperties['storeFile'])
                    storePassword keystoreProperties['storePassword']
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                }
            }
            
            android.buildTypes.release.signingConfig = android.signingConfigs.release
        }
        EOF
      
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x android/gradlew
      
    - name: åˆ—å‡º Android é¡¹ç›®ç»“æ„
      run: |
        echo "=== Android é¡¹ç›®ç»“æ„ ==="
        ls -la android/
        echo "=== app ç›®å½• ==="
        ls -la android/app/
        echo "=== build.gradle å†…å®¹ï¼ˆå‰50è¡Œï¼‰==="
        head -50 android/app/build.gradle
        
    - name: é…ç½®å¤šæ¶æ„æ„å»º
      run: |
        # ä¿®æ”¹ build.gradle æ”¯æŒå¤šæ¶æ„
        cat >> android/app/build.gradle << 'EOF'
        
        android {
            splits {
                abi {
                    enable true
                    reset()
                    include 'armeabi-v7a', 'arm64-v8a', 'x86', 'x86_64'
                    universalApk true
                }
            }
        }
        EOF
        
        echo "âœ“ å¤šæ¶æ„é…ç½®å®Œæˆ"
        
    - name: æ˜¾ç¤ºæ„å»ºé…ç½®
      run: |
        echo "=== Capacitor é…ç½® ==="
        cat capacitor.config.json
        echo ""
        echo "=== Android Manifest ==="
        cat android/app/src/main/AndroidManifest.xml | head -30
        echo ""
        echo "=== build.gradle (app) ==="
        cat android/app/build.gradle | grep -A 5 "defaultConfig\|compileSdk\|minSdk\|targetSdk" || true
        
    - name: æ„å»º APK
      run: |
        cd android
        ./gradlew clean assembleRelease --stacktrace
        
    - name: éªŒè¯ APK
      run: |
        echo "=== æ„å»ºçš„ APK æ–‡ä»¶ ==="
        ls -lh android/app/build/outputs/apk/release/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ APK æ–‡ä»¶
        if [ -z "$(ls -A android/app/build/outputs/apk/release/*.apk 2>/dev/null)" ]; then
          echo "âœ— æ²¡æœ‰æ‰¾åˆ° APK æ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ“ APK æ„å»ºæˆåŠŸ"
        
    - name: é‡å‘½å APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        cd android/app/build/outputs/apk/release/
        
        # é‡å‘½åå„ä¸ªæ¶æ„çš„ APK
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            # æå–æ¶æ„ä¿¡æ¯
            if [[ "$apk" == *"arm64-v8a"* ]]; then
              ARCH="arm64"
            elif [[ "$apk" == *"armeabi-v7a"* ]]; then
              ARCH="arm32"
            elif [[ "$apk" == *"x86_64"* ]]; then
              ARCH="x86_64"
            elif [[ "$apk" == *"x86"* ]]; then
              ARCH="x86"
            elif [[ "$apk" == *"universal"* ]]; then
              ARCH="é€šç”¨ç‰ˆ"
            else
              ARCH="æœªçŸ¥"
            fi
            
            # æ£€æŸ¥æ˜¯å¦ç­¾å
            if [[ "$apk" == *"unsigned"* ]]; then
              SIGN=""
            else
              SIGN="-signed"
            fi
            
            # é‡å‘½åï¼ˆä½¿ç”¨è‹±æ–‡é¿å…ç¼–ç é—®é¢˜ï¼‰
            NEW_NAME="TeHui-v${VERSION}-${ARCH}${SIGN}.apk"
            cp "$apk" "../../../../../../$NEW_NAME"
            echo "âœ“ å·²é‡å‘½å: $NEW_NAME ($(du -h "$apk" | cut -f1))"
          fi
        done
        
        cd ../../../../../../
        echo "=== æ‰€æœ‰ APK æ–‡ä»¶ ==="
        ls -lh TeHui-*.apk
        
        # éªŒè¯ APK å®Œæ•´æ€§
        echo ""
        echo "=== APK è¯¦ç»†ä¿¡æ¯ ==="
        for apk in TeHui-*.apk; do
          if [ -f "$apk" ]; then
            echo "----------------------------------------"
            echo "æ–‡ä»¶: $apk"
            echo "å¤§å°: $(du -h "$apk" | cut -f1)"
            echo "MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            echo "å†…å®¹é¢„è§ˆ:"
            unzip -l "$apk" | head -30
            echo ""
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            if unzip -l "$apk" | grep -q "AndroidManifest.xml"; then
              echo "âœ“ AndroidManifest.xml å­˜åœ¨"
            else
              echo "âœ— AndroidManifest.xml ç¼ºå¤±"
            fi
            if unzip -l "$apk" | grep -q "classes.dex"; then
              echo "âœ“ classes.dex å­˜åœ¨"
            else
              echo "âœ— classes.dex ç¼ºå¤±"
            fi
            echo "----------------------------------------"
          fi
        done
        
    - name: ç”Ÿæˆåœ¨çº¿å†…å®¹åŒ…
      run: |
        echo "=== ç”Ÿæˆåœ¨çº¿å†…å®¹åŒ… ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ resource æ–‡ä»¶å¤¹
        if [ ! -d "resource" ] || [ -z "$(ls -A resource)" ]; then
          echo "âš ï¸ resource æ–‡ä»¶å¤¹ä¸ºç©ºï¼Œè·³è¿‡å†…å®¹ç”Ÿæˆ"
          mkdir -p output
          echo "<h1>å†…å®¹å¾…æ·»åŠ </h1>" > output/index.html
        else
          python main.py
          python generate_version.py
        fi
        
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        # æ‰“åŒ…åœ¨çº¿å†…å®¹
        cd output
        zip -r ../TeHui-Content-v${VERSION}.zip .
        cd ..
        
        echo "âœ“ åœ¨çº¿å†…å®¹åŒ…å·²ç”Ÿæˆ"
        ls -lh TeHui-Content-*.zip
        
    - name: ä¸Šä¼  APK åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: TeHui-*.apk
        
    - name: ä¸Šä¼ åœ¨çº¿å†…å®¹åŒ…åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: online-content
        path: TeHui-Content-*.zip
        
    - name: åˆ›å»º Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TeHui-*.apk
          TeHui-Content-*.zip
        body: |
          ## ï¿½  ç‰¹ä¼šä¿¡æ¯ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          #### 1. APK åŒ…ï¼ˆåº”ç”¨å£³ - çº¦ 5-10 MBï¼‰
          
          æ ¹æ®ä½ çš„è®¾å¤‡é€‰æ‹©å¯¹åº”çš„ APKï¼š
          
          - **arm64** - 64ä½ARMè®¾å¤‡ï¼ˆæ¨èï¼Œé€‚ç”¨äºå¤§å¤šæ•°æ–°æ‰‹æœºï¼‰
          - **arm32** - 32ä½ARMè®¾å¤‡ï¼ˆè€æ‰‹æœºï¼‰
          - **x86_64** - 64ä½x86è®¾å¤‡ï¼ˆæ¨¡æ‹Ÿå™¨ï¼‰
          - **x86** - 32ä½x86è®¾å¤‡ï¼ˆè€æ¨¡æ‹Ÿå™¨ï¼‰
          - **é€šç”¨ç‰ˆ** - åŒ…å«æ‰€æœ‰æ¶æ„ï¼ˆä½“ç§¯è¾ƒå¤§ï¼Œå…¼å®¹æ€§æœ€å¥½ï¼‰
          
          ä¸ç¡®å®šé€‰å“ªä¸ªï¼Ÿä¸‹è½½ **é€šç”¨ç‰ˆ** æˆ– **arm64** ç‰ˆæœ¬ã€‚
          
          - ç”¨é€”ï¼šå®‰è£…åˆ°å®‰å“è®¾å¤‡
          - åŠŸèƒ½ï¼šæä¾›åº”ç”¨æ¡†æ¶ï¼Œè‡ªåŠ¨ä»æœåŠ¡å™¨è·å–å†…å®¹
          - å®‰è£…ï¼šå¯ç”¨"æœªçŸ¥æ¥æº"åç›´æ¥å®‰è£…
          
          #### 2. åœ¨çº¿å†…å®¹åŒ…ï¼ˆå®Œæ•´ç½‘ç«™ï¼‰
          - æ–‡ä»¶åï¼š`TeHui-Content-${{ github.ref_name }}.zip`
          - ç”¨é€”ï¼šéƒ¨ç½²åˆ°ä½ çš„æœåŠ¡å™¨
          - å†…å®¹ï¼šæ‰€æœ‰è®­ç»ƒæ–‡æ¡£çš„ HTML é¡µé¢
          - éƒ¨ç½²ï¼šè§£å‹åä¸Šä¼ åˆ°æœåŠ¡å™¨æ ¹ç›®å½•
          
          ### âš ï¸ å®‰è£…æç¤º
          
          å¦‚æœå®‰è£…æ—¶æç¤º"è§£æåŒ…å‡ºç°é—®é¢˜"ï¼š
          1. ç¡®è®¤ä¸‹è½½å®Œæ•´ï¼ˆæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼‰
          2. å°è¯•ä¸‹è½½é€šç”¨ç‰ˆ
          3. æ¸…é™¤æ—§ç‰ˆæœ¬åé‡æ–°å®‰è£…
          4. ç¡®ä¿å®‰å“ç‰ˆæœ¬ â‰¥ 5.1ï¼ˆAPI 22ï¼‰
          
          ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬å·: ${{ github.ref_name }}
          - ç­¾åçŠ¶æ€: ${{ github.event.inputs.sign_apk == 'true' && 'âœ… å·²ç­¾å' || 'âš ï¸ æœªç­¾åï¼ˆæµ‹è¯•ç‰ˆï¼‰' }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          
          ### ğŸš€ ä½¿ç”¨æµç¨‹
          
          1. **é¦–æ¬¡ä½¿ç”¨**
             - ä¸‹è½½å¹¶å®‰è£… APK
             - ä¸‹è½½åœ¨çº¿å†…å®¹åŒ…ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨
             - æ‰“å¼€åº”ç”¨ï¼Œè‡ªåŠ¨ä»æœåŠ¡å™¨åŠ è½½å†…å®¹
          
          2. **æ›´æ–°å†…å®¹**
             - åªéœ€ä¸‹è½½æ–°çš„åœ¨çº¿å†…å®¹åŒ…
             - éƒ¨ç½²åˆ°æœåŠ¡å™¨
             - åº”ç”¨ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°
             - æ— éœ€é‡æ–°å®‰è£… APK
          
          3. **æ›´æ–°åº”ç”¨**
             - ä¸‹è½½æ–°çš„ APK
             - å®‰è£…è¦†ç›–æ—§ç‰ˆæœ¬
          
          ### ğŸ’¡ æç¤º
          - APK å¾ˆå°‘éœ€è¦æ›´æ–°
          - å†…å®¹å¯ä»¥éšæ—¶æ›´æ–°
          - æ”¯æŒå¤šæœåŠ¡å™¨éƒ¨ç½²
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
