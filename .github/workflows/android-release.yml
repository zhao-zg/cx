name: æ„å»ºå®‰å“APK

on:
  push:
    tags:
      - 'v*.*.*'  # åªåœ¨æ¨é€ç‰ˆæœ¬å·æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v1.2.3
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sign_apk:
        description: 'æ˜¯å¦ç­¾åAPK'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: è®¾ç½® Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: å®‰è£… LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: å®‰è£… Node.js ä¾èµ–
      run: npm install
      
    - name: åˆ›å»ºåº”ç”¨å¯åŠ¨é¡µ
      run: |
        mkdir -p output
        
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # æ›¿æ¢ç‰ˆæœ¬å·å¹¶å¤åˆ¶
        sed "s/CURRENT_APK_VERSION: '0.1.0'/CURRENT_APK_VERSION: '$VERSION'/g" \
          src/templates/app_index.html > output/index.html
        
        # åˆ›å»º manifest.json
        cat > output/manifest.json << 'EOF'
        {
          "name": "TeHui",
          "short_name": "TeHui",
          "start_url": "./index.html",
          "display": "standalone",
          "background_color": "#667eea",
          "theme_color": "#667eea",
          "icons": [
            {
              "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='white'>ç‰¹</text></svg>",
              "sizes": "512x512",
              "type": "image/svg+xml",
              "purpose": "any maskable"
            }
          ]
        }
        EOF
        
        echo "âœ“ åº”ç”¨å¯åŠ¨é¡µå·²åˆ›å»º"
        ls -lh output/
      
    - name: æ·»åŠ å®‰å“å¹³å°
      run: |
        npx cap add android
        
        # ç¡®ä¿ android ç›®å½•å­˜åœ¨
        if [ ! -d "android" ]; then
          echo "âœ— Android å¹³å°æ·»åŠ å¤±è´¥"
          exit 1
        fi
        echo "âœ“ Android å¹³å°æ·»åŠ æˆåŠŸ"
      
    - name: é…ç½®å®‰å“é¡¹ç›®ç‰ˆæœ¬ä¿¡æ¯
      run: |
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # è®¡ç®— versionCode (å°† 1.0.0 è½¬æ¢ä¸º 10000)
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # åˆ›å»º variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # ç¡®ä¿ build.gradle ä¸­æœ‰æ­£ç¡®çš„ç‰ˆæœ¬ä¿¡æ¯
        if grep -q "versionCode" android/app/build.gradle; then
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION\"/" android/app/build.gradle
        else
          # å¦‚æœæ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ·»åŠ åˆ° defaultConfig
          sed -i "/defaultConfig {/a\        versionCode $VERSION_CODE\n        versionName \"$VERSION\"" android/app/build.gradle
        fi
        
        # ç¡®ä¿ namespace å­˜åœ¨ï¼ˆAndroid Gradle Plugin 7.0+ éœ€è¦ï¼‰
        if ! grep -q "namespace" android/app/build.gradle; then
          sed -i "/android {/a\    namespace 'com.tehui.app'" android/app/build.gradle
        fi
        
        echo "âœ“ ç‰ˆæœ¬é…ç½®å®Œæˆ: versionCode=$VERSION_CODE, versionName=$VERSION"
        
        # æ˜¾ç¤ºé…ç½®ç»“æœ
        echo "=== build.gradle ç‰ˆæœ¬ä¿¡æ¯ ==="
        grep -A 2 "versionCode\|versionName\|namespace" android/app/build.gradle || echo "æœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯"
      
    - name: åŒæ­¥ Capacitor
      run: |
        echo "=== åŒæ­¥ Capacitor ==="
        npx cap sync android
        echo "âœ“ åŒæ­¥å®Œæˆ"
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
        echo ""
        echo "=== Android é¡¹ç›®ç»“æ„ ==="
        ls -la android/
        echo ""
        echo "=== AndroidManifest.xml å†…å®¹ ==="
        cat android/app/src/main/AndroidManifest.xml
      
    - name: é…ç½®ç­¾åå¯†é’¥
      run: |
        echo "=== é…ç½® APK ç­¾å ==="
        
        # ä» Secrets è§£ç å¯†é’¥åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "ä½¿ç”¨ GitHub Secrets ä¸­çš„ç­¾åå¯†é’¥"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > my-release-key.keystore
          STORE_PASSWORD="${{ secrets.KEYSTORE_PASSWORD }}"
          KEY_ALIAS="${{ secrets.KEY_ALIAS }}"
          KEY_PASSWORD="${{ secrets.KEY_PASSWORD }}"
        else
          echo "âš ï¸ æœªé…ç½®ç­¾åå¯†é’¥ï¼Œç”Ÿæˆä¸´æ—¶å¯†é’¥ï¼ˆæ¯æ¬¡æ„å»ºéƒ½ä¸åŒï¼‰"
          keytool -genkey -v \
            -keystore my-release-key.keystore \
            -alias tehui \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass tehui123 \
            -keypass tehui123 \
            -dname "CN=TeHui, OU=Development, O=TeHui, L=Beijing, ST=Beijing, C=CN"
          STORE_PASSWORD="tehui123"
          KEY_ALIAS="tehui"
          KEY_PASSWORD="tehui123"
        fi
        
        # åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
        cat > android/keystore.properties << EOF
        storeFile=../my-release-key.keystore
        storePassword=$STORE_PASSWORD
        keyAlias=$KEY_ALIAS
        keyPassword=$KEY_PASSWORD
        EOF
        
        # åœ¨ build.gradle ä¸­æ·»åŠ ç­¾åé…ç½®
        cat >> android/app/build.gradle << 'EOF'
        
        def keystorePropertiesFile = rootProject.file("../keystore.properties")
        def keystoreProperties = new Properties()
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
            
            android {
                signingConfigs {
                    release {
                        storeFile file(keystoreProperties['storeFile'])
                        storePassword keystoreProperties['storePassword']
                        keyAlias keystoreProperties['keyAlias']
                        keyPassword keystoreProperties['keyPassword']
                    }
                }
                buildTypes {
                    release {
                        signingConfig signingConfigs.release
                    }
                }
            }
        }
        EOF
        
        echo "âœ“ ç­¾åé…ç½®å®Œæˆ"
      
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x android/gradlew
        
    - name: æ„å»º APK
      run: |
        echo "=== æ„å»º APK ==="
        cd android
        ./gradlew clean assembleRelease --stacktrace --info
        cd ..
        echo "âœ“ APK æ„å»ºå®Œæˆ"
        
    - name: éªŒè¯å’Œé‡å‘½å APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        echo "=== æ„å»ºçš„ APK ==="
        ls -lh android/app/build/outputs/apk/release/
        
        if [ -z "$(ls -A android/app/build/outputs/apk/release/*.apk 2>/dev/null)" ]; then
          echo "âœ— æ²¡æœ‰æ‰¾åˆ° APK æ–‡ä»¶"
          exit 1
        fi
        
        cd android/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            NEW_NAME="TeHui-v${VERSION}.apk"
            cp "$apk" "../../../../../../$NEW_NAME"
            echo "âœ“ APK: $NEW_NAME"
            echo "  å¤§å°: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            
            # ä½¿ç”¨ aapt éªŒè¯
            echo ""
            echo "=== APK ä¿¡æ¯ ==="
            $ANDROID_HOME/build-tools/*/aapt dump badging "$apk" | head -10
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== æœ€ç»ˆ APK ==="
        ls -lh TeHui-*.apk
        
    - name: ä¸Šä¼  APK åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: TeHui-*.apk
        
    - name: åˆ›å»º Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TeHui-*.apk
        body: |
          ## ï¿½  ç‰¹ä¼šä¿¡æ¯ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          #### APK åŒ…ï¼ˆçº¦ 3-5 MBï¼‰
          - æ–‡ä»¶åï¼š`TeHui-${{ github.ref_name }}.apk`
          - ç‰¹ç‚¹ï¼šè½»é‡çº§åº”ç”¨å£³ï¼Œä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½å†…å®¹
          - åŠŸèƒ½ï¼š
            - æ”¯æŒå¤šæœåŠ¡å™¨åˆ‡æ¢ï¼ˆé•¿æŒ‰ Logoï¼‰
            - è‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼ˆç‚¹å‡» Logo 10 æ¬¡ï¼‰
            - PWA ç¼“å­˜ï¼Œæ”¯æŒç¦»çº¿æµè§ˆ
          - è¦æ±‚ï¼šå®‰å“ 5.1 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆAPI 22+ï¼‰
          
          ### âš ï¸ å®‰è£…æç¤º
          
          å¦‚æœå®‰è£…æ—¶æç¤º"è§£æåŒ…å‡ºç°é—®é¢˜"ï¼š
          1. ç¡®è®¤ä¸‹è½½å®Œæ•´ï¼ˆæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼‰
          2. æ¸…é™¤æ—§ç‰ˆæœ¬åé‡æ–°å®‰è£…
          3. ç¡®ä¿å®‰å“ç‰ˆæœ¬ â‰¥ 5.1ï¼ˆAPI 22ï¼‰
          4. å°è¯•åœ¨è®¾ç½®ä¸­æ¸…é™¤ä¸‹è½½ç®¡ç†å™¨çš„ç¼“å­˜
          5. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†"æœªçŸ¥æ¥æº"å®‰è£…æƒé™
          
          ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬å·: ${{ github.ref_name }}
          - åŒ…å: com.tehui.app
          - ç­¾åçŠ¶æ€: ${{ github.event.inputs.sign_apk == 'true' && 'âœ… å·²ç­¾å' || 'âš ï¸ æœªç­¾åï¼ˆæµ‹è¯•ç‰ˆï¼‰' }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸš€ ä½¿ç”¨è¯´æ˜
          
          1. ä¸‹è½½å¹¶å®‰è£… APK
          2. æ‰“å¼€åº”ç”¨ï¼Œè‡ªåŠ¨ä»æœåŠ¡å™¨åŠ è½½å†…å®¹
          3. é•¿æŒ‰ Logo å¯åˆ‡æ¢æœåŠ¡å™¨
          4. ç‚¹å‡» Logo 10 æ¬¡å¯æ£€æŸ¥ APK æ›´æ–°
          5. å†…å®¹ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œæ”¯æŒç¦»çº¿æµè§ˆ
          
          ### ğŸ’¡ æç¤º
          - è¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬ï¼Œç”¨äºéªŒè¯åŸºç¡€åŠŸèƒ½
          - å¦‚æœå®‰è£…æˆåŠŸï¼Œåç»­ç‰ˆæœ¬ä¼šæ·»åŠ ç¦»çº¿ç‰ˆæ”¯æŒ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
