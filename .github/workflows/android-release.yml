name: æ„å»ºå®‰å“APK

on:
  push:
    tags:
      - 'v*.*.*'  # åªåœ¨æ¨é€ç‰ˆæœ¬å·æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v1.2.3
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sign_apk:
        description: 'æ˜¯å¦ç­¾åAPK'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: è®¾ç½® Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: å®‰è£… LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: å®‰è£… Node.js ä¾èµ–
      run: npm install
      
    - name: åˆ›å»ºåº”ç”¨å¯åŠ¨é¡µ
      run: |
        mkdir -p output
        
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        
        # æ›¿æ¢ç‰ˆæœ¬å·å¹¶å¤åˆ¶
        sed "s/CURRENT_APK_VERSION: '1.0.0'/CURRENT_APK_VERSION: '$VERSION'/g" \
          src/templates/app_index.html > output/index.html
        
        # åˆ›å»ºç®€å•çš„ manifest.json
        cat > output/manifest.json << 'EOF'
        {
          "name": "ç‰¹ä¼šä¿¡æ¯",
          "short_name": "ç‰¹ä¼šä¿¡æ¯",
          "start_url": "./",
          "display": "standalone",
          "background_color": "#667eea",
          "theme_color": "#667eea",
          "icons": [
            {
              "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='white'>ç‰¹</text></svg>",
              "sizes": "any",
              "type": "image/svg+xml"
            }
          ]
        }
        EOF
      
    - name: æ·»åŠ å®‰å“å¹³å°
      run: |
        npx cap add android
        
        # ç¡®ä¿ android ç›®å½•å­˜åœ¨
        if [ ! -d "android" ]; then
          echo "âœ— Android å¹³å°æ·»åŠ å¤±è´¥"
          exit 1
        fi
        echo "âœ“ Android å¹³å°æ·»åŠ æˆåŠŸ"
      
    - name: é…ç½®å®‰å“é¡¹ç›®ç‰ˆæœ¬ä¿¡æ¯
      run: |
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        
        # è®¡ç®— versionCode (å°† 1.0.0 è½¬æ¢ä¸º 10000)
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # åˆ›å»º variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # æ£€æŸ¥å¹¶æ›´æ–° app/build.gradle ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
        if grep -q "versionCode" android/app/build.gradle; then
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION\"/" android/app/build.gradle
        else
          # å¦‚æœæ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ·»åŠ åˆ° defaultConfig
          sed -i "/defaultConfig {/a\        versionCode $VERSION_CODE\n        versionName \"$VERSION\"" android/app/build.gradle
        fi
        
        echo "âœ“ ç‰ˆæœ¬é…ç½®å®Œæˆ: versionCode=$VERSION_CODE, versionName=$VERSION"
        
        # æ˜¾ç¤ºé…ç½®ç»“æœ
        echo "=== build.gradle ç‰ˆæœ¬ä¿¡æ¯ ==="
        grep -A 2 "versionCode\|versionName" android/app/build.gradle || echo "æœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯"
      
    - name: åŒæ­¥åˆ°å®‰å“é¡¹ç›®
      run: npx cap sync
      
    - name: è§£ç å¯†é’¥åº“ï¼ˆå¦‚æœé…ç½®äº†ç­¾åï¼‰
      if: github.event.inputs.sign_apk == 'true'
      run: |
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "âš ï¸ æœªé…ç½®ç­¾åå¯†é’¥ï¼Œå°†æ„å»ºæœªç­¾åç‰ˆæœ¬"
          exit 0
        fi
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > my-release-key.keystore
        cat > android/keystore.properties << EOF
        storeFile=../../my-release-key.keystore
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        EOF
        
        cat >> android/app/build.gradle << 'EOF'
        
        def keystorePropertiesFile = rootProject.file("keystore.properties")
        def keystoreProperties = new Properties()
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
            
            android.signingConfigs {
                release {
                    storeFile file(keystoreProperties['storeFile'])
                    storePassword keystoreProperties['storePassword']
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                }
            }
            
            android.buildTypes.release.signingConfig = android.signingConfigs.release
        }
        EOF
      
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x android/gradlew
      
    - name: åˆ—å‡º Android é¡¹ç›®ç»“æ„
      run: |
        echo "=== Android é¡¹ç›®ç»“æ„ ==="
        ls -la android/
        echo "=== app ç›®å½• ==="
        ls -la android/app/
        echo "=== build.gradle å†…å®¹ï¼ˆå‰50è¡Œï¼‰==="
        head -50 android/app/build.gradle
        
    - name: æ„å»º APK
      run: |
        cd android
        ./gradlew clean assembleRelease --stacktrace --info
        
    - name: éªŒè¯ APK
      run: |
        APK_PATH="android/app/build/outputs/apk/release/app-release-unsigned.apk"
        if [ -f "$APK_PATH" ]; then
          echo "âœ“ APK æ„å»ºæˆåŠŸ"
          ls -lh "$APK_PATH"
        else
          echo "âœ— APK æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: é‡å‘½å APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯ç­¾åç‰ˆæœ¬
        if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
          mv android/app/build/outputs/apk/release/app-release.apk \
             ç‰¹ä¼šä¿¡æ¯-v${VERSION}-signed.apk
        else
          mv android/app/build/outputs/apk/release/app-release-unsigned.apk \
             ç‰¹ä¼šä¿¡æ¯-v${VERSION}.apk
        fi
        
    - name: ä¸Šä¼  APK åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: ç‰¹ä¼šä¿¡æ¯-*.apk
        
    - name: åˆ›å»º Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ç‰¹ä¼šä¿¡æ¯-*.apk
        body: |
          ## ğŸ“± ç‰¹ä¼šä¿¡æ¯ - å®‰å“åº”ç”¨
          
          ### ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„ APK æ–‡ä»¶
          2. åœ¨å®‰å“è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. å®‰è£… APK
          
          ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - ç­¾åçŠ¶æ€: ${{ github.event.inputs.sign_apk == 'true' && 'âœ… å·²ç­¾å' || 'âš ï¸ æœªç­¾å' }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          
          ### ğŸ’¡ æç¤º
          - æœªç­¾åç‰ˆæœ¬é€‚åˆæµ‹è¯•ä½¿ç”¨
          - å¦‚éœ€ç­¾åç‰ˆæœ¬ï¼Œè¯·æ‰‹åŠ¨è§¦å‘å·¥ä½œæµå¹¶é€‰æ‹©ç­¾åé€‰é¡¹
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
