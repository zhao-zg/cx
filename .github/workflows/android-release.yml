name: æž„å»ºå®‰å“APK

on:
  push:
    tags:
      - 'v*.*.*'  # åªåœ¨æŽ¨é€ç‰ˆæœ¬å·æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v1.2.3
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sign_apk:
        description: 'æ˜¯å¦ç­¾åAPK'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: è®¾ç½® Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: å®‰è£… LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: å®‰è£… Node.js ä¾èµ–
      run: npm install
      
    - name: ç”Ÿæˆå®Œæ•´é™æ€ç½‘ç«™ï¼ˆç”¨äºŽç¦»çº¿ç‰ˆï¼‰
      run: |
        echo "=== ç”Ÿæˆå®Œæ•´é™æ€ç½‘ç«™ ==="
        python main.py
        echo "âœ“ é™æ€ç½‘ç«™ç”Ÿæˆå®Œæˆ"
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶å¤§å°
        echo ""
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        du -sh output/
        find output/ -type f | wc -l
        echo "æ–‡ä»¶æ€»æ•°"
    
    - name: åˆ›å»ºåœ¨çº¿ç‰ˆå¯åŠ¨é¡µ
      run: |
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # å¤‡ä»½å®Œæ•´ç½‘ç«™åˆ° output-offline
        echo "=== å¤‡ä»½ç¦»çº¿ç‰ˆå†…å®¹ ==="
        cp -r output output-offline
        
        # æ¸…ç©º outputï¼Œåˆ›å»ºåœ¨çº¿ç‰ˆ
        echo "=== åˆ›å»ºåœ¨çº¿ç‰ˆï¼ˆç©ºå£³ï¼‰==="
        rm -rf output/*
        mkdir -p output/icons
        
        # æ›¿æ¢ç‰ˆæœ¬å·å¹¶å¤åˆ¶åœ¨çº¿ç‰ˆå¯åŠ¨é¡µ
        sed "s/CURRENT_APK_VERSION: '0.1.0'/CURRENT_APK_VERSION: '$VERSION'/g" \
          src/templates/app_index.html > output/index.html
        
        # å¤åˆ¶é™æ€å›¾æ ‡
        cp src/static/icons/icon.svg output/icons/
        
        # åˆ›å»º manifest.jsonï¼ˆä½¿ç”¨é™æ€å›¾æ ‡ï¼‰
        cat > output/manifest.json << 'EOF'
        {
          "name": "TeHui",
          "short_name": "TeHui",
          "start_url": "./index.html",
          "display": "standalone",
          "background_color": "#667eea",
          "theme_color": "#667eea",
          "icons": [
            {
              "src": "./icons/icon.svg",
              "sizes": "any",
              "type": "image/svg+xml",
              "purpose": "any maskable"
            }
          ]
        }
        EOF
        
        echo "âœ“ åœ¨çº¿ç‰ˆå¯åŠ¨é¡µå·²åˆ›å»º"
        echo ""
        echo "=== åœ¨çº¿ç‰ˆå¤§å° ==="
        du -sh output/
        echo ""
        echo "=== ç¦»çº¿ç‰ˆå¤§å° ==="
        du -sh output-offline/
      
    - name: æž„å»ºåœ¨çº¿ç‰ˆ Android é¡¹ç›®
      run: |
        echo "=== æž„å»ºåœ¨çº¿ç‰ˆ Android é¡¹ç›® ==="
        
        # ç¡®è®¤å½“å‰ output æ˜¯åœ¨çº¿ç‰ˆï¼ˆç©ºå£³ï¼‰
        echo "å½“å‰ output å†…å®¹ï¼š"
        ls -lh output/
        du -sh output/
        
        # æ·»åŠ å®‰å“å¹³å°ï¼ˆä½¿ç”¨åœ¨çº¿ç‰ˆå†…å®¹ï¼‰
        npx cap add android
        
        if [ ! -d "android" ]; then
          echo "âœ— Android å¹³å°æ·»åŠ å¤±è´¥"
          exit 1
        fi
        
        # æ˜¾ç¤ºåœ¨çº¿ç‰ˆ Android é¡¹ç›®çš„èµ„æºå¤§å°
        echo ""
        echo "=== åœ¨çº¿ç‰ˆ Android èµ„æº ==="
        du -sh android/app/src/main/assets/
        
        # å¤‡ä»½åœ¨çº¿ç‰ˆ android ç›®å½•
        mv android android-online
        echo "âœ“ åœ¨çº¿ç‰ˆ Android å¹³å°å‡†å¤‡å®Œæˆ"
        
    - name: æž„å»ºç¦»çº¿ç‰ˆ Android é¡¹ç›®
      run: |
        echo "=== æž„å»ºç¦»çº¿ç‰ˆ Android é¡¹ç›® ==="
        
        # åˆ‡æ¢åˆ°ç¦»çº¿ç‰ˆå†…å®¹
        rm -rf output
        mv output-offline output
        
        # ç¡®è®¤ç¦»çº¿ç‰ˆå†…å®¹
        echo "ç¦»çº¿ç‰ˆ output å†…å®¹ï¼š"
        du -sh output/
        find output/ -type f | wc -l
        echo "æ–‡ä»¶æ€»æ•°"
        
        # åˆ›å»ºç¦»çº¿ç‰ˆçš„ capacitor é…ç½®ï¼ˆä¿®æ”¹åº”ç”¨åç§°ä»¥åŒºåˆ†ï¼‰
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.tehui.app",
          "appName": "TeHuiç¦»çº¿ç‰ˆ",
          "webDir": "output",
          "bundledWebRuntime": false,
          "server": {
            "androidScheme": "https"
          },
          "android": {
            "allowMixedContent": true,
            "captureInput": true,
            "webContentsDebuggingEnabled": false
          }
        }
        EOF
        
        # æ·»åŠ å®‰å“å¹³å°ï¼ˆä½¿ç”¨ç¦»çº¿ç‰ˆå†…å®¹ï¼‰
        npx cap add android
        
        if [ ! -d "android" ]; then
          echo "âœ— Android å¹³å°æ·»åŠ å¤±è´¥"
          exit 1
        fi
        
        # æ˜¾ç¤ºç¦»çº¿ç‰ˆ Android é¡¹ç›®çš„èµ„æºå¤§å°
        echo ""
        echo "=== ç¦»çº¿ç‰ˆ Android èµ„æº ==="
        du -sh android/app/src/main/assets/
        
        # é‡å‘½åä¸ºç¦»çº¿ç‰ˆ
        mv android android-offline
        
        # æ¢å¤åœ¨çº¿ç‰ˆç›®å½•å’Œé…ç½®
        mv android-online android
        
        # æ¢å¤åœ¨çº¿ç‰ˆçš„ capacitor é…ç½®
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.tehui.app",
          "appName": "TeHui",
          "webDir": "output",
          "bundledWebRuntime": false,
          "server": {
            "androidScheme": "https"
          },
          "android": {
            "allowMixedContent": true,
            "captureInput": true,
            "webContentsDebuggingEnabled": false
          }
        }
        EOF
        
        echo "âœ“ ç¦»çº¿ç‰ˆ Android å¹³å°å‡†å¤‡å®Œæˆ"
        echo ""
        echo "=== ä¸¤ä¸ªç‰ˆæœ¬éƒ½å·²å‡†å¤‡ ==="
        ls -ld android android-offline
        echo ""
        echo "=== èµ„æºå¤§å°å¯¹æ¯” ==="
        echo "åœ¨çº¿ç‰ˆï¼š"
        du -sh android/app/src/main/assets/
        echo "ç¦»çº¿ç‰ˆï¼š"
        du -sh android-offline/app/src/main/assets/
      
    - name: é…ç½®å®‰å“é¡¹ç›®ç‰ˆæœ¬ä¿¡æ¯
      run: |
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        # è®¡ç®— versionCode (å°† 1.0.0 è½¬æ¢ä¸º 10000)
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # åˆ›å»º variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # ç¡®ä¿ build.gradle ä¸­æœ‰æ­£ç¡®çš„ç‰ˆæœ¬ä¿¡æ¯
        if grep -q "versionCode" android/app/build.gradle; then
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION\"/" android/app/build.gradle
        else
          # å¦‚æžœæ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ·»åŠ åˆ° defaultConfig
          sed -i "/defaultConfig {/a\        versionCode $VERSION_CODE\n        versionName \"$VERSION\"" android/app/build.gradle
        fi
        
        # ç¡®ä¿ namespace å­˜åœ¨ï¼ˆAndroid Gradle Plugin 7.0+ éœ€è¦ï¼‰
        if ! grep -q "namespace" android/app/build.gradle; then
          sed -i "/android {/a\    namespace 'com.tehui.app'" android/app/build.gradle
        fi
        
        echo "âœ“ ç‰ˆæœ¬é…ç½®å®Œæˆ: versionCode=$VERSION_CODE, versionName=$VERSION"
        
        # æ˜¾ç¤ºé…ç½®ç»“æžœ
        echo "=== build.gradle ç‰ˆæœ¬ä¿¡æ¯ ==="
        grep -A 2 "versionCode\|versionName\|namespace" android/app/build.gradle || echo "æœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯"
      
    - name: åŒæ­¥ä¸¤ä¸ªç‰ˆæœ¬
      run: |
        echo "=== åŒæ­¥åœ¨çº¿ç‰ˆ ==="
        npx cap sync android
        echo "âœ“ åœ¨çº¿ç‰ˆåŒæ­¥å®Œæˆ"
        
        echo ""
        echo "=== åŒæ­¥ç¦»çº¿ç‰ˆ ==="
        npx cap sync android-offline
        echo "âœ“ ç¦»çº¿ç‰ˆåŒæ­¥å®Œæˆ"
        
        echo ""
        echo "=== éªŒè¯ä¸¤ä¸ªç‰ˆæœ¬ ==="
        ls -la android/ android-offline/
      
    - name: åˆ›å»ºå›ºå®šç­¾åå¯†é’¥
      run: |
        echo "=== ä½¿ç”¨å›ºå®šç­¾åå¯†é’¥ ==="
        
        # ä½¿ç”¨å›ºå®šçš„ base64 ç¼–ç å¯†é’¥ï¼ˆå·²é¢„å…ˆç”Ÿæˆï¼‰
        # å¯†é’¥ä¿¡æ¯ï¼š
        # - Alias: tehui
        # - Password: tehui2024
        # - Validity: 10000 days
        # è¿™æ ·æ¯æ¬¡æž„å»ºä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼Œå¯ä»¥è¦†ç›–å®‰è£…
        cat > my-release-key.keystore.b64 << 'EOF'
        /u3+7QAAAAIAAAABAAAAAQAFdGVodWkAAAGbJ2W/wAAABQEwggT9MA4GCisGAQQBKgIRAQEFAASC
        BOk5p6R+3rqv8d6ptbALX/l+FUOv84/EwVgquxTrbUujDxkITQN/rrld/DwmqzSuO6Y8sV/8RZXq
        Fe5DZORP9ANQJn2vh01C0z73HfLYh8lzulZCPLXPQyT6ySV0lWGGspSjUVbjACqqAB/nrV07foA7
        UATxw5bcB0omF40m+dv1GdHAfNycIg5d+WKfef6jYgtT8EkeqyfwmJ8V/aayI2uYPe31Ba491g88
        U3a8a/w1j8V2b7hskm/Co67ijM7dZLz/1myyeyPmBwj4TzjZPdJVoKWYldEBoHnjouCLjq/YH5Fj
        tHQs7qYC86xa5gyz4kn5xxh9VGBleZ+pLIIYPavLN5/RxmyEzVh6upqUpFPYBm93lYqNKjJiDrGg
        t4jnvOng5Vt2/J0BWgGjdh6l+jmkJi3ZSEqM/bQiAvdy5r5+QdFhA6jL9L+XxxYf6ONl4m0WP/At
        /KIXVsOwDLKpV5TugxbSo6lR9tlNRHEO+c0Z1qohq6ApKEylfR5FYf7VbHNI725Au0OWGTvfBokZ
        FA6IkXi4KDpu0UG/x8aFUi9C48CSry4rkvNGITrJ3btbrRdRK18/QN8MTy+d5mzYTLdpkTsbRWtM
        ySilc4wFXagBwQ6mV1qhpKYGtKTfp4DEtbDGTibSGMtwB00Je8NI5VvSuIgSYjs7U7ktwCTvWK5R
        6XsRhszqWayO1nUTrSijNZzM/zEA02rqkgoB0xAJYRTbEfvsGcG+RHquMCbPDWmlgUxqGzhfLWsj
        I7tjvlQ11e+Op1A/u/nzPd+i57I/guBRrJjXBuUuG2iYHJ/ABQRmL+dT3NlM04O7EAxvmtJH946e
        RAGHIELs+Sp348c1S6zCxwuFLy2i4KcX2hT8TxI52GTwUNe97WRCCZV/8L0VHT2rifv48lkLaxfc
        /rVCDEZhUNEGl9HwN6QcajVSti31Xs2i3LPxyK8iAtfNjtzhDIduRBJY9uOJyFRtLF6VCTRjwNk7
        9g8BmZ4mfIVsLwy2wqqiw1P8mSb8C/ZmCqyapsKDtZ8WtHtTGp83/e/cnNWeI7M8NQCmo9ocpoXA
        VZinbMp9ZnhKClr2KDLWeTOxYhfCp2PC72N7HzqaYPyEVP3yOv+8M+z42Y3i0SQf4PXZIRT0cDoC
        TCLfhXCAWD471scCgjDwZyPBHly5XMC+tlfRRwyMRitx6sjlfSx8PByhRuVfUReigwupeZDs8c9D
        +kEiDnfGjPXVOY8Vz7BGY23/ZYqKRCxy6GRjKTIFfwqH3LgoCcuuAomm8FQ0A6GWY6jasyh2SYRx
        bu7v2lpJiSN5/WjINKTuXfFFNdLHt2IEQ4BKZq886W58hdg4lenAFy18rDHAOJNnyux1nHqzSVSF
        Eyj3zyhoPVLtwFeslss0OjO79gfGzOmKVCumD23P11m2s6L+GThy+vRkvGz+I+9crtyJoMX3nqdu
        YlfDlE4WJRMqL7/KXnt/FEyja6Lm4aQZc3S+BHCX8NcRkgao8puU2OUuCbBq7Kn89cVPRdkxJWBj
        VDIG+8rV44WkTywgEqgCRiA4yqzgCzojKaUpiE/mdbPeqNVUbYuFcGr1rPST9mi7sh4eoRyARpsz
        wVqn+HnVQogAQDG447ANs16ovuIQTI/dOeEggD7bwYhWLsXBJ6OSIFJSuZokAr3TBddC5xdymyKW
        HRSbBFsAAAABAAVYLjUwOQAAA3MwggNvMIICV6ADAgECAgRaxCZqMA0GCSqGSIb3DQEBCwUAMGcx
        CzAJBgNVBAYTAkNOMRAwDgYDVQQIEwdCZWlqaW5nMRAwDgYDVQQHEwdCZWlqaW5nMQ4wDAYDVQQK
        EwVUZUh1aTEUMBIGA1UECxMLRGV2ZWxvcG1lbnQxDjAMBgNVBAMTBVRlSHVpMCAXDTI1MTIxNjEz
        NDIxOFoYDzIwNTMwNTAzMTM0MjE4WjBnMQswCQYDVQQGEwJDTjEQMA4GA1UECBMHQmVpamluZzEQ
        MA4GA1UEBxMHQmVpamluZzEOMAwGA1UEChMFVGVIdWkxFDASBgNVBAsTC0RldmVsb3BtZW50MQ4w
        DAYDVQQDEwVUZUh1aTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAIrbx0vPJzvPKuSt
        771Wzu3YGzaY80CykeuPONAtEqOoEX/3Pb3MJ2Vom7EmiG7s/qdmUXD652dMh1uNUcYNO6dG+J8F
        l+wS/YLDfax+6+UAz9YLNL2atNK111RxFzoHHDra4qSdEut06ik1j5deLE6+TD24AH+bOAYT/iuL
        UP119hlGG2xU6TV7SseeF2pbxHKjPDZgKfaO2mELHjar4yZABWT20TeBxE3ClhD2KMshFSkQF4Uz
        YGqUHKn630cN0Djs3GH+xPzsW9p3rrwxYhUxbEzwKzny6hQTn4aKU9udzOW/9bOMkdyIE1l6gOUU
        NPKjYAcIxF00oMeah4N7IWkCAwEAAaMhMB8wHQYDVR0OBBYEFLn0+TcrnE92AJsHCdcgCJS/1YBC
        MA0GCSqGSIb3DQEBCwUAA4IBAQAQ23Jv1/ZT51tycsICSzoCWrNmv+lfonSyWIVXy9C0cR5/be1t
        dJCozEFLrm1cAxeetdrD2Zmee9CGyqm9ZPSD4FRZNEZJrfrIzEgszrY8qP7Ql+6MWGl1DbctAcUQ
        rkOZhn3kKuYnEu+Ny4UtF1ckBPQ2ZjM8ADqPajkO2PavX1OTvhBOI2/jQr0zbCWXjIo43v90nlC3
        QHWVoVOEONtJYteiLBp2Zju5VJhlmo3xp8OUjgC6O5mZkpTmgrQ4E8wjSOx1EGk5VGNi96IXN0Ax
        ldxarp7fQoDKtw02uHMZMzsjPnueaxaVni0FvotALnuP5zLdALzG1/7FBOjC3CayOJok5IwQay9Z
        7TAl8q3jYZG3mGs=
        EOF
        
        # è§£ç å¯†é’¥æ–‡ä»¶
        base64 -d my-release-key.keystore.b64 > my-release-key.keystore
        
        echo "âœ“ å›ºå®šå¯†é’¥å·²åˆ›å»º"
        
    - name: é…ç½®ç­¾åï¼ˆä¸¤ä¸ªç‰ˆæœ¬ï¼‰
      run: |
        echo "=== é…ç½® APK ç­¾å ==="
        
        # åˆ›å»º Python è„šæœ¬æ¥æ’å…¥ç­¾åé…ç½®
        cat > insert_signing.py << 'PYTHON_EOF'
        import re
        import sys
        
        gradle_file = sys.argv[1]
        
        with open(gradle_file, 'r') as f:
            content = f.read()
        
        # åœ¨ android { åŽæ’å…¥ signingConfigs
        signing_config = '''
            signingConfigs {
                release {
                    storeFile file("../my-release-key.keystore")
                    storePassword "tehui2024"
                    keyAlias "tehui"
                    keyPassword "tehui2024"
                }
            }
        '''
        content = re.sub(r'(android\s*\{)', r'\1' + signing_config, content, count=1)
        
        # åœ¨ buildTypes.release { åŽæ’å…¥ signingConfig
        content = re.sub(r'(buildTypes\s*\{[^}]*release\s*\{)', r'\1\n            signingConfig signingConfigs.release', content, count=1)
        
        with open(gradle_file, 'w') as f:
            f.write(content)
        
        print(f"âœ“ {gradle_file} ç­¾åé…ç½®å·²æ’å…¥")
        PYTHON_EOF
        
        # å¤åˆ¶å¯†é’¥æ–‡ä»¶åˆ°ä¸¤ä¸ªç›®å½•
        cp my-release-key.keystore android/
        cp my-release-key.keystore android-offline/
        
        # é…ç½®åœ¨çº¿ç‰ˆç­¾å
        echo "=== é…ç½®åœ¨çº¿ç‰ˆç­¾å ==="
        python3 insert_signing.py android/app/build.gradle
        
        # é…ç½®ç¦»çº¿ç‰ˆç­¾å
        echo "=== é…ç½®ç¦»çº¿ç‰ˆç­¾å ==="
        python3 insert_signing.py android-offline/app/build.gradle
        
        echo ""
        echo "âœ“ ä¸¤ä¸ªç‰ˆæœ¬ç­¾åé…ç½®å®Œæˆ"
      
    - name: æŽˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: |
        chmod +x android/gradlew
        chmod +x android-offline/gradlew
        
    - name: æž„å»ºåœ¨çº¿ç‰ˆ APK
      run: |
        echo "=== æž„å»ºåœ¨çº¿ç‰ˆ APK ==="
        cd android
        
        # è®¾ç½® Gradle å±žæ€§
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << 'EOF'
        org.gradle.daemon=false
        org.gradle.parallel=true
        org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m
        systemProp.http.connectionTimeout=60000
        systemProp.http.socketTimeout=60000
        EOF
        
        # æž„å»ºåœ¨çº¿ç‰ˆ APK
        if ./gradlew clean assembleRelease --stacktrace --no-daemon; then
          echo "âœ“ åœ¨çº¿ç‰ˆ APK æž„å»ºæˆåŠŸ"
          cd ..
        else
          echo "âœ— åœ¨çº¿ç‰ˆ APK æž„å»ºå¤±è´¥"
          cd ..
          exit 1
        fi
        
    - name: æž„å»ºç¦»çº¿ç‰ˆ APK
      run: |
        echo "=== æž„å»ºç¦»çº¿ç‰ˆ APK ==="
        cd android-offline
        
        # æž„å»ºç¦»çº¿ç‰ˆ APK
        if ./gradlew clean assembleRelease --stacktrace --no-daemon; then
          echo "âœ“ ç¦»çº¿ç‰ˆ APK æž„å»ºæˆåŠŸ"
          cd ..
        else
          echo "âœ— ç¦»çº¿ç‰ˆ APK æž„å»ºå¤±è´¥"
          cd ..
          exit 1
        fi
        
    - name: éªŒè¯å’Œé‡å‘½å APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        echo "=== å¤„ç†åœ¨çº¿ç‰ˆ APK ==="
        cd android/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            ONLINE_NAME="TeHui-Online-v${VERSION}.apk"
            cp "$apk" "../../../../../../$ONLINE_NAME"
            echo "âœ“ åœ¨çº¿ç‰ˆ: $ONLINE_NAME"
            echo "  å¤§å°: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== å¤„ç†ç¦»çº¿ç‰ˆ APK ==="
        cd android-offline/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            OFFLINE_NAME="TeHui-Offline-v${VERSION}.apk"
            cp "$apk" "../../../../../../$OFFLINE_NAME"
            echo "âœ“ ç¦»çº¿ç‰ˆ: $OFFLINE_NAME"
            echo "  å¤§å°: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== æœ€ç»ˆç”Ÿæˆçš„ APK ==="
        ls -lh TeHui-*.apk
        
        echo ""
        echo "=== å¤§å°å¯¹æ¯” ==="
        du -h TeHui-Online-*.apk
        du -h TeHui-Offline-*.apk
        
    - name: ä¸Šä¼  APK åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: TeHui-*.apk
        
    - name: åˆ›å»º Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TeHui-*.apk
        body: |
          ## ðŸ“± ç‰¹ä¼šä¿¡æ¯ ${{ github.ref_name }}
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          æœ¬ç‰ˆæœ¬æä¾›ä¸¤ç§ APK åŒ…ï¼Œè¯·æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š
          
          #### ðŸŒ åœ¨çº¿ç‰ˆï¼ˆæŽ¨èï¼‰- çº¦ 3-5 MB
          - æ–‡ä»¶åï¼š`TeHui-Online-${{ github.ref_name }}.apk`
          - ç‰¹ç‚¹ï¼šè½»é‡çº§åº”ç”¨å£³ï¼Œä»ŽæœåŠ¡å™¨åŠ¨æ€åŠ è½½å†…å®¹
          - ä¼˜åŠ¿ï¼š
            - å®‰è£…åŒ…å°ï¼Œä¸‹è½½å¿«
            - å†…å®¹è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€é‡è£… APK
            - æ”¯æŒå¤šæœåŠ¡å™¨åˆ‡æ¢ï¼ˆé•¿æŒ‰ Logoï¼‰
            - è‡ªåŠ¨æ£€æŸ¥ APK æ›´æ–°ï¼ˆç‚¹å‡» Logo 10 æ¬¡ï¼‰
            - PWA ç¼“å­˜ï¼Œæ”¯æŒç¦»çº¿æµè§ˆå·²åŠ è½½å†…å®¹
          - é€‚åˆï¼šç½‘ç»œæ¡ä»¶è‰¯å¥½ï¼Œå¸Œæœ›éšæ—¶èŽ·å–æœ€æ–°å†…å®¹
          
          #### ðŸ’¾ ç¦»çº¿ç‰ˆ - çº¦ 50-100 MB
          - æ–‡ä»¶åï¼š`TeHui-Offline-${{ github.ref_name }}.apk`
          - ç‰¹ç‚¹ï¼šåŒ…å«æ‰€æœ‰å†…å®¹ï¼Œå®Œå…¨ç¦»çº¿ä½¿ç”¨
          - ä¼˜åŠ¿ï¼š
            - æ— éœ€ç½‘ç»œå³å¯ä½¿ç”¨
            - æ‰€æœ‰å†…å®¹é¢„è£…ï¼Œæ‰“å¼€å³ç”¨
            - é€‚åˆç½‘ç»œä¸ç¨³å®šæˆ–æ— ç½‘ç»œçŽ¯å¢ƒ
          - æ³¨æ„ï¼šå†…å®¹æ›´æ–°éœ€è¦é‡æ–°ä¸‹è½½å®‰è£…æ–°ç‰ˆæœ¬ APK
          
          ### âš ï¸ å®‰è£…æç¤º
          
          å¦‚æžœå®‰è£…æ—¶æç¤º"è§£æžåŒ…å‡ºçŽ°é—®é¢˜"ï¼š
          1. ç¡®è®¤ä¸‹è½½å®Œæ•´ï¼ˆæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼‰
          2. æ¸…é™¤æ—§ç‰ˆæœ¬åŽé‡æ–°å®‰è£…
          3. ç¡®ä¿å®‰å“ç‰ˆæœ¬ â‰¥ 5.1ï¼ˆAPI 22ï¼‰
          4. å°è¯•åœ¨è®¾ç½®ä¸­æ¸…é™¤ä¸‹è½½ç®¡ç†å™¨çš„ç¼“å­˜
          5. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†"æœªçŸ¥æ¥æº"å®‰è£…æƒé™
          
          ### ðŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬å·: ${{ github.ref_name }}
          - åŒ…å: com.tehui.app
          - ç­¾åçŠ¶æ€: âœ… å·²ç­¾åï¼ˆå¯è¦†ç›–å®‰è£…ï¼‰
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - è¦æ±‚ï¼šå®‰å“ 5.1 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆAPI 22+ï¼‰
          
          ### ðŸš€ ä½¿ç”¨è¯´æ˜Ž
          
          **åœ¨çº¿ç‰ˆï¼š**
          1. ä¸‹è½½å¹¶å®‰è£… `TeHui-Online-*.apk`
          2. æ‰“å¼€åº”ç”¨ï¼Œè‡ªåŠ¨ä»ŽæœåŠ¡å™¨åŠ è½½å†…å®¹
          3. é•¿æŒ‰ Logo å¯åˆ‡æ¢æœåŠ¡å™¨
          4. ç‚¹å‡» Logo 10 æ¬¡å¯æ£€æŸ¥ APK æ›´æ–°
          5. å†…å®¹ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œæ”¯æŒç¦»çº¿æµè§ˆ
          
          **ç¦»çº¿ç‰ˆï¼š**
          1. ä¸‹è½½å¹¶å®‰è£… `TeHui-Offline-*.apk`
          2. æ‰“å¼€åº”ç”¨ï¼Œç›´æŽ¥ä½¿ç”¨é¢„è£…å†…å®¹
          3. æ— éœ€ç½‘ç»œè¿žæŽ¥
          
          ### ðŸ’¡ é€‰æ‹©å»ºè®®
          - âœ… æŽ¨èåœ¨çº¿ç‰ˆï¼šé€‚åˆå¤§å¤šæ•°ç”¨æˆ·ï¼Œä½“ç§¯å°ï¼Œå†…å®¹è‡ªåŠ¨æ›´æ–°
          - ðŸ’¾ é€‰æ‹©ç¦»çº¿ç‰ˆï¼šç½‘ç»œä¸ç¨³å®šæˆ–éœ€è¦å®Œå…¨ç¦»çº¿ä½¿ç”¨æ—¶
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
