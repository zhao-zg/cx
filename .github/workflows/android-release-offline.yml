name: ÊûÑÂª∫Á¶ªÁ∫øÁâàAPK

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ê£ÄÂá∫‰ª£Á†Å
      uses: actions/checkout@v4
      
    - name: ËÆæÁΩÆ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: ËÆæÁΩÆ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ËÆæÁΩÆ Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ÂÆâË£Ö LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: ÂÆâË£Ö Python ‰æùËµñ
      run: pip install -r requirements.txt
      
    - name: ÊèêÂèñÂπ∂ÈÖçÁΩÆÁâàÊú¨Âè∑
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "=== ÁâàÊú¨Âè∑: $VERSION ==="
        
        # Êõ¥Êñ∞ app_config.json
        echo "Êõ¥Êñ∞ app_config.json..."
        python3 << PYTHON_EOF
        import json
        
        with open('app_config.json', 'r', encoding='utf-8') as f:
            config = json.load(f)
        
        config['version'] = '$VERSION'
        
        with open('app_config.json', 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        
        print(f'‚úì app_config.json ÁâàÊú¨Âè∑Â∑≤Êõ¥Êñ∞‰∏∫: $VERSION')
        PYTHON_EOF
        
        # È™åËØÅ
        cat app_config.json | grep version
        echo ""
      
    - name: ÂÆâË£Ö Node.js ‰æùËµñ
      run: |
        npm install
        echo "‚úì Node.js ‰æùËµñÂÆâË£ÖÂÆåÊàê"
        npm list --depth=0 | grep capacitor || echo "Êó†"
      
    - name: ÁîüÊàêÂÆåÊï¥ÈùôÊÄÅÁΩëÁ´ô
      run: |
        echo "=== ÁîüÊàêÂÆåÊï¥ÈùôÊÄÅÁΩëÁ´ô ==="
        python main.py
        echo "‚úì ÈùôÊÄÅÁΩëÁ´ôÁîüÊàêÂÆåÊàê"
        du -sh output/
        find output/ -type f | wc -l
        echo "Êñá‰ª∂ÊÄªÊï∞"
        
    - name: ÁîüÊàêÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
      run: |
        echo "=== ÁîüÊàêÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂ ==="
        python generate_version.py
        echo "‚úì ÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂Â∑≤ÁîüÊàê"
        
        echo "=== ÁîüÊàêÁÉ≠Êõ¥Êñ∞ÂåÖ ==="
        python generate_hot_update_package.py
        echo "‚úì ÁÉ≠Êõ¥Êñ∞ÂåÖÂ∑≤ÁîüÊàê"
        
        # È™åËØÅ version.json
        if [ -f "output/version.json" ]; then
          echo ""
          echo "=== version.json ÂÜÖÂÆπ ==="
          cat output/version.json | head -20
        else
          echo "‚ö†Ô∏è Ë≠¶Âëä: version.json Êú™ÁîüÊàê"
        fi
        
        # È™åËØÅÁÉ≠Êõ¥Êñ∞ÂåÖ
        echo ""
        echo "=== ÁÉ≠Êõ¥Êñ∞ÂåÖ ==="
        ls -lh output/*.zip || echo "‚ö†Ô∏è Ë≠¶Âëä: ÁÉ≠Êõ¥Êñ∞ÂåÖÊú™ÁîüÊàê"
    
    - name: Ê∏ÖÁêÜÁÉ≠Êõ¥Êñ∞ÂåÖÔºàÈÅøÂÖçÊâìÂåÖËøõ APKÔºâ
      run: |
        echo "=== Ê∏ÖÁêÜÁÉ≠Êõ¥Êñ∞ÂåÖ ==="
        
        # Âà†Èô§ÁÉ≠Êõ¥Êñ∞ ZIPÔºàAPK Â∑≤ÂåÖÂê´ÂÆåÊï¥ËµÑÊ∫êÔºå‰∏çÈúÄË¶ÅÈáçÂ§çÊâìÂåÖÔºâ
        rm -f output/*.zip
        echo "‚úì ÁÉ≠Êõ¥Êñ∞ÂåÖÂ∑≤Âà†Èô§"
        
        # ‰øùÁïô version.jsonÔºàÁî®‰∫éÊ†áËÆ∞ APK ÂÜÖÁΩÆËµÑÊ∫êÁöÑÁâàÊú¨Âè∑Ôºâ
        if [ -f output/version.json ]; then
          echo "‚úì version.json Â∑≤‰øùÁïôÔºàËµÑÊ∫êÁâàÊú¨Ê†áËÆ∞Ôºâ"
          cat output/version.json | head -10
        fi
        
    - name: Ê∑ªÂä† Android Âπ≥Âè∞
      run: |
        echo "=== Ê∑ªÂä† Android Âπ≥Âè∞ ==="
        npx cap add android
        
        if [ ! -d "android" ]; then
          echo "‚úó Android Âπ≥Âè∞Ê∑ªÂä†Â§±Ë¥•"
          exit 1
        fi
        
        echo "‚úì Android Âπ≥Âè∞Ê∑ªÂä†ÂÆåÊàê"
        du -sh android/app/src/main/assets/
    
    - name: ÈÖçÁΩÆ Android ÂõæÊ†áÔºà‰ΩøÁî®È¢ÑÁîüÊàêÁöÑ PNGÔºâ
      run: |
        echo "=== ÈÖçÁΩÆ Android ÂõæÊ†á ==="
        
        # Ê£ÄÊü•È¢ÑÁîüÊàêÁöÑÂõæÊ†áÁõÆÂΩï
        if [ ! -d "android_icons" ]; then
          echo "‚úó ÈîôËØØ: Êâæ‰∏çÂà∞ android_icons ÁõÆÂΩï"
          exit 1
        fi
        
        # Â§çÂà∂È¢ÑÁîüÊàêÁöÑÂõæÊ†áÂà∞ Android È°πÁõÆ
        echo "Â§çÂà∂È¢ÑÁîüÊàêÁöÑÂõæÊ†á..."
        cp -r android_icons/* android/app/src/main/res/
        
        # È™åËØÅÂõæÊ†á
        echo ""
        echo "=== È™åËØÅÂõæÊ†á ==="
        for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
          icon_file="android/app/src/main/res/mipmap-$density/ic_launcher.png"
          if [ -f "$icon_file" ]; then
            size=$(du -h "$icon_file" | cut -f1)
            echo "‚úì mipmap-$density/ic_launcher.png ($size)"
          else
            echo "‚úó mipmap-$density/ic_launcher.png ‰∏çÂ≠òÂú®"
          fi
        done
        
        echo ""
        echo "‚úì Android ÂõæÊ†áÈÖçÁΩÆÂÆåÊàê"
      
    - name: ÈÖçÁΩÆ Android ÁâàÊú¨‰ø°ÊÅØ
      run: |
        echo "=== ÈÖçÁΩÆ Android ÁâàÊú¨‰ø°ÊÅØ ==="
        
        # ‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáè‰∏≠ÁöÑ VERSION
        VERSION=${{ env.VERSION }}
        
        # ËÆ°ÁÆó versionCode
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # ÂàõÂª∫ variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # ÈÖçÁΩÆÁâàÊú¨Âè∑
        echo "ÂΩìÂâçÁâàÊú¨: $VERSION"
        echo "ÁâàÊú¨‰ª£Á†Å: $VERSION_CODE"
        
        # ‰ΩøÁî® Python ËÑöÊú¨Êù•ÂèØÈù†Âú∞‰øÆÊîπ build.gradle
        cat > update_version.py << 'PYTHON_EOF'
        import re
        import sys
        
        gradle_file = 'android/app/build.gradle'
        version_code = sys.argv[1]
        version_name = sys.argv[2]
        
        with open(gradle_file, 'r') as f:
            content = f.read()
        
        # ÊõøÊç¢ÊàñÊ∑ªÂä† versionCode
        if re.search(r'versionCode\s+\d+', content):
            content = re.sub(r'versionCode\s+\d+', f'versionCode {version_code}', content)
            print(f'‚úì ÊõøÊç¢ versionCode: {version_code}')
        else:
            content = re.sub(r'(defaultConfig\s*\{)', rf'\1\n        versionCode {version_code}', content)
            print(f'‚úì ÊèíÂÖ• versionCode: {version_code}')
        
        # ÊõøÊç¢ÊàñÊ∑ªÂä† versionName
        if re.search(r'versionName\s+"[^"]*"', content):
            content = re.sub(r'versionName\s+"[^"]*"', f'versionName "{version_name}"', content)
            print(f'‚úì ÊõøÊç¢ versionName: {version_name}')
        else:
            content = re.sub(r'(defaultConfig\s*\{)', rf'\1\n        versionName "{version_name}"', content)
            print(f'‚úì ÊèíÂÖ• versionName: {version_name}')
        
        # Á°Æ‰øùÊúâ namespace
        if not re.search(r'namespace\s+["\']', content):
            content = re.sub(r'(android\s*\{)', r'\1\n    namespace "com.tehui.offline"', content)
            print('‚úì ÊèíÂÖ• namespace: com.tehui.offline')
        
        with open(gradle_file, 'w') as f:
            f.write(content)
        
        print(f'\n‚úì ÁâàÊú¨ÈÖçÁΩÆÂÆåÊàê: versionCode={version_code}, versionName={version_name}')
        PYTHON_EOF
        
        python3 update_version.py "$VERSION_CODE" "$VERSION"
        
        # È™åËØÅÁâàÊú¨Âè∑ÊòØÂê¶Ê≠£Á°ÆÊ≥®ÂÖ•
        echo ""
        echo "=== È™åËØÅ build.gradle ‰∏≠ÁöÑÁâàÊú¨‰ø°ÊÅØ ==="
        grep -A 10 "defaultConfig" android/app/build.gradle | grep -E "(versionCode|versionName)" || echo "Ë≠¶Âëä: Êú™ÊâæÂà∞ÁâàÊú¨‰ø°ÊÅØ"
        
        echo ""
      
    - name: ÂêåÊ≠• Capacitor
      run: |
        echo "=== ÂêåÊ≠• Capacitor ==="
        npx cap sync android
        echo "‚úì ÂêåÊ≠•ÂÆåÊàê"
        
        echo ""
        echo "=== È™åËØÅËµÑÊ∫êÂ§ßÂ∞è ==="
        du -sh android/app/src/main/assets/
        find android/app/src/main/assets/ -type f | wc -l
    
    - name: ÈáçÊñ∞Â∫îÁî®Ëá™ÂÆö‰πâÂõæÊ†áÔºàsync ÂêéÔºâ
      run: |
        echo "=== ÈáçÊñ∞Â∫îÁî®Ëá™ÂÆö‰πâÂõæÊ†á ==="
        echo "Ê≥®ÊÑèÔºöcap sync ÂèØËÉΩ‰ºöË¶ÜÁõñÂõæÊ†áÔºåÈúÄË¶ÅÈáçÊñ∞Â§çÂà∂"
        
        # Âà†Èô§ÂèØËÉΩÂ≠òÂú®ÁöÑÈªòËÆ§ÂõæÊ†á
        rm -rf android/app/src/main/res/mipmap-*
        
        # Â§çÂà∂È¢ÑÁîüÊàêÁöÑÂõæÊ†á
        cp -r android_icons/* android/app/src/main/res/
        
        # È™åËØÅÂõæÊ†áÂ∑≤Â§çÂà∂
        echo ""
        echo "=== È™åËØÅÂõæÊ†áÊñá‰ª∂ ==="
        for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
          launcher="android/app/src/main/res/mipmap-$density/ic_launcher.png"
          round="android/app/src/main/res/mipmap-$density/ic_launcher_round.png"
          if [ -f "$launcher" ]; then
            echo "‚úì mipmap-$density/ic_launcher.png ($(du -h "$launcher" | cut -f1))"
          else
            echo "‚úó mipmap-$density/ic_launcher.png Áº∫Â§±"
          fi
          if [ -f "$round" ]; then
            echo "‚úì mipmap-$density/ic_launcher_round.png ($(du -h "$round" | cut -f1))"
          else
            echo "‚úó mipmap-$density/ic_launcher_round.png Áº∫Â§±"
          fi
        done
        
        # Á°Æ‰øù AndroidManifest.xml ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂõæÊ†á
        echo ""
        echo "=== ÈÖçÁΩÆ AndroidManifest.xml ÂõæÊ†áÂºïÁî® ==="
        
        manifest_file="android/app/src/main/AndroidManifest.xml"
        
        # Á°Æ‰øù‰ΩøÁî® @mipmap/ic_launcher
        if grep -q 'android:icon=' "$manifest_file"; then
          sed -i 's/android:icon="[^"]*"/android:icon="@mipmap\/ic_launcher"/' "$manifest_file"
          echo "‚úì ËÆæÁΩÆ android:icon=@mipmap/ic_launcher"
        else
          sed -i 's/<application/<application android:icon="@mipmap\/ic_launcher"/' "$manifest_file"
          echo "‚úì Ê∑ªÂä† android:icon=@mipmap/ic_launcher"
        fi
        
        # Á°Æ‰øù‰ΩøÁî® @mipmap/ic_launcher_round
        if grep -q 'android:roundIcon=' "$manifest_file"; then
          sed -i 's/android:roundIcon="[^"]*"/android:roundIcon="@mipmap\/ic_launcher_round"/' "$manifest_file"
          echo "‚úì ËÆæÁΩÆ android:roundIcon=@mipmap/ic_launcher_round"
        else
          sed -i 's/<application/<application android:roundIcon="@mipmap\/ic_launcher_round"/' "$manifest_file"
          echo "‚úì Ê∑ªÂä† android:roundIcon=@mipmap/ic_launcher_round"
        fi
        
        echo ""
        echo "=== È™åËØÅ AndroidManifest.xml ==="
        grep -E 'android:(icon|roundIcon)=' "$manifest_file" || echo "Ë≠¶ÂëäÔºöÊú™ÊâæÂà∞ÂõæÊ†áÈÖçÁΩÆ"
        
        echo ""
        echo "‚úì Ëá™ÂÆö‰πâÂõæÊ†áÂ∑≤ÈáçÊñ∞Â∫îÁî®Âπ∂ÈÖçÁΩÆÂÆåÊàê"
      
    - name: ÈÖçÁΩÆÁΩëÁªúÂÆâÂÖ®Á≠ñÁï•
      run: |
        echo "=== ÈÖçÁΩÆÁΩëÁªúÂÆâÂÖ®Á≠ñÁï• ==="
        mkdir -p android/app/src/main/res/xml
        cat > android/app/src/main/res/xml/network_security_config.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <base-config cleartextTrafficPermitted="true">
                <trust-anchors>
                    <certificates src="system" />
                </trust-anchors>
            </base-config>
        </network-security-config>
        EOF
        
        if ! grep -q "networkSecurityConfig" android/app/src/main/AndroidManifest.xml; then
          sed -i 's/<application/<application android:networkSecurityConfig="@xml\/network_security_config"/' android/app/src/main/AndroidManifest.xml
        fi
        
        echo "‚úì ÁΩëÁªúÂÆâÂÖ®ÈÖçÁΩÆÂÆåÊàê"
        
        echo ""
        echo "=== È™åËØÅ AndroidManifest.xml ==="
        echo "Ê£ÄÊü• TTS Áõ∏ÂÖ≥ÈÖçÁΩÆ..."
        
        # TTS ‰∏çÈúÄË¶ÅÁâπÊÆäÊùÉÈôêÔºå‰ΩÜÊàë‰ª¨ÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∫õ‰ºòÂåñÈÖçÁΩÆ
        # Á°Æ‰øùÂ∫îÁî®ÂêçÁß∞Ê≠£Á°Æ
        if grep -q "android:label=" android/app/src/main/AndroidManifest.xml; then
          sed -i 's/android:label="[^"]*"/android:label="Áâπ‰ºö"/' android/app/src/main/AndroidManifest.xml
          echo "‚úì Â∫îÁî®ÂêçÁß∞Â∑≤ËÆæÁΩÆ‰∏∫ Áâπ‰ºö"
        fi
        
        # ÊòæÁ§∫ AndroidManifest.xml ÁöÑÂÖ≥ÈîÆÈÉ®ÂàÜ
        echo ""
        echo "AndroidManifest.xml ÂÖ≥ÈîÆÈÖçÁΩÆ:"
        grep -A 3 "<application" android/app/src/main/AndroidManifest.xml | head -5
        
        echo ""
        echo "‚úì AndroidManifest ÈÖçÁΩÆÂÆåÊàê"
      
    - name: ÂàõÂª∫Á≠æÂêçÂØÜÈí•
      run: |
        echo "=== ÂàõÂª∫Á≠æÂêçÂØÜÈí• ==="
        cat > offline-key.keystore.b64 << 'EOF'
        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
        7TAl8q3jYZG3mGs=
        EOF
        
        base64 -d offline-key.keystore.b64 > offline-key.keystore
        cp offline-key.keystore android/
        echo "‚úì Á≠æÂêçÂØÜÈí•Â∑≤ÂàõÂª∫"
      
    - name: ÈÖçÁΩÆÁ≠æÂêç
      run: |
        echo "=== ÈÖçÁΩÆ APK Á≠æÂêç ==="
        
        cat > insert_signing.py << 'PYTHON_EOF'
        import re
        import sys
        
        gradle_file = sys.argv[1]
        keystore_file = sys.argv[2]
        
        with open(gradle_file, 'r') as f:
            content = f.read()
        
        signing_config = f'''
            signingConfigs {{
                release {{
                    storeFile file("../{keystore_file}")
                    storePassword "tehui2024"
                    keyAlias "tehui"
                    keyPassword "tehui2024"
                }}
            }}
        '''
        content = re.sub(r'(android\s*\{)', r'\1' + signing_config, content, count=1)
        content = re.sub(r'(buildTypes\s*\{[^}]*release\s*\{)', r'\1\n            signingConfig signingConfigs.release', content, count=1)
        
        with open(gradle_file, 'w') as f:
            f.write(content)
        
        print(f"‚úì {gradle_file} Á≠æÂêçÈÖçÁΩÆÂ∑≤ÊèíÂÖ•")
        PYTHON_EOF
        
        python3 insert_signing.py android/app/build.gradle offline-key.keystore
        echo "‚úì Á≠æÂêçÈÖçÁΩÆÂÆåÊàê"
      
    - name: Êéà‰∫à Gradle ÊâßË°åÊùÉÈôê
      run: chmod +x android/gradlew
        
    - name: ÊûÑÂª∫ APK
      run: |
        echo "=== ÊûÑÂª∫ APK ==="
        cd android
        
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << 'EOF'
        org.gradle.daemon=false
        org.gradle.parallel=true
        org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m
        systemProp.http.connectionTimeout=60000
        systemProp.http.socketTimeout=60000
        EOF
        
        if ./gradlew clean assembleRelease --stacktrace --no-daemon; then
          echo "‚úì APK ÊûÑÂª∫ÊàêÂäü"
          cd ..
        else
          echo "‚úó APK ÊûÑÂª∫Â§±Ë¥•"
          cd ..
          exit 1
        fi
        
    - name: È™åËØÅÂíåÈáçÂëΩÂêç APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        echo "=== Â§ÑÁêÜ APK ==="
        cd android/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            APK_NAME="TeHui-v${VERSION}.apk"
            cp "$apk" "../../../../../../$APK_NAME"
            echo "‚úì APK: $APK_NAME"
            echo "  Â§ßÂ∞è: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== ÊúÄÁªàÁîüÊàêÁöÑ APK ==="
        ls -lh TeHui-*.apk
        
    - name: ‰∏ä‰º† APK Âà∞ Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: TeHui-*.apk
        
    - name: ÂàõÂª∫ Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TeHui-*.apk
        body: |
          ## üì± Áâπ‰ºö‰ø°ÊÅØ ${{ github.ref_name }}
          
          ### üì¶ ‰∏ãËΩΩËØ¥Êòé
          
          **Á¶ªÁ∫øÁâà APK** - Á∫¶ 50-100 MB
          - Êñá‰ª∂ÂêçÔºö`TeHui-${{ github.ref_name }}.apk`
          - ÁâπÁÇπÔºöÂåÖÂê´ÊâÄÊúâÂÜÖÂÆπÔºåÂÆåÂÖ®Á¶ªÁ∫ø‰ΩøÁî®
          - ‰ºòÂäøÔºö
            - Êó†ÈúÄÁΩëÁªúÂç≥ÂèØ‰ΩøÁî®
            - ÊâÄÊúâÂÜÖÂÆπÈ¢ÑË£ÖÔºåÊâìÂºÄÂç≥Áî®
            - ÈÄÇÂêàÁΩëÁªú‰∏çÁ®≥ÂÆöÊàñÊó†ÁΩëÁªúÁéØÂ¢É
          - Ê≥®ÊÑèÔºöÂÜÖÂÆπÊõ¥Êñ∞ÈúÄË¶ÅÈáçÊñ∞‰∏ãËΩΩÂÆâË£ÖÊñ∞ÁâàÊú¨ APK
          
          ### üí° Âú®Á∫øÁâàÊõø‰ª£ÊñπÊ°à
          
          Â¶ÇÊûúÊÇ®ÊÉ≥Ë¶ÅËΩªÈáèÁ∫ßÁöÑÂú®Á∫øÁâàÊú¨ÔºåÊé®Ëçê‰ΩøÁî® **PWAÔºàÊ∏êËøõÂºè Web Â∫îÁî®Ôºâ**Ôºö
          
          1. ‰ΩøÁî®ÊµèËßàÂô®ËÆøÈóÆÔºöhttps://cx.zhaozg.cloudns.org/
          2. ÁÇπÂáªÊµèËßàÂô®ËèúÂçï‰∏≠ÁöÑ"Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï"Êàñ"ÂÆâË£Ö"
          3. PWA ‰ºöÂÉè APP ‰∏ÄÊ†∑ÊòæÁ§∫Âú®‰∏ªÂ±èÂπï‰∏ä
          4. ‰ºòÂäøÔºö
             - ËΩªÈáèÁ∫ßÔºàÂá† MBÔºâ
             - ÂÜÖÂÆπËá™Âä®Êõ¥Êñ∞
             - ÊîØÊåÅÁ¶ªÁ∫øÊµèËßàÔºàService Worker ÁºìÂ≠òÔºâ
             - Êó†ÈúÄ‰∏ãËΩΩ APK
          
          ### ‚ö†Ô∏è ÂÆâË£ÖÊèêÁ§∫
          
          Â¶ÇÊûúÂÆâË£ÖÊó∂ÊèêÁ§∫"Ëß£ÊûêÂåÖÂá∫Áé∞ÈóÆÈ¢ò"Ôºö
          1. Á°ÆËÆ§‰∏ãËΩΩÂÆåÊï¥ÔºàÊ£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºâ
          2. Ê∏ÖÈô§ÊóßÁâàÊú¨ÂêéÈáçÊñ∞ÂÆâË£Ö
          3. Á°Æ‰øùÂÆâÂçìÁâàÊú¨ ‚â• 5.1ÔºàAPI 22Ôºâ
          4. Â∞ùËØïÂú®ËÆæÁΩÆ‰∏≠Ê∏ÖÈô§‰∏ãËΩΩÁÆ°ÁêÜÂô®ÁöÑÁºìÂ≠ò
          5. Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫Ü"Êú™Áü•Êù•Ê∫ê"ÂÆâË£ÖÊùÉÈôê
          
          ### üìù ÁâàÊú¨‰ø°ÊÅØ
          - ÁâàÊú¨Âè∑: ${{ github.ref_name }}
          - ÂåÖÂêç: com.tehui.offline
          - Á≠æÂêçÁä∂ÊÄÅ: ‚úÖ Â∑≤Á≠æÂêçÔºàÂèØË¶ÜÁõñÂÆâË£ÖÔºâ
          - ÊûÑÂª∫Êó∂Èó¥: ${{ github.event.head_commit.timestamp }}
          - Ë¶ÅÊ±ÇÔºöÂÆâÂçì 5.1 ÊàñÊõ¥È´òÁâàÊú¨ÔºàAPI 22+Ôºâ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
