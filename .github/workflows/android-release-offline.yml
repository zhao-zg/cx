name: æ„å»ºç¦»çº¿ç‰ˆAPK

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: è®¾ç½® Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: å®‰è£… LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: å®‰è£… Python ä¾èµ–
      run: pip install -r requirements.txt
      
    - name: æå–å¹¶é…ç½®ç‰ˆæœ¬å·
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION="0.1.0"
        fi
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "=== ç‰ˆæœ¬å·: $VERSION ==="
        
        # æ›´æ–° app_config.json
        echo "æ›´æ–° app_config.json..."
        python3 << PYTHON_EOF
        import json
        
        with open('app_config.json', 'r', encoding='utf-8') as f:
            config = json.load(f)
        
        config['version'] = '$VERSION'
        
        with open('app_config.json', 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        
        print(f'âœ“ app_config.json ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º: $VERSION')
        PYTHON_EOF
        
        # éªŒè¯
        cat app_config.json | grep version
        echo ""
      
    - name: å®‰è£… Node.js ä¾èµ–
      run: |
        npm install
        echo "âœ“ Node.js ä¾èµ–å®‰è£…å®Œæˆ"
        npm list --depth=0 | grep capacitor || echo "æ— "
      
    - name: ç”Ÿæˆå®Œæ•´é™æ€ç½‘ç«™
      run: |
        echo "=== ç”Ÿæˆå®Œæ•´é™æ€ç½‘ç«™ ==="
        python main.py
        echo "âœ“ é™æ€ç½‘ç«™ç”Ÿæˆå®Œæˆ"
        du -sh output/
        find output/ -type f | wc -l
        echo "æ–‡ä»¶æ€»æ•°"
        
    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      run: |
        echo "=== ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ ==="
        python generate_version.py
        echo "âœ“ ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶å·²ç”Ÿæˆ"
        
        echo "=== ç”Ÿæˆçƒ­æ›´æ–°åŒ… ==="
        python generate_hot_update_package.py
        echo "âœ“ çƒ­æ›´æ–°åŒ…å·²ç”Ÿæˆ"
        
        # éªŒè¯ version.json
        if [ -f "output/version.json" ]; then
          echo ""
          echo "=== version.json å†…å®¹ ==="
          cat output/version.json | head -20
        else
          echo "âš ï¸ è­¦å‘Š: version.json æœªç”Ÿæˆ"
        fi
        
        # éªŒè¯çƒ­æ›´æ–°åŒ…
        echo ""
        echo "=== çƒ­æ›´æ–°åŒ… ==="
        ls -lh output/*.zip || echo "âš ï¸ è­¦å‘Š: çƒ­æ›´æ–°åŒ…æœªç”Ÿæˆ"
    
    - name: æ¸…ç†çƒ­æ›´æ–°åŒ…ï¼ˆé¿å…æ‰“åŒ…è¿› APKï¼‰
      run: |
        echo "=== æ¸…ç†çƒ­æ›´æ–°åŒ… ==="
        
        # åˆ é™¤çƒ­æ›´æ–° ZIPï¼ˆAPK å·²åŒ…å«å®Œæ•´èµ„æºï¼Œä¸éœ€è¦é‡å¤æ‰“åŒ…ï¼‰
        rm -f output/*.zip
        echo "âœ“ çƒ­æ›´æ–°åŒ…å·²åˆ é™¤"
        
        # ä¿ç•™ version.jsonï¼ˆç”¨äºæ ‡è®° APK å†…ç½®èµ„æºçš„ç‰ˆæœ¬å·ï¼‰
        if [ -f output/version.json ]; then
          echo "âœ“ version.json å·²ä¿ç•™ï¼ˆèµ„æºç‰ˆæœ¬æ ‡è®°ï¼‰"
          cat output/version.json | head -10
        fi
        
    - name: æ·»åŠ  Android å¹³å°
      run: |
        echo "=== æ·»åŠ  Android å¹³å° ==="
        npx cap add android
        
        if [ ! -d "android" ]; then
          echo "âœ— Android å¹³å°æ·»åŠ å¤±è´¥"
          exit 1
        fi
        
        echo "âœ“ Android å¹³å°æ·»åŠ å®Œæˆ"
        du -sh android/app/src/main/assets/
    
    - name: æ·»åŠ è‡ªå®šä¹‰ APK å®‰è£…æ’ä»¶
      run: |
        echo "=== æ·»åŠ è‡ªå®šä¹‰ APK å®‰è£…æ’ä»¶ ==="
        
        # åˆ›å»ºæ’ä»¶ç›®å½•
        mkdir -p android/app/src/main/java/com/tehui/offline
        
        # å¤åˆ¶ MainActivity.java
        if [ -f "android/app/src/main/java/com/tehui/offline/MainActivity.java" ]; then
          echo "âœ“ MainActivity.java å·²å­˜åœ¨"
        else
          echo "åˆ›å»º MainActivity.java..."
          cat > android/app/src/main/java/com/tehui/offline/MainActivity.java << 'EOF'
        package com.tehui.offline;
        
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                
                // æ³¨å†Œè‡ªå®šä¹‰æ’ä»¶
                registerPlugin(ApkInstallerPlugin.class);
            }
        }
        EOF
          echo "âœ“ MainActivity.java å·²åˆ›å»º"
        fi
        
        # å¤åˆ¶ ApkInstallerPlugin.java
        if [ -f "android/app/src/main/java/com/tehui/offline/ApkInstallerPlugin.java" ]; then
          echo "âœ“ ApkInstallerPlugin.java å·²å­˜åœ¨"
        else
          echo "åˆ›å»º ApkInstallerPlugin.java..."
          cat > android/app/src/main/java/com/tehui/offline/ApkInstallerPlugin.java << 'EOF'
        package com.tehui.offline;
        
        import android.content.Intent;
        import android.net.Uri;
        import android.os.Build;
        import androidx.core.content.FileProvider;
        import com.getcapacitor.JSObject;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import java.io.File;
        
        @CapacitorPlugin(name = "ApkInstaller")
        public class ApkInstallerPlugin extends Plugin {
        
            @PluginMethod
            public void install(PluginCall call) {
                String filePath = call.getString("filePath");
                
                if (filePath == null || filePath.isEmpty()) {
                    call.reject("æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º");
                    return;
                }
                
                try {
                    // ç§»é™¤ file:// å‰ç¼€
                    if (filePath.startsWith("file://")) {
                        filePath = filePath.substring(7);
                    }
                    
                    File file = new File(filePath);
                    
                    if (!file.exists()) {
                        call.reject("æ–‡ä»¶ä¸å­˜åœ¨: " + filePath);
                        return;
                    }
                    
                    Uri uri;
                    
                    // Android 7.0+ ä½¿ç”¨ FileProvider
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
                        uri = FileProvider.getUriForFile(
                            getContext(),
                            getContext().getPackageName() + ".fileprovider",
                            file
                        );
                    } else {
                        uri = Uri.fromFile(file);
                    }
                    
                    Intent intent = new Intent(Intent.ACTION_VIEW);
                    intent.setDataAndType(uri, "application/vnd.android.package-archive");
                    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_GRANT_READ_URI_PERMISSION);
                    
                    getActivity().startActivity(intent);
                    
                    JSObject ret = new JSObject();
                    ret.put("success", true);
                    ret.put("message", "å®‰è£…ç¨‹åºå·²æ‰“å¼€");
                    call.resolve(ret);
                    
                } catch (Exception e) {
                    call.reject("æ‰“å¼€å®‰è£…ç¨‹åºå¤±è´¥: " + e.getMessage());
                }
            }
        }
        EOF
          echo "âœ“ ApkInstallerPlugin.java å·²åˆ›å»º"
        fi
        
        echo ""
        echo "=== éªŒè¯è‡ªå®šä¹‰æ’ä»¶ ==="
        ls -lh android/app/src/main/java/com/tehui/offline/
        echo ""
        echo "âœ“ è‡ªå®šä¹‰ APK å®‰è£…æ’ä»¶å·²æ·»åŠ "
    
    
    - name: é…ç½® Android å›¾æ ‡ï¼ˆä½¿ç”¨é¢„ç”Ÿæˆçš„ PNGï¼‰
      run: |
        echo "=== é…ç½® Android å›¾æ ‡ ==="
        
        # æ£€æŸ¥é¢„ç”Ÿæˆçš„å›¾æ ‡ç›®å½•
        if [ ! -d "android_icons" ]; then
          echo "âœ— é”™è¯¯: æ‰¾ä¸åˆ° android_icons ç›®å½•"
          exit 1
        fi
        
        # å¤åˆ¶é¢„ç”Ÿæˆçš„å›¾æ ‡åˆ° Android é¡¹ç›®
        echo "å¤åˆ¶é¢„ç”Ÿæˆçš„å›¾æ ‡..."
        cp -r android_icons/* android/app/src/main/res/
        
        # éªŒè¯å›¾æ ‡
        echo ""
        echo "=== éªŒè¯å›¾æ ‡ ==="
        for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
          icon_file="android/app/src/main/res/mipmap-$density/ic_launcher.png"
          if [ -f "$icon_file" ]; then
            size=$(du -h "$icon_file" | cut -f1)
            echo "âœ“ mipmap-$density/ic_launcher.png ($size)"
          else
            echo "âœ— mipmap-$density/ic_launcher.png ä¸å­˜åœ¨"
          fi
        done
        
        echo ""
        echo "âœ“ Android å›¾æ ‡é…ç½®å®Œæˆ"
      
    - name: é…ç½® Android ç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "=== é…ç½® Android ç‰ˆæœ¬ä¿¡æ¯ ==="
        
        # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ VERSION
        VERSION=${{ env.VERSION }}
        
        # è®¡ç®— versionCode
        IFS='.' read -ra PARTS <<< "$VERSION"
        VERSION_CODE=$((${PARTS[0]} * 10000 + ${PARTS[1]:-0} * 100 + ${PARTS[2]:-0}))
        
        # åˆ›å»º variables.gradle
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 34
            targetSdkVersion = 34
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF
        
        # é…ç½®ç‰ˆæœ¬å·
        echo "å½“å‰ç‰ˆæœ¬: $VERSION"
        echo "ç‰ˆæœ¬ä»£ç : $VERSION_CODE"
        
        # ä½¿ç”¨ Python è„šæœ¬æ¥å¯é åœ°ä¿®æ”¹ build.gradle
        cat > update_version.py << 'PYTHON_EOF'
        import re
        import sys
        
        gradle_file = 'android/app/build.gradle'
        version_code = sys.argv[1]
        version_name = sys.argv[2]
        
        with open(gradle_file, 'r') as f:
            content = f.read()
        
        # æ›¿æ¢æˆ–æ·»åŠ  versionCode
        if re.search(r'versionCode\s+\d+', content):
            content = re.sub(r'versionCode\s+\d+', f'versionCode {version_code}', content)
            print(f'âœ“ æ›¿æ¢ versionCode: {version_code}')
        else:
            content = re.sub(r'(defaultConfig\s*\{)', rf'\1\n        versionCode {version_code}', content)
            print(f'âœ“ æ’å…¥ versionCode: {version_code}')
        
        # æ›¿æ¢æˆ–æ·»åŠ  versionName
        if re.search(r'versionName\s+"[^"]*"', content):
            content = re.sub(r'versionName\s+"[^"]*"', f'versionName "{version_name}"', content)
            print(f'âœ“ æ›¿æ¢ versionName: {version_name}')
        else:
            content = re.sub(r'(defaultConfig\s*\{)', rf'\1\n        versionName "{version_name}"', content)
            print(f'âœ“ æ’å…¥ versionName: {version_name}')
        
        # ç¡®ä¿æœ‰ namespace
        if not re.search(r'namespace\s+["\']', content):
            content = re.sub(r'(android\s*\{)', r'\1\n    namespace "com.tehui.offline"', content)
            print('âœ“ æ’å…¥ namespace: com.tehui.offline')
        
        with open(gradle_file, 'w') as f:
            f.write(content)
        
        print(f'\nâœ“ ç‰ˆæœ¬é…ç½®å®Œæˆ: versionCode={version_code}, versionName={version_name}')
        PYTHON_EOF
        
        python3 update_version.py "$VERSION_CODE" "$VERSION"
        
        # éªŒè¯ç‰ˆæœ¬å·æ˜¯å¦æ­£ç¡®æ³¨å…¥
        echo ""
        echo "=== éªŒè¯ build.gradle ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯ ==="
        grep -A 10 "defaultConfig" android/app/build.gradle | grep -E "(versionCode|versionName)" || echo "è­¦å‘Š: æœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯"
        
        echo ""
      
    - name: åŒæ­¥ Capacitor
      run: |
        echo "=== åŒæ­¥ Capacitor ==="
        npx cap sync android
        echo "âœ“ åŒæ­¥å®Œæˆ"
        
        echo ""
        echo "=== éªŒè¯èµ„æºå¤§å° ==="
        du -sh android/app/src/main/assets/
        find android/app/src/main/assets/ -type f | wc -l
    
    - name: é‡æ–°åº”ç”¨è‡ªå®šä¹‰å›¾æ ‡ï¼ˆsync åï¼‰
      run: |
        echo "=== é‡æ–°åº”ç”¨è‡ªå®šä¹‰å›¾æ ‡ ==="
        echo "æ³¨æ„ï¼šcap sync å¯èƒ½ä¼šè¦†ç›–å›¾æ ‡ï¼Œéœ€è¦é‡æ–°å¤åˆ¶"
        
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„é»˜è®¤å›¾æ ‡
        rm -rf android/app/src/main/res/mipmap-*
        
        # å¤åˆ¶é¢„ç”Ÿæˆçš„å›¾æ ‡
        cp -r android_icons/* android/app/src/main/res/
        
        # éªŒè¯å›¾æ ‡å·²å¤åˆ¶
        echo ""
        echo "=== éªŒè¯å›¾æ ‡æ–‡ä»¶ ==="
        for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
          launcher="android/app/src/main/res/mipmap-$density/ic_launcher.png"
          round="android/app/src/main/res/mipmap-$density/ic_launcher_round.png"
          if [ -f "$launcher" ]; then
            echo "âœ“ mipmap-$density/ic_launcher.png ($(du -h "$launcher" | cut -f1))"
          else
            echo "âœ— mipmap-$density/ic_launcher.png ç¼ºå¤±"
          fi
          if [ -f "$round" ]; then
            echo "âœ“ mipmap-$density/ic_launcher_round.png ($(du -h "$round" | cut -f1))"
          else
            echo "âœ— mipmap-$density/ic_launcher_round.png ç¼ºå¤±"
          fi
        done
        
        # ç¡®ä¿ AndroidManifest.xml ä½¿ç”¨æ­£ç¡®çš„å›¾æ ‡
        echo ""
        echo "=== é…ç½® AndroidManifest.xml å›¾æ ‡å¼•ç”¨ ==="
        
        manifest_file="android/app/src/main/AndroidManifest.xml"
        
        # ç¡®ä¿ä½¿ç”¨ @mipmap/ic_launcher
        if grep -q 'android:icon=' "$manifest_file"; then
          sed -i 's/android:icon="[^"]*"/android:icon="@mipmap\/ic_launcher"/' "$manifest_file"
          echo "âœ“ è®¾ç½® android:icon=@mipmap/ic_launcher"
        else
          sed -i 's/<application/<application android:icon="@mipmap\/ic_launcher"/' "$manifest_file"
          echo "âœ“ æ·»åŠ  android:icon=@mipmap/ic_launcher"
        fi
        
        # ç¡®ä¿ä½¿ç”¨ @mipmap/ic_launcher_round
        if grep -q 'android:roundIcon=' "$manifest_file"; then
          sed -i 's/android:roundIcon="[^"]*"/android:roundIcon="@mipmap\/ic_launcher_round"/' "$manifest_file"
          echo "âœ“ è®¾ç½® android:roundIcon=@mipmap/ic_launcher_round"
        else
          sed -i 's/<application/<application android:roundIcon="@mipmap\/ic_launcher_round"/' "$manifest_file"
          echo "âœ“ æ·»åŠ  android:roundIcon=@mipmap/ic_launcher_round"
        fi
        
        echo ""
        echo "=== éªŒè¯ AndroidManifest.xml ==="
        grep -E 'android:(icon|roundIcon)=' "$manifest_file" || echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›¾æ ‡é…ç½®"
        
        echo ""
        echo "âœ“ è‡ªå®šä¹‰å›¾æ ‡å·²é‡æ–°åº”ç”¨å¹¶é…ç½®å®Œæˆ"
      
    - name: é…ç½®ç½‘ç»œå®‰å…¨ç­–ç•¥
      run: |
        echo "=== é…ç½®ç½‘ç»œå®‰å…¨ç­–ç•¥ ==="
        mkdir -p android/app/src/main/res/xml
        cat > android/app/src/main/res/xml/network_security_config.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <base-config cleartextTrafficPermitted="true">
                <trust-anchors>
                    <certificates src="system" />
                </trust-anchors>
            </base-config>
        </network-security-config>
        EOF
        
        if ! grep -q "networkSecurityConfig" android/app/src/main/AndroidManifest.xml; then
          sed -i 's/<application/<application android:networkSecurityConfig="@xml\/network_security_config"/' android/app/src/main/AndroidManifest.xml
        fi
        
        echo "âœ“ ç½‘ç»œå®‰å…¨é…ç½®å®Œæˆ"
        
        echo ""
        echo "=== é…ç½® APK å®‰è£…æƒé™ ==="
        
        manifest_file="android/app/src/main/AndroidManifest.xml"
        
        # æ·»åŠ  APK å®‰è£…æƒé™ï¼ˆAndroid 8.0+ï¼‰
        if ! grep -q "REQUEST_INSTALL_PACKAGES" "$manifest_file"; then
          # åœ¨ <manifest> æ ‡ç­¾åæ·»åŠ æƒé™
          sed -i '/<manifest/a\    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES" />' "$manifest_file"
          echo "âœ“ æ·»åŠ  REQUEST_INSTALL_PACKAGES æƒé™"
        fi
        
        # æ·»åŠ å­˜å‚¨æƒé™ï¼ˆAndroid 10 ä»¥ä¸‹ï¼‰
        if ! grep -q "WRITE_EXTERNAL_STORAGE" "$manifest_file"; then
          sed -i '/<manifest/a\    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="32" />' "$manifest_file"
          echo "âœ“ æ·»åŠ  WRITE_EXTERNAL_STORAGE æƒé™"
        fi
        
        if ! grep -q "READ_EXTERNAL_STORAGE" "$manifest_file"; then
          sed -i '/<manifest/a\    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />' "$manifest_file"
          echo "âœ“ æ·»åŠ  READ_EXTERNAL_STORAGE æƒé™"
        fi
        
        # æ·»åŠ  FileProvider é…ç½®
        if ! grep -q "FileProvider" "$manifest_file"; then
          # åˆ›å»º file_paths.xml
          mkdir -p android/app/src/main/res/xml
          cat > android/app/src/main/res/xml/file_paths.xml << 'FILEPATHS_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <paths xmlns:android="http://schemas.android.com/apk/res/android">
            <cache-path name="cache" path="." />
            <external-path name="external" path="." />
            <external-cache-path name="external_cache" path="." />
            <external-path name="downloads" path="Download/" />
        </paths>
        FILEPATHS_EOF
          
          # åœ¨ </application> å‰æ·»åŠ  FileProvider
          sed -i 's|</application>|        <provider\n            android:name="androidx.core.content.FileProvider"\n            android:authorities="${applicationId}.fileprovider"\n            android:exported="false"\n            android:grantUriPermissions="true">\n            <meta-data\n                android:name="android.support.FILE_PROVIDER_PATHS"\n                android:resource="@xml/file_paths" />\n        </provider>\n    </application>|' "$manifest_file"
          echo "âœ“ æ·»åŠ  FileProvider é…ç½®"
        fi
        
        # æ·»åŠ  queries é…ç½®ï¼ˆAndroid 11+ï¼‰
        if ! grep -q "<queries>" "$manifest_file"; then
          sed -i '/<manifest/a\    <queries>\n        <intent>\n            <action android:name="android.intent.action.VIEW" />\n            <data android:mimeType="application/vnd.android.package-archive" />\n        </intent>\n    </queries>' "$manifest_file"
          echo "âœ“ æ·»åŠ  queries é…ç½®ï¼ˆAndroid 11+ï¼‰"
        fi
        
        echo ""
        echo "=== éªŒè¯ AndroidManifest.xml ==="
        echo "æ£€æŸ¥æƒé™é…ç½®..."
        grep -E "REQUEST_INSTALL_PACKAGES|WRITE_EXTERNAL_STORAGE|FileProvider|queries" "$manifest_file" || echo "è­¦å‘Šï¼šéƒ¨åˆ†é…ç½®å¯èƒ½æœªæ·»åŠ "
        
        echo ""
        echo "=== éªŒè¯åº”ç”¨é…ç½® ==="
        # ç¡®ä¿åº”ç”¨åç§°æ­£ç¡®
        if grep -q "android:label=" "$manifest_file"; then
          sed -i 's/android:label="[^"]*"/android:label="ç‰¹ä¼š"/' "$manifest_file"
          echo "âœ“ åº”ç”¨åç§°å·²è®¾ç½®ä¸º ç‰¹ä¼š"
        fi
        
        # æ˜¾ç¤º AndroidManifest.xml çš„å…³é”®éƒ¨åˆ†
        echo ""
        echo "AndroidManifest.xml å…³é”®é…ç½®:"
        grep -A 3 "<application" "$manifest_file" | head -5
        
        echo ""
        echo "âœ“ AndroidManifest é…ç½®å®Œæˆ"
      
    - name: åˆ›å»ºç­¾åå¯†é’¥
      run: |
        echo "=== åˆ›å»ºç­¾åå¯†é’¥ ==="
        cat > offline-key.keystore.b64 << 'EOF'
        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
        7TAl8q3jYZG3mGs=
        EOF
        
        base64 -d offline-key.keystore.b64 > offline-key.keystore
        cp offline-key.keystore android/
        echo "âœ“ ç­¾åå¯†é’¥å·²åˆ›å»º"
      
    - name: é…ç½®ç­¾å
      run: |
        echo "=== é…ç½® APK ç­¾å ==="
        
        cat > insert_signing.py << 'PYTHON_EOF'
        import re
        import sys
        
        gradle_file = sys.argv[1]
        keystore_file = sys.argv[2]
        
        with open(gradle_file, 'r') as f:
            content = f.read()
        
        signing_config = f'''
            signingConfigs {{
                release {{
                    storeFile file("../{keystore_file}")
                    storePassword "tehui2024"
                    keyAlias "tehui"
                    keyPassword "tehui2024"
                }}
            }}
        '''
        content = re.sub(r'(android\s*\{)', r'\1' + signing_config, content, count=1)
        content = re.sub(r'(buildTypes\s*\{[^}]*release\s*\{)', r'\1\n            signingConfig signingConfigs.release', content, count=1)
        
        with open(gradle_file, 'w') as f:
            f.write(content)
        
        print(f"âœ“ {gradle_file} ç­¾åé…ç½®å·²æ’å…¥")
        PYTHON_EOF
        
        python3 insert_signing.py android/app/build.gradle offline-key.keystore
        echo "âœ“ ç­¾åé…ç½®å®Œæˆ"
      
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x android/gradlew
        
    - name: æ„å»º APK
      run: |
        echo "=== æ„å»º APK ==="
        cd android
        
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << 'EOF'
        org.gradle.daemon=false
        org.gradle.parallel=true
        org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m
        systemProp.http.connectionTimeout=60000
        systemProp.http.socketTimeout=60000
        EOF
        
        if ./gradlew clean assembleRelease --stacktrace --no-daemon; then
          echo "âœ“ APK æ„å»ºæˆåŠŸ"
          cd ..
        else
          echo "âœ— APK æ„å»ºå¤±è´¥"
          cd ..
          exit 1
        fi
        
    - name: éªŒè¯å’Œé‡å‘½å APK
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d-%H%M%S)
        fi
        
        echo "=== å¤„ç† APK ==="
        cd android/app/build/outputs/apk/release/
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            APK_NAME="TeHui-v${VERSION}.apk"
            cp "$apk" "../../../../../../$APK_NAME"
            echo "âœ“ APK: $APK_NAME"
            echo "  å¤§å°: $(du -h "$apk" | cut -f1)"
            echo "  MD5: $(md5sum "$apk" | cut -d' ' -f1)"
            break
          fi
        done
        cd ../../../../../../
        
        echo ""
        echo "=== æœ€ç»ˆç”Ÿæˆçš„ APK ==="
        ls -lh TeHui-*.apk
        
    - name: ä¸Šä¼  APK åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: TeHui-*.apk
        
    - name: åˆ›å»º Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TeHui-*.apk
        body: |
          ## ğŸ“± ç‰¹ä¼šä¿¡æ¯ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **ç¦»çº¿ç‰ˆ APK** - çº¦ 50-100 MB
          - æ–‡ä»¶åï¼š`TeHui-${{ github.ref_name }}.apk`
          - ç‰¹ç‚¹ï¼šåŒ…å«æ‰€æœ‰å†…å®¹ï¼Œå®Œå…¨ç¦»çº¿ä½¿ç”¨
          - ä¼˜åŠ¿ï¼š
            - æ— éœ€ç½‘ç»œå³å¯ä½¿ç”¨
            - æ‰€æœ‰å†…å®¹é¢„è£…ï¼Œæ‰“å¼€å³ç”¨
            - é€‚åˆç½‘ç»œä¸ç¨³å®šæˆ–æ— ç½‘ç»œç¯å¢ƒ
          - æ³¨æ„ï¼šå†…å®¹æ›´æ–°éœ€è¦é‡æ–°ä¸‹è½½å®‰è£…æ–°ç‰ˆæœ¬ APK
          
          ### ğŸ’¡ åœ¨çº¿ç‰ˆæ›¿ä»£æ–¹æ¡ˆ
          
          å¦‚æœæ‚¨æƒ³è¦è½»é‡çº§çš„åœ¨çº¿ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨ **PWAï¼ˆæ¸è¿›å¼ Web åº”ç”¨ï¼‰**ï¼š
          
          1. ä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼šhttps://cx.zhaozg.cloudns.org/
          2. ç‚¹å‡»æµè§ˆå™¨èœå•ä¸­çš„"æ·»åŠ åˆ°ä¸»å±å¹•"æˆ–"å®‰è£…"
          3. PWA ä¼šåƒ APP ä¸€æ ·æ˜¾ç¤ºåœ¨ä¸»å±å¹•ä¸Š
          4. ä¼˜åŠ¿ï¼š
             - è½»é‡çº§ï¼ˆå‡  MBï¼‰
             - å†…å®¹è‡ªåŠ¨æ›´æ–°
             - æ”¯æŒç¦»çº¿æµè§ˆï¼ˆService Worker ç¼“å­˜ï¼‰
             - æ— éœ€ä¸‹è½½ APK
          
          ### âš ï¸ å®‰è£…æç¤º
          
          å¦‚æœå®‰è£…æ—¶æç¤º"è§£æåŒ…å‡ºç°é—®é¢˜"ï¼š
          1. ç¡®è®¤ä¸‹è½½å®Œæ•´ï¼ˆæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼‰
          2. æ¸…é™¤æ—§ç‰ˆæœ¬åé‡æ–°å®‰è£…
          3. ç¡®ä¿å®‰å“ç‰ˆæœ¬ â‰¥ 5.1ï¼ˆAPI 22ï¼‰
          4. å°è¯•åœ¨è®¾ç½®ä¸­æ¸…é™¤ä¸‹è½½ç®¡ç†å™¨çš„ç¼“å­˜
          5. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†"æœªçŸ¥æ¥æº"å®‰è£…æƒé™
          
          ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬å·: ${{ github.ref_name }}
          - åŒ…å: com.tehui.offline
          - ç­¾åçŠ¶æ€: âœ… å·²ç­¾åï¼ˆå¯è¦†ç›–å®‰è£…ï¼‰
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - è¦æ±‚ï¼šå®‰å“ 5.1 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆAPI 22+ï¼‰
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
