name: éƒ¨ç½²ç½‘ç«™å†…å®¹

on:
  push:
    branches:
      - main
    paths:
      - 'resource/**'
      - 'src/generator.py'
      - 'src/models.py'
      - 'src/parser.py'
      - 'src/parser_improved.py'
      - 'src/templates/base.html'
      - 'src/templates/main_*.html'
      - 'src/templates/morning_revival.html'
      - 'src/templates/outline.html'
      - 'src/templates/scripture.html'
      - 'src/static/icons/**'
      - 'main.py'
      - 'config.yaml'
    paths-ignore:
      - '.github/workflows/**'
      - 'src/templates/app_*.html'
      - 'capacitor.config.json'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: å®‰è£… LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: ç”Ÿæˆé™æ€ç½‘ç«™
      run: python main.py
      
    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      run: python generate_version.py
      
    - name: æ£€æŸ¥å¹¶åˆ›å»º Cloudflare Pages é¡¹ç›®
      if: secrets.CLOUDFLARE_API_TOKEN != '' && secrets.CLOUDFLARE_ACCOUNT_ID != ''
      run: |
        echo "ğŸ” æ£€æŸ¥ Cloudflare Pages é¡¹ç›®..."
        
        # æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
        response=$(curl -s -X GET \
          "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/cx" \
          -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
          -H "Content-Type: application/json")
        
        success=$(echo "$response" | jq -r '.success')
        
        if [ "$success" = "true" ]; then
          echo "âœ“ é¡¹ç›® cx å·²å­˜åœ¨"
        else
          echo "ğŸ“¦ é¡¹ç›®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
          
          create_response=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "cx",
              "production_branch": "main"
            }')
          
          create_success=$(echo "$create_response" | jq -r '.success')
          
          if [ "$create_success" = "true" ]; then
            echo "âœ“ é¡¹ç›® cx åˆ›å»ºæˆåŠŸ"
          else
            echo "âš ï¸ é¡¹ç›®åˆ›å»ºå¤±è´¥ï¼Œå°†è·³è¿‡ Cloudflare éƒ¨ç½²"
            echo "$create_response" | jq '.'
          fi
        fi
      
    - name: éƒ¨ç½²åˆ° Cloudflare Pages
      if: secrets.CLOUDFLARE_API_TOKEN != '' && secrets.CLOUDFLARE_ACCOUNT_ID != ''
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: cx
        directory: output
      
    - name: éƒ¨ç½²åˆ° GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./output
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'éƒ¨ç½²é™æ€ç½‘ç«™'
