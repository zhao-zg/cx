name: Auto Download Resources

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9 ç‚¹è¿è¡Œ (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸æ¨é€ä»£ç 

jobs:
  download-resources:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: Download resources
        run: |
          python down_resource.py
        continue-on-error: false

      - name: Check for changes
        id: check_changes
        run: |
          git add resource/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰æ–°èµ„æºéœ€è¦ä¸‹è½½"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°èµ„æº"
            git diff --staged --stat
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "ğŸ¤– è‡ªåŠ¨ä¸‹è½½: æ–°å¢è®­ç»ƒèµ„æº $(date +'%Y-%m-%d %H:%M')"
          git push

      - name: Install LibreOffice
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“¦ å®‰è£… LibreOffice..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq libreoffice-writer libreoffice-core --no-install-recommends
          echo "âœ“ LibreOffice å·²å®‰è£…"

      - name: Generate HTML and version info
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ”¨ ç”Ÿæˆé™æ€æ–‡ä»¶..."
          python main.py
          
          echo "ğŸ“‹ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ï¼ˆçƒ­æ›´æ–°ï¼‰..."
          python generate_version.py
          
          echo "ğŸ“¦ ç”Ÿæˆçƒ­æ›´æ–°åŒ…..."
          python generate_hot_update_package.py
          
          echo "âœ“ é™æ€æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          du -sh output/
          
          echo "ğŸ“„ æ£€æŸ¥ version.json..."
          if [ -f output/version.json ]; then
            echo "âœ“ version.json å·²ç”Ÿæˆ"
            cat output/version.json | head -20
          else
            echo "âš ï¸ version.json æœªç”Ÿæˆ"
          fi
          
          echo "ğŸ“¦ æ£€æŸ¥çƒ­æ›´æ–°åŒ…..."
          ls -lh output/*.zip || echo "âš ï¸ çƒ­æ›´æ–°åŒ…æœªç”Ÿæˆ"

      - name: Setup Node.js
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Deploy to Cloudflare Pages
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pagesï¼ˆçƒ­æ›´æ–°ï¼‰..."
          
          # å®‰è£… wrangler
          npm install -g wrangler
          
          # è·å– commit ä¿¡æ¯
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG="Hot update: New resources $COMMIT_HASH"
          
          # éƒ¨ç½²
          wrangler pages deploy output \
            --project-name=cx \
            --branch=main \
            --commit-hash="$COMMIT_HASH" \
            --commit-message="$COMMIT_MSG"
          
          echo "âœ“ Cloudflare Pages éƒ¨ç½²å®Œæˆï¼ˆçƒ­æ›´æ–°ï¼‰"

      - name: Deploy to GitHub Pages
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'çƒ­æ›´æ–°: æ–°å¢è®­ç»ƒèµ„æº'
          cname: cx.xzdjx.dynv6.net

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… æˆåŠŸä¸‹è½½æ–°èµ„æºå¹¶éƒ¨ç½²ï¼ˆçƒ­æ›´æ–°ï¼‰"
            echo "ğŸ“¦ ç”¨æˆ·å¯ä»¥é€šè¿‡çƒ­æ›´æ–°è·å–æ–°å†…å®¹"
            echo "ğŸ”„ æ— éœ€é‡æ–°å®‰è£…APK"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°èµ„æºéœ€è¦æ›´æ–°"
          fi
