# 批量生成多样式支持说明

## 更新日期
2025-01-XX

## 问题描述
1. **图片资源路径问题**：之前所有批次的图片都保存到共享的 `output/images/` 目录，导致批次之间的图片引用混乱。
2. **夏季文档解析失败**：2025-夏季批次使用 .doc 格式的听抄文档，其 Word 样式系统与秋季的 .docx 文档完全不同，导致无法识别大点、中点等结构，所有详情内容为空。

## 解决方案

### 1. 图片资源批次隔离
- 修改 `ImprovedParser.__init__()` 接收 `output_dir` 参数
- 修改 `_extract_hymn_images()` 使用批次特定的输出目录：`{batch_output_dir}/images/`
- 在 `main.py` 的 `process_batch()` 中传递批次特定的输出目录给解析器

**结果**：
- 2025-夏季的图片保存到：`output/2025-夏季/images/`
- 2025-秋季的图片保存到：`output/2025-秋季/images/`
- HTML 文件使用相对路径 `images/hymn_X.png` 正确引用图片

### 2. 支持多种 Word 样式系统
扩展 `STYLE_MAP` 字典，同时支持秋季和夏季的样式：

#### 秋季 .docx 样式系统
```python
'121文章篇题': 'chapter_title',      # 篇章标题
'131文章大点': 'section_level1',     # 大点（壹、贰、叁...）
'132文章中点': 'section_level2',     # 中点（一、二、三...）
'133文章小点': 'section_level3',     # 小点（1、2、3...）
'134文章小a点': 'section_level4',    # 小a点
'8888文章正文': 'content',           # 正文内容
```

#### 夏季 .doc 样式系统
```python
'０ａ總題': 'chapter_title',         # 篇章标题
'職事信息大標': 'section_level1',    # 大点
'職事信息中標': 'section_level2',    # 中点
'职事小标题': 'section_level3',      # 小点
'信息正文18': 'content',             # 正文内容
'信息正文3': 'content',
'信息正文17': 'content',
'職事信息': 'content',
```

### 3. 保留文本特征回退机制
`parse_listen_doc()` 函数的样式检测逻辑：
1. 首先尝试通过 `STYLE_MAP` 映射样式名称
2. 如果样式映射失败，使用正则表达式匹配文本特征：
   - `^第[一二三四五六七八九十]+篇` → 篇章标题
   - `^[壹贰叁肆伍陆柒捌玖拾]+[、\s]` → 大点
   - `^[一二三四五六七八九十]+[、\s]` → 中点
   - `^\d+[、\s]` → 小点
   - 其他 → 正文内容

这种双重检测机制确保了对不同格式文档的兼容性。

## 测试结果

### 2025-秋季（.docx 格式）
✅ 成功解析 9 个篇章
- 第1篇: 纲目5个大点, 详情5个大点
- 第2篇: 纲目3个大点, 详情3个大点
- 第3篇: 纲目4个大点, 详情4个大点
- ...（所有篇章内容完整）

### 2025-夏季（.doc 格式）
✅ 成功解析 9 个篇章
- 第1篇: 纲目5个大点, 详情28个大点
- 第2篇: 纲目4个大点, 详情4个大点
- 第3篇: 纲目3个大点, 详情3个大点
- ...（所有篇章内容完整）

## 代码变更

### `src/parser_improved.py`
1. `__init__(self, output_dir='output')` - 添加输出目录参数
2. `STYLE_MAP` - 扩展样式映射表支持两种样式系统
3. `_extract_hymn_images()` - 使用 `self.output_dir` 代替硬编码路径
4. `parse_training_docs_improved()` - 添加 `output_dir` 参数

### `main.py`
1. `process_batch()` - 提前计算 `output_dir` 并传递给解析器

## 使用说明

批量生成时，系统会自动：
1. 扫描 `resource/` 目录下的所有子文件夹
2. 为每个批次创建独立的输出目录：`output/{批次名称}/`
3. 自动识别文档格式（.doc 或 .docx）
4. 根据文档样式系统自动选择正确的解析策略
5. 将图片资源保存到批次特定的 `images/` 子目录
6. 生成的 HTML 使用相对路径正确引用资源

无需手动配置或修改代码，系统会自动适配不同的文档格式和样式系统。

## 兼容性

- ✅ 支持 .doc 和 .docx 格式
- ✅ 支持不同的 Word 样式系统
- ✅ 支持多批次并行处理
- ✅ 资源文件批次隔离
- ✅ 移动端响应式设计
- ✅ 自动格式检测和转换
